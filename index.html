<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero RPG v30: AI Complete</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0f0f1a;
            --glass: rgba(255, 255, 255, 0.07);
            --accent: #4deeea;
            --hp: #ff4d4d;
            --gold: #ffb347;
            --ai-purp: #bc13fe;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background: var(--bg); color: #fff;
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0; padding: 15px; padding-bottom: 110px; min-height: 100vh;
        }

        .glass {
            background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px;
            padding: 20px; margin-bottom: 15px;
        }

        /* –ì–µ—Ä–æ–π */
        .hero-aura {
            width: 130px; height: 130px; margin: 0 auto 15px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            position: relative; transition: 0.5s; background: rgba(255,255,255,0.02);
        }
        .avatar { font-size: 55px; z-index: 5; }
        .slot { position: absolute; font-size: 35px; }
        #sl-h { top: -15px; } #sl-w { right: -10px; bottom: 10px; }

        /* –ü–æ–ª–æ—Å–∫–∏ */
        .bar-bg { height: 8px; background: rgba(0,0,0,0.3); border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 10px; transition: 0.8s; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 15px; scrollbar-width: none; }
        .nav-btn {
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
            color: #fff; padding: 10px 18px; border-radius: 15px; white-space: nowrap; font-size: 13px;
        }
        .nav-btn.active { background: #fff; color: #000; font-weight: bold; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-prime {
            width: 100%; padding: 16px; border-radius: 18px; border: none;
            background: #fff; color: #000; font-weight: bold; font-size: 15px;
        }
        .btn-ai { background: linear-gradient(135deg, var(--ai-purp), var(--accent)); color: #fff; }

        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: #fff; }
        .hidden { display: none !important; }
        .ver { text-align: center; font-size: 9px; opacity: 0.3; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="loader" style="position:fixed; inset:0; background:#0f0f1a; z-index:1000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div style="color:var(--accent); margin-bottom:10px; font-weight:bold; letter-spacing:2px;">V30_SYNC_COMPLETE</div>
        <div style="width:150px; height:2px; background:rgba(255,255,255,0.1);"><div id="l-bar" style="width:0%; height:100%; background:#fff; transition:0.3s;"></div></div>
    </div>

    <div class="glass" style="text-align: center;">
        <div style="display:flex; justify-content:space-between; font-size:10px; opacity:0.6; margin-bottom:15px;">
            <span id="rank-name">–ê–ù–ê–õ–ò–ó...</span>
            <span>LVL: <span id="total-lvl">1</span></span>
        </div>
        <div class="hero-aura" id="aura">
            <span id="sl-h" class="slot"></span>
            <div class="avatar">üë∂</div>
            <span id="sl-w" class="slot"></span>
        </div>
        <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:14px;">
            <span style="color:var(--hp);">‚ù§Ô∏è <span id="hp-val">100</span></span>
            <span style="color:var(--gold);">üí∞ <span id="gold-val">0</span></span>
        </div>
        <div class="bar-bg"><div id="hp-fill" class="bar-fill" style="background:var(--hp); width:100%;"></div></div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="tab(event, 'tasks')">–ö–í–ï–°–¢–´</button>
        <button class="nav-btn" onclick="tab(event, 'ai')">üîÆ –û–†–ê–ö–£–õ</button>
        <button class="nav-btn" onclick="tab(event, 'hero')">–ì–ï–†–û–ô</button>
        <button class="nav-btn" onclick="tab(event, 'shop')">–ú–ê–ì–ê–ó–ò–ù</button>
    </div>

    <div id="v-tasks">
        <div id="task-list"></div>
        <button class="btn-prime" onclick="openM()">+ –ù–û–í–´–ô –ö–í–ï–°–¢</button>
    </div>

    <div id="v-ai" class="hidden">
        <div class="glass" style="border-left: 4px solid var(--ai-purp);">
            <h3>–°–æ–≤–µ—Ç –û—Ä–∞–∫—É–ª–∞</h3>
            <div id="ai-text" style="font-size:14px; line-height:1.6; min-height:60px;">–ù–∞–∂–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ò–ò –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª —Ç–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å...</div>
            <button class="btn-prime btn-ai" id="ai-btn" onclick="askOracle()" style="margin-top:15px;">–ê–ù–ê–õ–ò–ó –°–£–î–¨–ë–´</button>
        </div>
    </div>

    <div id="v-hero" class="hidden">
        <div id="skills-list"></div>
        <div class="glass" id="piggy-ui"></div>
    </div>

    <div id="v-shop" class="hidden">
        <div class="glass">
            <h4 style="margin:0 0 10px 0;">–°–ù–ê–†–Ø–ñ–ï–ù–ò–ï</h4>
            <div id="shop-gear"></div>
            <h4 style="margin:20px 0 10px 0;">–ü–ï–†–ö–ò</h4>
            <div id="shop-perks"></div>
        </div>
    </div>

    <div id="modal" class="hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:999; display:flex; align-items:center; padding:20px;">
        <div class="glass" style="width:100%;">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ö–≤–µ—Å—Ç–∞</h3>
            <input type="text" id="m-t" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏">
            <div style="display:flex; gap:10px;">
                <input type="time" id="m-s">
                <input type="time" id="m-e">
            </div>
            <select id="m-d">
                <option value="0">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option><option value="1">–í—Ç–æ—Ä–Ω–∏–∫</option>
                <option value="2">–°—Ä–µ–¥–∞</option><option value="3">–ß–µ—Ç–≤–µ—Ä–≥</option>
                <option value="4">–ü—è—Ç–Ω–∏—Ü–∞</option><option value="5">–°—É–±–±–æ—Ç–∞</option><option value="6">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
            </select>
            <select id="m-c" onchange="document.getElementById('m-new').classList.toggle('hidden', this.value!=='new')">
                <option value="money">üí∞ –§–∏–Ω–∞–Ω—Å—ã</option>
                <option value="education">üìö –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç</option>
                <option value="health">üí™ –ó–¥–æ—Ä–æ–≤—å–µ</option>
                <option value="new">+ –°–≤–æ—è —Å—Ñ–µ—Ä–∞...</option>
            </select>
            <input type="text" id="m-new" class="hidden" placeholder="–ò–º—è —Å—Ñ–µ—Ä—ã">
            <button class="btn-prime" onclick="addQ()">–î–û–ë–ê–í–ò–¢–¨</button>
            <button onclick="openM()" style="background:none; border:none; color:#777; width:100%; margin-top:10px;">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <div class="ver">BUILD: V30_STABLE_AI_KEY_ENABLED</div>

<script>
    const tg = window.Telegram.WebApp;
    const API_KEY = "AIzaSyBuhO4FzG96_z2t97pp0ySDXdj5KroVKfY";

    let state = {
        gold: 0, hp: 100, lastDate: new Date().toDateString(),
        skills: { money: {lvl:1, xp:0}, education: {lvl:1, xp:0}, health: {lvl:1, xp:0} },
        quests: [], inventory: [], perks: [],
        equipped: { head: null, weapon: null },
        piggy: { active: false, title: '', goal: 0, curr: 0 }
    };

    const DB = {
        gear: {
            'h1': { n: '–®–ª–µ–º', i: 'ü™ñ', p: 500, s: 'head' },
            'h2': { n: '–ö–æ—Ä–æ–Ω–∞', i: 'üëë', p: 3000, s: 'head' },
            'w1': { n: '–ú–µ—á', i: 'üó°Ô∏è', p: 800, s: 'weapon' },
            'w2': { n: '–ü–æ—Å–æ—Ö', i: 'ü™Ñ', p: 1500, s: 'weapon' }
        },
        perks: {
            'boost': { n: '–ú–∞–π–Ω–µ—Ä', d: '+20% –∑–æ–ª–æ—Ç–∞', p: 1200 },
            'def': { n: '–§–∞–π–µ—Ä–≤–æ–ª', d: '-50% —É—Ä–æ–Ω–∞', p: 2000 }
        }
    };

    function init() {
        tg.ready(); tg.expand();
        let p = 0;
        const interval = setInterval(() => { p+=5; if(p<=95) document.getElementById('l-bar').style.width=p+'%'; }, 100);
        
        tg.CloudStorage.getItem('rpg_v30_save', (err, val) => {
            clearInterval(interval);
            if(!err && val) { try { state = JSON.parse(val); } catch(e){} }
            else { 
                const local = localStorage.getItem('rpg_v30_save');
                if(local) try { state = JSON.parse(local); } catch(e){}
            }
            document.getElementById('l-bar').style.width='100%';
            checkPenalty(); render();
            setTimeout(() => document.getElementById('loader').style.display='none', 500);
        });
    }

    function save() {
        const s = JSON.stringify(state);
        localStorage.setItem('rpg_v30_save', s);
        tg.CloudStorage.setItem('rpg_v30_save', s);
        render();
    }

    function checkPenalty() {
        const now = new Date().toDateString();
        if(state.lastDate !== now) {
            const yesterday = (new Date().getDay() + 5) % 7;
            const missed = state.quests.filter(q => parseInt(q.day) === yesterday && !q.done);
            if(missed.length > 0) {
                let dmg = missed.length * 15;
                if(state.perks.includes('def')) dmg = Math.floor(dmg/2);
                state.hp = Math.max(0, state.hp - dmg);
            }
            state.quests.forEach(q => q.done = false);
            state.lastDate = now;
            save();
        }
    }

    async function askOracle() {
        const btn = document.getElementById('ai-btn');
        const txt = document.getElementById('ai-text');
        btn.disabled = true; txt.innerText = "–û—Ä–∞–∫—É–ª –º–µ–¥–∏—Ç–∏—Ä—É–µ—Ç...";

        const prompt = `–¢—ã - –º—É–¥—Ä—ã–π RPG –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä–æ–∫–∞: HP ${state.hp}%, –ó–æ–ª–æ—Ç–æ ${state.gold}, –£—Ä–æ–≤–Ω–∏: ${Object.keys(state.skills).map(k=>k+':'+state.skills[k].lvl).join(',')}. 
        –ó–∞–¥–∞—á –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: ${state.quests.filter(q => !q.done).length}. 
        –î–∞–π –û–ß–ï–ù–¨ –ö–†–ê–¢–ö–ò–ô —Å–æ–≤–µ—Ç (2 —Ñ—Ä–∞–∑—ã) –≤ —Å—Ç–∏–ª–µ —Ñ—ç–Ω—Ç–µ–∑–∏.`;

        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const d = await r.json();
            txt.innerText = d.candidates[0].content.parts[0].text;
        } catch(e) { txt.innerText = "–°–≤—è–∑—å —Å –∞—Å—Ç—Ä–∞–ª–æ–º –ø–æ—Ç–µ—Ä—è–Ω–∞..."; }
        btn.disabled = false;
    }

    function render() {
        document.getElementById('gold-val').innerText = state.gold;
        document.getElementById('hp-val').innerText = state.hp;
        document.getElementById('hp-fill').style.width = state.hp + '%';

        let total = 0; for(let s in state.skills) total += state.skills[s].lvl;
        document.getElementById('total-lvl').innerText = total;
        document.getElementById('rank-name').innerText = total > 20 ? "–õ–ï–ì–ï–ù–î–ê" : (total > 10 ? "–ì–ï–†–û–ô" : "–ù–û–í–ò–ß–û–ö");

        document.getElementById('sl-h').innerText = state.equipped.head ? DB.gear[state.equipped.head].i : '';
        document.getElementById('sl-w').innerText = state.equipped.weapon ? DB.gear[state.equipped.weapon].i : '';

        const today = (new Date().getDay() + 6) % 7;
        const qToday = state.quests.filter(q => parseInt(q.day) === today);
        document.getElementById('task-list').innerHTML = qToday.map(q => {
            const idx = state.quests.indexOf(q);
            const time = q.start ? `<br><small>‚è∞ ${q.start} - ${q.end}</small>` : '';
            return `
            <div class="glass" style="display:flex; justify-content:space-between; align-items:center; ${q.done?'opacity:0.3':''}">
                <div><div style="font-size:10px; color:var(--accent)">${q.cat.toUpperCase()}</div><b>${q.title}</b>${time}</div>
                ${q.done ? `<button onclick="delQ(${idx})" style="background:none; border:none; color:var(--hp); font-weight:bold;">X</button>` : 
                `<button onclick="doneQ(${idx})" style="background:#fff; color:#000; border:none; padding:8px 12px; border-radius:10px; font-weight:bold;">OK</button>`}
            </div>`;
        }).join('') || '<div style="text-align:center; opacity:0.3; padding:20px;">–ó–∞–¥–∞—á –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –Ω–µ—Ç</div>';

        renderShop(); renderPiggy(); renderStats();
    }

    function renderShop() {
        let h = "";
        for(let k in DB.gear) {
            const it = DB.gear[k]; const has = state.inventory.includes(k); const eq = state.equipped[it.s] === k;
            h += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>${it.i} ${it.n}</span>
                <button onclick="gearAct('${k}')" style="background:${has?(eq?'var(--hp)':'var(--accent)'):'#444'}; border:none; color:#000; padding:5px 10px; border-radius:8px; font-size:11px; font-weight:bold;">
                ${has?(eq?'–°–ù–Ø–¢–¨':'–ù–ê–î–ï–¢–¨'):it.p}</button></div>`;
        }
        document.getElementById('shop-gear').innerHTML = h;

        let ph = "";
        for(let k in DB.perks) {
            const p = DB.perks[k]; const has = state.perks.includes(k);
            ph += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>${p.n}</span>
                <button onclick="buyP('${k}')" ${has?'disabled':''} style="background:${has?'#222':'var(--accent)'}; border:none; padding:5px 10px; border-radius:8px; font-size:11px; font-weight:bold;">
                ${has?'–ö–£–ü–õ–ï–ù–û':p.p}</button></div>`;
        }
        document.getElementById('shop-perks').innerHTML = ph;
    }

    function renderPiggy() {
        const p = state.piggy; const ui = document.getElementById('piggy-ui');
        if(!p.active) ui.innerHTML = `<h3>–ö–æ–ø–∏–ª–∫–∞</h3><button class="btn-prime" onclick="startP()">–ù–û–í–ê–Ø –¶–ï–õ–¨</button>`;
        else {
            const pct = Math.min(100, (p.curr/p.goal)*100);
            ui.innerHTML = `<h3>${p.title}</h3><small>${p.curr}/${p.goal}</small>
            <div class="bar-bg"><div class="bar-fill" style="background:var(--gold); width:${pct}%;"></div></div>
            <button class="btn-prime" onclick="depP()">–ü–û–ü–û–õ–ù–ò–¢–¨</button>`;
        }
    }

    function renderStats() {
        document.getElementById('skills-list').innerHTML = Object.keys(state.skills).map(k => `
            <div class="glass" style="padding:15px;">
                <div style="display:flex; justify-content:space-between; font-size:11px;"><span>${k.toUpperCase()}</span><span>LVL ${state.skills[k].lvl}</span></div>
                <div class="bar-bg"><div class="bar-fill" style="background:var(--accent); width:${state.skills[k].xp}%;"></div></div>
            </div>`).join('');
    }

    window.tab = (e, n) => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('[id^="v-"]').forEach(v => v.classList.add('hidden'));
        document.getElementById('v-'+n).classList.remove('hidden');
    };

    window.openM = () => document.getElementById('modal').classList.toggle('hidden');
    window.addQ = () => {
        const t = document.getElementById('m-t').value; if(!t) return;
        let c = document.getElementById('m-c').value;
        if(c === 'new') {
            c = document.getElementById('m-new').value || '—Ä–∞–∑–Ω–æ–µ';
            if(!state.skills[c]) state.skills[c] = {lvl:1, xp:0};
        }
        state.quests.push({ title: t, cat: c, day: document.getElementById('m-d').value, start: document.getElementById('m-s').value, end: document.getElementById('m-e').value, done: false });
        openM(); save();
    };

    window.doneQ = (i) => {
        tg.HapticFeedback.notificationOccurred('success');
        const q = state.quests[i]; q.done = true;
        state.gold += state.perks.includes('boost') ? 60 : 50;
        state.skills[q.cat].xp += 25;
        if(state.skills[q.cat].xp >= 100) { state.skills[q.cat].xp=0; state.skills[q.cat].lvl++; }
        save();
    };

    window.delQ = (idx) => { state.quests.splice(idx,1); save(); };
    window.gearAct = (k) => {
        const it = DB.gear[k];
        if(state.inventory.includes(k)) state.equipped[it.s] = state.equipped[it.s] === k ? null : k;
        else if(state.gold >= it.p) { state.gold -= it.p; state.inventory.push(k); state.equipped[it.s] = k; }
        save();
    };
    window.buyP = (k) => { if(state.gold >= DB.perks[k].p) { state.gold -= DB.perks[k].p; state.perks.push(k); save(); } };
    window.startP = () => {
        const t = prompt('–¶–µ–ª—å:'); const g = parseInt(prompt('–°—É–º–º–∞:'));
        if(t && g) { state.piggy = { active: true, title: t, goal: g, curr: 0 }; save(); }
    };
    window.depP = () => {
        const v = parseInt(prompt('–°—É–º–º–∞:'));
        if(v > 0 && state.gold >= v) { state.gold -= v; state.piggy.curr += v; state.skills.money.xp += 15; save(); }
    };

    init();
</script>
</body>
</html>
