<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero RPG: Director's Cut</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –ë–ê–ó–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò (VARIABLES) --- */
        :root {
            --bg: #0d0d0f;
            --card-bg: rgba(255, 255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #aaaaaa;
            
            /* –¶–í–ï–¢–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê */
            --btn-primary: #3390ec;
            --btn-text: #ffffff;
            
            /* –ò–ì–†–û–í–´–ï –¶–í–ï–¢–ê */
            --gold: #f1c40f;
            --hp: #ff4757;
            --accent: #00d2ff;
            --piggy: #2ecc71;
            --danger: #e74c3c;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
            padding-bottom: 100px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ */
            overflow-x: hidden;
        }

        /* --- –ê–ù–ò–ú–ê–¶–ò–ò –ò VFX --- */
        @keyframes fly-away {
            0% { 
                opacity: 1; 
                transform: translate(0, 0) scale(1); 
            }
            100% { 
                opacity: 0; 
                transform: translate(var(--mx), var(--my)) scale(1.5); 
            }
        }

        .particle {
            position: fixed;
            pointer-events: none;
            z-index: 10000;
            animation: fly-away 0.8s ease-out forwards;
            font-size: 24px;
            font-weight: bold;
            color: var(--gold);
        }

        /* --- UI –ö–û–ú–ü–û–ù–ï–ù–¢–´ --- */
        .card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            position: relative;
        }

        .hero-avatar-row {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 55px;
            height: 80px;
            margin: 10px 0;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        .hero-rank {
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent);
            text-align: center;
            margin-bottom: 5px;
        }

        /* --- –ü–†–û–ì–†–ï–°–° –ë–ê–†–´ --- */
        .bar-container {
            background: rgba(0, 0, 0, 0.4);
            height: 10px;
            border-radius: 6px;
            margin: 10px 0;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        /* --- –¢–ê–ë–´ (–ù–ê–í–ò–ì–ê–¶–ò–Ø) --- */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 4px;
            scrollbar-width: none; /* –°–∫—Ä—ã—Ç–∏–µ —Å–∫—Ä–æ–ª–ª–∞ Firefox */
        }
        .tabs::-webkit-scrollbar { display: none; /* –°–∫—Ä—ã—Ç–∏–µ —Å–∫—Ä–æ–ª–ª–∞ Chrome */ }

        .tab-btn {
            padding: 12px 20px;
            border-radius: 14px;
            background: var(--card-bg);
            color: var(--text-muted);
            border: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 13px;
            font-weight: 700;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            background: var(--btn-primary);
            color: var(--btn-text);
            box-shadow: 0 4px 15px rgba(51, 144, 236, 0.3);
            transform: translateY(-1px);
        }

        /* --- –°–ü–ò–°–û–ö –ö–í–ï–°–¢–û–í --- */
        .quest-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 18px;
            margin-bottom: 12px;
            border-left: 5px solid var(--btn-primary);
            transition: transform 0.2s;
        }

        .quest-item:active {
            transform: scale(0.98);
        }

        .quest-item.completed {
            opacity: 0.5;
            filter: grayscale(0.8);
            border-left-color: #555;
        }

        .quest-info b {
            display: block;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .quest-time {
            font-size: 11px;
            color: var(--accent);
            font-weight: 700;
            background: rgba(0, 210, 255, 0.1);
            padding: 3px 8px;
            border-radius: 6px;
            display: inline-block;
            margin-bottom: 5px;
        }

        /* --- –ö–ù–û–ü–ö–ò --- */
        .btn-main {
            background: var(--btn-primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 18px;
            width: 100%;
            font-weight: 800;
            font-size: 16px;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(51, 144, 236, 0.3);
            cursor: pointer;
        }

        .btn-action {
            padding: 8px 16px;
            border-radius: 10px;
            border: none;
            font-weight: 700;
            font-size: 12px;
            cursor: pointer;
        }

        .btn-icon {
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
        }

        /* --- –ú–ê–ì–ê–ó–ò–ù --- */
        .shop-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .shop-row:last-child { border-bottom: none; }

        /* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û --- */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg);
            z-index: 2000;
            display: none;
            padding: 24px;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group { margin-bottom: 20px; }
        
        label {
            display: block;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 700;
            text-transform: uppercase;
        }

        input, select {
            width: 100%;
            padding: 16px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.05);
            color: white;
            font-size: 15px;
            outline: none;
        }
        
        input:focus, select:focus {
            border-color: var(--btn-primary);
            background: rgba(255,255,255,0.08);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="card" style="text-align: center;">
    <div id="hero-rank" class="hero-rank">–ù–û–í–ò–ß–û–ö</div>
    
    <div class="hero-avatar-row">
        <span id="vis-head" style="font-size:40px; width:50px; text-align:right;"></span>
        <span id="vis-body" style="margin: 0 5px;">üë∂</span>
        <span id="vis-weap" style="font-size:40px; width:50px; text-align:left;"></span>
    </div>

    <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">
        –£—Ä–æ–≤–µ–Ω—å <span id="total-lvl">1</span>
    </div>

    <div style="display: flex; justify-content: space-between; font-size: 13px; font-weight: 700; margin-bottom: 5px;">
        <span>‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ: <span id="hp-val">100</span></span>
        <span style="color: var(--gold);">üí∞ –ó–æ–ª–æ—Ç–æ: <span id="gold-val">0</span></span>
    </div>
    
    <div class="bar-container">
        <div id="hp-bar" class="bar-fill" style="background: var(--hp); width: 100%;"></div>
    </div>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('tasks')">–ó–ê–î–ê–ß–ò</button>
    <button class="tab-btn" onclick="switchTab('piggy')">–ö–û–ü–ò–õ–ö–ê</button>
    <button class="tab-btn" onclick="switchTab('shop')">–ú–ê–ì–ê–ó–ò–ù</button>
    <button class="tab-btn" onclick="switchTab('hero')">–ì–ï–†–û–ô</button>
</div>

<div id="tab-tasks">
    <div id="quest-list">
        </div>
    <button class="btn-main" onclick="openModal()">Ôºã –î–û–ë–ê–í–ò–¢–¨ –ó–ê–î–ê–ß–£</button>
</div>

<div id="tab-piggy" class="hidden">
    <div class="card" style="border-color: var(--piggy); background: linear-gradient(145deg, rgba(46,204,113,0.1), transparent);">
        <h3 style="margin-top:0; color: var(--piggy);">üí∞ –†–µ–∞–ª—å–Ω–∞—è —Ü–µ–ª—å</h3>
        <div id="piggy-content">
            </div>
    </div>
</div>

<div id="tab-shop" class="hidden">
    <div class="card">
        <h3 style="margin-top:0; color: var(--accent);">üõ°Ô∏è –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</h3>
        <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">–ú–µ–Ω—è–µ—Ç –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –≥–µ—Ä–æ—è</p>
        <div id="shop-gear-list"></div>
        
        <div style="margin: 20px 0; border-top: 1px solid rgba(255,255,255,0.1);"></div>
        
        <h3 style="margin-top:0; color: var(--gold);">‚ö° –¢–∞–ª–∞–Ω—Ç—ã</h3>
        <p style="font-size:12px; color:var(--text-muted); margin-bottom:15px;">–î–∞—é—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –±–æ–Ω—É—Å—ã</p>
        <div id="shop-perks-list"></div>
    </div>
</div>

<div id="tab-hero" class="hidden">
    <div id="skills-list">
        </div>

    <div class="card" style="margin-top: 20px;">
        <h3 style="margin-top:0">üìÖ –ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</h3>
        <div id="week-calendar"></div>
    </div>
</div>

<div id="modal-overlay">
    <h2 style="margin-top:0">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
    
    <div class="input-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–≤–µ—Å—Ç–∞</label>
        <input type="text" id="inp-title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ—á–∏—Ç–∞—Ç—å 10 —Å—Ç—Ä–∞–Ω–∏—Ü">
    </div>
    
    <div class="input-group">
        <label>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <div style="display:flex; gap:10px">
            <input type="time" id="inp-start">
            <input type="time" id="inp-end">
        </div>
    </div>

    <div class="input-group">
        <label>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</label>
        <select id="inp-day">
            <option value="0">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option>
            <option value="1">–í—Ç–æ—Ä–Ω–∏–∫</option>
            <option value="2">–°—Ä–µ–¥–∞</option>
            <option value="3">–ß–µ—Ç–≤–µ—Ä–≥</option>
            <option value="4">–ü—è—Ç–Ω–∏—Ü–∞</option>
            <option value="5">–°—É–±–±–æ—Ç–∞</option>
            <option value="6">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
        </select>
    </div>

    <div class="input-group">
        <label>–°—Ñ–µ—Ä–∞ —Ä–∞–∑–≤–∏—Ç–∏—è</label>
        <select id="inp-cat" onchange="toggleCustomInput(this)">
            <option value="money">üí∞ –î–µ–Ω—å–≥–∏ / –†–∞–±–æ—Ç–∞</option>
            <option value="education">üéì –û–±—É—á–µ–Ω–∏–µ / –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç</option>
            <option value="health">üí™ –ó–¥–æ—Ä–æ–≤—å–µ / –°–ø–æ—Ä—Ç</option>
            </select>
    </div>
    
    <div id="custom-cat-wrapper" class="input-group hidden">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ñ–µ—Ä—ã</label>
        <input type="text" id="inp-custom" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –†–∏—Å–æ–≤–∞–Ω–∏–µ">
    </div>

    <button class="btn-main" onclick="saveNewTask()">–°–û–•–†–ê–ù–ò–¢–¨ –ö–í–ï–°–¢</button>
    <button onclick="closeModal()" style="width:100%; background:none; border:none; color:var(--text-muted); margin-top:20px; font-weight:bold; padding: 10px;">–û–¢–ú–ï–ù–ê</button>
</div>

<script>
    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM ---
    const tg = window.Telegram.WebApp;
    tg.expand();

    // --- –ö–û–ù–°–¢–ê–ù–¢–´ ---
    const DAYS_OF_WEEK = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
    
    const GAME_DB = {
        gear: {
            'helm_1': { name: '–ñ–µ–ª–µ–∑–Ω—ã–π —à–ª–µ–º', icon: 'ü™ñ', price: 500, slot: 'head' },
            'helm_2': { name: '–ö–æ—Ä–æ–Ω–∞ –∫–æ—Ä–æ–ª—è', icon: 'üëë', price: 2000, slot: 'head' },
            'weap_1': { name: '–°—Ç–∞–ª—å–Ω–æ–π –º–µ—á', icon: 'üó°Ô∏è', price: 800, slot: 'weapon' },
            'weap_2': { name: '–ü–æ—Å–æ—Ö –º–∞–≥–∞', icon: 'ü™Ñ', price: 1200, slot: 'weapon' },
            'weap_3': { name: '–õ—É–∫ —ç–ª—å—Ñ–∞', icon: 'üèπ', price: 1500, slot: 'weapon' }
        },
        perks: {
            'gold_boost': { name: '–ê–ª—á–Ω–æ—Å—Ç—å', desc: '+20% –∑–æ–ª–æ—Ç–∞ –∑–∞ –∑–∞–¥–∞—á–∏', price: 1000 },
            'hp_regen': { name: '–í—Ç–æ—Ä–æ–µ –¥—ã—Ö–∞–Ω–∏–µ', desc: '–®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–æ–ø—É—Å–∫–∏ —Å–Ω–∏–∂–µ–Ω –Ω–∞ 50%', price: 1500 }
        }
    };

    // --- –°–û–°–¢–û–Ø–ù–ò–ï (STATE) ---
    let state = JSON.parse(localStorage.getItem('hero_v19_directors_cut')) || {
        gold: 0,
        hp: 100,
        lastLoginDate: new Date().toDateString(),
        skills: {
            money: { lvl: 1, xp: 0 },
            education: { lvl: 1, xp: 0 },
            health: { lvl: 1, xp: 0 }
        },
        quests: [],
        inventory: [],
        equipped: { head: null, weapon: null },
        perks: [],
        piggy: { active: false, title: '', goal: 0, current: 0 }
    };

    // --- –°–ò–°–¢–ï–ú–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø ---
    function saveGame() {
        localStorage.setItem('hero_v19_directors_cut', JSON.stringify(state));
        renderAll();
    }

    // --- –õ–û–ì–ò–ö–ê –ù–û–í–û–ì–û –î–ù–Ø (Daily Reset) ---
    function checkDailyReset() {
        const today = new Date().toDateString();
        
        if (state.lastLoginDate !== today) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–¥–µ–∫—Å –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è
            const yesterdayIndex = (new Date().getDay() + 5) % 7;
            
            // –ò—â–µ–º –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –∑–∞ –≤—á–µ—Ä–∞
            const missedTasks = state.quests.filter(q => parseInt(q.day) === yesterdayIndex && !q.done);
            
            if (missedTasks.length > 0) {
                let damage = missedTasks.length * 15; // 15 —É—Ä–æ–Ω–∞ –∑–∞ –∑–∞–¥–∞—á—É
                
                // –ï—Å–ª–∏ –∫—É–ø–ª–µ–Ω –ø–µ—Ä–∫ –∑–∞—â–∏—Ç—ã
                if (state.perks.includes('hp_regen')) {
                    damage = Math.floor(damage / 2);
                }
                
                state.hp = Math.max(0, state.hp - damage);
                alert(`‚ö†Ô∏è –ù–æ–≤—ã–π –¥–µ–Ω—å!\n–í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ ${missedTasks.length} –∑–∞–¥–∞—á –≤—á–µ—Ä–∞.\n–ü–æ—Ç–µ—Ä—è–Ω–æ ${damage} HP.`);
            } else {
                // –ï—Å–ª–∏ –≤—Å–µ —á–∏—Å—Ç–æ - –ª–µ—á–∏–º –≥–µ—Ä–æ—è
                state.hp = Math.min(100, state.hp + 10);
            }
            
            state.lastLoginDate = today;
            saveGame();
        }
    }

    // --- –í–ò–ó–£–ê–õ–¨–ù–´–ï –≠–§–§–ï–ö–¢–´ (PARTICLES) ---
    function spawnParticles(x, y) {
        for (let i = 0; i < 8; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.innerText = 'üí∞';
            p.style.left = x + 'px';
            p.style.top = y + 'px';
            
            // –°–ª—É—á–∞–π–Ω—ã–π —Ä–∞–∑–ª–µ—Ç –≤ —Å—Ç–æ—Ä–æ–Ω—ã
            const randomX = (Math.random() - 0.5) * 200 + 'px';
            const randomY = (Math.random() - 1) * 150 + 'px'; // –ë–æ–ª—å—à–µ –≤–≤–µ—Ä—Ö
            
            p.style.setProperty('--mx', randomX);
            p.style.setProperty('--my', randomY);
            
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 800);
        }
    }

    // --- –†–ï–ù–î–ï–†–ò–ù–ì –ò–ù–¢–ï–†–§–ï–ô–°–ê ---
    function renderAll() {
        renderStats();
        renderQuests();
        renderPiggy();
        renderShop();
        renderSkills();
        renderCalendar();
    }

    function renderStats() {
        // –ó–æ–ª–æ—Ç–æ –∏ HP
        document.getElementById('gold-val').innerText = state.gold;
        document.getElementById('hp-val').innerText = state.hp;
        document.getElementById('hp-bar').style.width = state.hp + '%';

        // –≠–≤–æ–ª—é—Ü–∏—è –ê–≤–∞—Ç–∞—Ä–∞
        let totalLvl = 0;
        for (let key in state.skills) {
            totalLvl += state.skills[key].lvl;
        }
        document.getElementById('total-lvl').innerText = totalLvl;

        // –õ–æ–≥–∏–∫–∞ —Ä–∞–Ω–≥–æ–≤ –∏ —Å–∫–∏–Ω–æ–≤
        let rankName = "–ù–û–í–ò–ß–û–ö";
        let bodySkin = "üë∂";

        if (totalLvl > 5) { rankName = "–ò–°–ö–ê–¢–ï–õ–¨"; bodySkin = "üèπ"; }
        if (totalLvl > 15) { rankName = "–í–û–ò–ù"; bodySkin = "‚öîÔ∏è"; }
        if (totalLvl > 30) { rankName = "–õ–ï–ì–ï–ù–î–ê"; bodySkin = "ü¶∏"; }

        document.getElementById('hero-rank').innerText = rankName;
        document.getElementById('vis-body').innerText = bodySkin;

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–¥–µ—Ç–æ–≥–æ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è
        const headId = state.equipped.head;
        const weapId = state.equipped.weapon;
        
        document.getElementById('vis-head').innerText = headId ? GAME_DB.gear[headId].icon : '';
        document.getElementById('vis-weap').innerText = weapId ? GAME_DB.gear[weapId].icon : '';
    }

    function renderQuests() {
        const todayIndex = (new Date().getDay() + 6) % 7; // 0 - –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
        const todaysQuests = state.quests.filter(q => parseInt(q.day) === todayIndex);
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: —Å–Ω–∞—á–∞–ª–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –ø–æ—Ç–æ–º –∑–∞–¥–∞—á–∏ –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏
        todaysQuests.sort((a, b) => {
            if (!a.start) return 1;
            if (!b.start) return -1;
            return a.start.localeCompare(b.start);
        });

        const listEl = document.getElementById('quest-list');
        listEl.innerHTML = '';

        if (todaysQuests.length === 0) {
            listEl.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.5;">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–¥–∞—á –Ω–µ—Ç. –û—Ç–¥—ã—Ö–∞–π—Ç–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—É—é!</div>';
            return;
        }

        todaysQuests.forEach((q) => {
            const globalIndex = state.quests.indexOf(q);
            const item = document.createElement('div');
            item.className = `quest-item ${q.done ? 'completed' : ''}`;
            
            let timeHtml = '';
            if (q.start) {
                timeHtml = `<span class="quest-time">üïí ${q.start} ${q.end ? '- ' + q.end : ''}</span>`;
            }

            item.innerHTML = `
                <div class="quest-info">
                    ${timeHtml}
                    <b>${q.title}</b>
                    <small style="color:var(--text-muted)">${q.cat.toUpperCase()}</small>
                </div>
                <div>
                    ${q.done ? 
                        `<button class="btn-icon" onclick="deleteQuest(${globalIndex})">üóëÔ∏è</button>` : 
                        `<button class="btn-action" style="background:var(--btn-primary); color:white;" onclick="completeQuest(event, ${globalIndex})">–ì–û–¢–û–í–û</button>`
                    }
                </div>
            `;
            listEl.appendChild(item);
        });
    }

    function renderPiggy() {
        const container = document.getElementById('piggy-content');
        if (!state.piggy.active) {
            container.innerHTML = `
                <p style="font-size:13px; opacity:0.8; margin-bottom:15px;">
                    –ö–æ–ø–∏—Ç–µ –Ω–∞ –º–µ—á—Ç—É –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏? –ó–∞–ø–∏—à–∏—Ç–µ —Ü–µ–ª—å –∑–¥–µ—Å—å –∏ –ø–æ–ª—É—á–∞–π—Ç–µ XP –∑–∞ –∫–∞–∂–¥–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ!
                </p>
                <button class="btn-main" style="background:var(--piggy)" onclick="createPiggyGoal()">üéØ –°–û–ó–î–ê–¢–¨ –¶–ï–õ–¨</button>
            `;
        } else {
            const p = state.piggy;
            const percent = Math.min(100, (p.current / p.goal) * 100);
            
            container.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <b>${p.title}</b>
                    <span style="font-weight:bold; color:var(--piggy)">${p.current} / ${p.goal}</span>
                </div>
                <div class="bar-container">
                    <div class="bar-fill" style="width:${percent}%; background:var(--piggy)"></div>
                </div>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="btn-action" style="background:var(--piggy); color:white; flex:1;" onclick="depositMoney()">‚ûï –í–ù–ï–°–¢–ò</button>
                    <button class="btn-action" style="background:rgba(255,255,255,0.1); color:white;" onclick="deletePiggy()">üóëÔ∏è</button>
                </div>
            `;
        }
    }

    function renderShop() {
        // –†–µ–Ω–¥–µ—Ä –°–Ω–∞—Ä—è–∂–µ–Ω–∏—è
        const gearList = document.getElementById('shop-gear-list');
        gearList.innerHTML = Object.keys(GAME_DB.gear).map(key => {
            const item = GAME_DB.gear[key];
            const isOwned = state.inventory.includes(key);
            const isEquipped = state.equipped[item.slot] === key;
            
            let btnText = item.price + ' üí∞';
            let btnColor = 'var(--gold)';
            let btnTextColor = 'black';

            if (isOwned) {
                btnText = isEquipped ? '–°–ù–Ø–¢–¨' : '–ù–ê–î–ï–¢–¨';
                btnColor = isEquipped ? 'var(--hp)' : 'var(--btn-primary)';
                btnTextColor = 'white';
            }

            return `
                <div class="shop-row">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:24px;">${item.icon}</span>
                        <div><b>${item.name}</b></div>
                    </div>
                    <button class="btn-action" 
                        style="background:${btnColor}; color:${btnTextColor}" 
                        onclick="handleGearBuy('${key}')">
                        ${btnText}
                    </button>
                </div>
            `;
        }).join('');

        // –†–µ–Ω–¥–µ—Ä –ü–µ—Ä–∫–æ–≤
        const perksList = document.getElementById('shop-perks-list');
        perksList.innerHTML = Object.keys(GAME_DB.perks).map(key => {
            const perk = GAME_DB.perks[key];
            const isOwned = state.perks.includes(key);

            return `
                <div class="shop-row">
                    <div>
                        <b style="font-size:14px;">${perk.name}</b><br>
                        <small style="opacity:0.6;">${perk.desc}</small>
                    </div>
                    <button class="btn-action" 
                        style="background:${isOwned ? '#444' : 'var(--gold)'}; color:${isOwned ? '#888' : 'black'}" 
                        onclick="buyPerk('${key}')" ${isOwned ? 'disabled' : ''}>
                        ${isOwned ? '–ö–£–ü–õ–ï–ù–û' : perk.price}
                    </button>
                </div>
            `;
        }).join('');
    }

    function renderSkills() {
        const container = document.getElementById('skills-list');
        container.innerHTML = Object.keys(state.skills).map(key => {
            const skill = state.skills[key];
            return `
                <div class="card" onclick="tryDeleteSkill('${key}')">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-weight:bold;">
                        <span style="text-transform:uppercase;">${key} (Lvl ${skill.lvl})</span>
                        <span>${skill.xp}%</span>
                    </div>
                    <div class="bar-container">
                        <div class="bar-fill" style="width:${skill.xp}%; background:var(--btn-primary)"></div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderCalendar() {
        let html = '';
        DAYS_OF_WEEK.forEach((dayName, index) => {
            const count = state.quests.filter(q => parseInt(q.day) === index && !q.done).length;
            if (count > 0) {
                html += `
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05)">
                        <span style="color:var(--accent)">${dayName}</span>
                        <span style="font-weight:bold">${count} –∫–≤–µ—Å—Ç–æ–≤</span>
                    </div>
                `;
            }
        });
        document.getElementById('week-calendar').innerHTML = html || '<div style="opacity:0.5; font-size:12px; text-align:center">–í—Å—é –Ω–µ–¥–µ–ª—é —Å–≤–æ–±–æ–¥–Ω–æ!</div>';
    }

    // --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø (CONTROLLERS) ---

    // 1. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
    window.openModal = () => {
        const select = document.getElementById('inp-cat');
        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–ø—Ü–∏–π (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–µ 3 –±–∞–∑–æ–≤—ã–µ)
        while (select.options.length > 3) {
            select.remove(3);
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å—Ñ–µ—Ä –∏–∑ —Å—Ç–µ–π—Ç–∞ (–£–º–Ω—ã–π —Å–ø–∏—Å–æ–∫)
        Object.keys(state.skills).forEach(key => {
            if (!['money', 'education', 'health'].includes(key)) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = '‚ú® ' + key.charAt(0).toUpperCase() + key.slice(1);
                select.add(opt);
            }
        });

        // –û–ø—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π
        const newOpt = document.createElement('option');
        newOpt.value = 'new_custom_val';
        newOpt.innerText = '‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é...';
        select.add(newOpt);

        document.getElementById('modal-overlay').style.display = 'block';
    };

    window.closeModal = () => {
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById('inp-title').value = '';
    };

    window.toggleCustomInput = (selectInfo) => {
        const wrapper = document.getElementById('custom-cat-wrapper');
        if (selectInfo.value === 'new_custom_val') {
            wrapper.classList.remove('hidden');
        } else {
            wrapper.classList.add('hidden');
        }
    };

    window.saveNewTask = () => {
        const title = document.getElementById('inp-title').value;
        if (!title) {
            alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏!");
            return;
        }

        let category = document.getElementById('inp-cat').value;
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é"
        if (category === 'new_custom_val') {
            const customName = document.getElementById('inp-custom').value.trim();
            if (!customName) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ñ–µ—Ä—ã");
            
            category = customName.toLowerCase();
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Å—Ñ–µ—Ä—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
            if (!state.skills[category]) {
                state.skills[category] = { lvl: 1, xp: 0 };
            }
        }

        const newTask = {
            title: title,
            start: document.getElementById('inp-start').value,
            end: document.getElementById('inp-end').value,
            day: document.getElementById('inp-day').value,
            cat: category,
            done: false
        };

        state.quests.push(newTask);
        closeModal();
        saveGame();
    };

    // 2. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á
    window.completeQuest = (e, index) => {
        spawnParticles(e.clientX, e.clientY);
        
        const quest = state.quests[index];
        quest.done = true;

        // –†–∞—Å—á–µ—Ç –Ω–∞–≥—Ä–∞–¥—ã
        let reward = 50;
        if (state.perks.includes('gold_boost')) reward = 60; // –ë–æ–Ω—É—Å –ø–µ—Ä–∫–∞
        state.gold += reward;

        // –û–ø—ã—Ç –≤ —Å—Ñ–µ—Ä—É
        if (state.skills[quest.cat]) {
            state.skills[quest.cat].xp += 25;
            if (state.skills[quest.cat].xp >= 100) {
                state.skills[quest.cat].xp = 0;
                state.skills[quest.cat].lvl++;
                tg.HapticFeedback.notificationOccurred('success');
            }
        }

        saveGame();
    };

    window.deleteQuest = (index) => {
        if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?")) {
            state.quests.splice(index, 1);
            saveGame();
        }
    };

    // 3. –ö–æ–ø–∏–ª–∫–∞
    window.createPiggyGoal = () => {
        const title = prompt("–ù–∞ —á—Ç–æ –∫–æ–ø–∏–º? (–ù–∞–ø—Ä–∏–º–µ—Ä: iPhone 16)");
        const amount = parseInt(prompt("–°—É–º–º–∞ —Ü–µ–ª–∏? (–ù–∞–ø—Ä–∏–º–µ—Ä: 100000)"));
        if (title && amount) {
            state.piggy = { active: true, title: title, goal: amount, current: 0 };
            saveGame();
        }
    };

    window.depositMoney = () => {
        const amount = parseInt(prompt("–°–∫–æ–ª—å–∫–æ –æ—Ç–ª–æ–∂–∏–ª–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏?"));
        if (!amount || amount <= 0) return;

        state.piggy.current += amount;
        
        // –ê–Ω—Ç–∏-—Å–ø–∞–º: –æ–ø—ã—Ç –¥–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞ –≤–µ—Å–æ–º—ã–µ –≤–∫–ª–∞–¥—ã (>100)
        if (amount >= 100) {
            state.skills.money.xp += 20;
            if (state.skills.money.xp >= 100) {
                state.skills.money.xp = 0;
                state.skills.money.lvl++;
            }
        } else {
            alert("–°—É–º–º–∞ –≤–Ω–µ—Å–µ–Ω–∞! (–û–ø—ã—Ç –¥–∞–µ—Ç—Å—è –∑–∞ –≤–∫–ª–∞–¥—ã –æ—Ç 100)");
        }
        saveGame();
    };

    window.deletePiggy = () => {
        if (confirm("–£–¥–∞–ª–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Ü–µ–ª—å?")) {
            state.piggy.active = false;
            saveGame();
        }
    };

    // 4. –ú–∞–≥–∞–∑–∏–Ω
    window.handleGearBuy = (key) => {
        const item = GAME_DB.gear[key];
        
        if (state.inventory.includes(key)) {
            // –ï—Å–ª–∏ —É–∂–µ –∫—É–ø–ª–µ–Ω–æ - –Ω–∞–¥–µ–≤–∞–µ–º/—Å–Ω–∏–º–∞–µ–º
            if (state.equipped[item.slot] === key) {
                state.equipped[item.slot] = null;
            } else {
                state.equipped[item.slot] = key;
            }
        } else {
            // –ü–æ–∫—É–ø–∫–∞
            if (state.gold >= item.price) {
                state.gold -= item.price;
                state.inventory.push(key);
                state.equipped[item.slot] = key;
                tg.HapticFeedback.impactOccurred('medium');
            } else {
                alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞!");
            }
        }
        saveGame();
    };

    window.buyPerk = (key) => {
        const item = GAME_DB.perks[key];
        if (state.gold >= item.price) {
            state.gold -= item.price;
            state.perks.push(key);
            saveGame();
        } else {
            alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∑–æ–ª–æ—Ç–∞!");
        }
    };

    // 5. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ñ–µ—Ä–∞–º–∏
    window.tryDeleteSkill = (key) => {
        if (['money', 'education', 'health'].includes(key)) return;
        
        if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ñ–µ—Ä—É "${key}" –∏ –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –Ω–µ–π?`)) {
            delete state.skills[key];
            saveGame();
        }
    };

    window.switchTab = (tabName) => {
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é
        document.getElementById('tab-' + tabName).classList.remove('hidden');
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É (event.target –º–æ–∂–µ—Ç –±—ã—Ç—å span –≤–Ω—É—Ç—Ä–∏ –∫–Ω–æ–ø–∫–∏, –ø–æ—ç—Ç–æ–º—É –∏—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π button)
        event.currentTarget.classList.add('active');
    };

    // --- –ó–ê–ü–£–°–ö ---
    checkDailyReset();
    renderAll();

</script>
</body>
</html>
