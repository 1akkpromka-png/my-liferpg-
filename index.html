<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero RPG: Sovereign</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0d0d0f;
            --card: rgba(255, 255, 255, 0.07);
            --text: #ffffff;
            --btn: #3390ec;
            --gold: #f1c40f;
            --hp: #ff4757;
            --accent: #00d2ff;
            --piggy: #2ecc71;
        }

        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 12px; padding-bottom: 100px; overflow-x: hidden; }
        .card { background: var(--card); border-radius: 20px; padding: 15px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        
        /* –≠—Ñ—Ñ–µ–∫—Ç —á–∞—Å—Ç–∏—Ü */
        .particle { position: fixed; pointer-events: none; z-index: 9999; animation: fly 0.8s ease-out forwards; font-size: 20px; }
        @keyframes fly { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-80px); } }

        /* –ì–µ—Ä–æ–π */
        .hero-rank { font-size: 10px; font-weight: 800; color: var(--accent); letter-spacing: 2px; text-transform: uppercase; }
        .hero-avatar-row { font-size: 50px; margin: 10px 0; display: flex; justify-content: center; align-items: center; }
        
        /* –¢–∞–±—ã */
        .tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 10px 16px; border-radius: 12px; background: var(--card); color: var(--text); border: none; font-size: 11px; font-weight: bold; white-space: nowrap; transition: 0.3s; }
        .tab-btn.active { background: var(--btn); box-shadow: 0 4px 12px rgba(51, 144, 236, 0.3); }

        /* –ó–∞–¥–∞—á–∏ */
        .quest { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 16px; margin-bottom: 10px; border-left: 4px solid var(--btn); }
        .time-label { font-size: 10px; color: var(--accent); font-weight: bold; display: block; margin-bottom: 3px; }

        /* –ö–æ–ø–∏–ª–∫–∞ */
        .piggy-ui { border: 1px solid var(--piggy); background: linear-gradient(145deg, rgba(46,204,113,0.1), transparent); }
        .bar-bg { background: rgba(0,0,0,0.4); height: 10px; border-radius: 5px; margin: 10px 0; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.8s ease; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-main { background: var(--btn); color: white; border: none; padding: 16px; border-radius: 16px; width: 100%; font-weight: bold; font-size: 15px; margin-top: 5px; }
        .btn-action { background: var(--piggy); color: white; border: none; padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: bold; }

        .hidden { display: none; }
        #planner-modal { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: none; padding: 25px; overflow-y: auto; }
        input, select { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: #161618; color: white; box-sizing: border-box; }
    </style>
</head>
<body>

<div class="card" style="text-align: center;">
    <div id="hero-rank" class="hero-rank">–ù–û–í–ò–ß–û–ö</div>
    <div class="hero-avatar-row">
        <span id="eq-head"></span><span id="hero-body">üë∂</span><span id="eq-weapon"></span>
    </div>
    <div style="font-weight: bold; font-size: 18px;">Lvl <span id="total-lvl">1</span></div>
    
    <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 12px;">
        <span>‚ù§Ô∏è HP: <span id="hp-val">100</span></span>
        <span style="color: var(--gold);">üí∞ –ó–æ–ª–æ—Ç–æ: <span id="gold-val">0</span></span>
    </div>
    <div class="bar-bg"><div id="hp-bar" class="bar-fill" style="background: var(--hp); width: 100%;"></div></div>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="showTab('tasks')">–ó–ê–î–ê–ß–ò</button>
    <button class="tab-btn" onclick="showTab('piggy')">–ö–û–ü–ò–õ–ö–ê</button>
    <button class="tab-btn" onclick="showTab('shop')">–ú–ê–ì–ê–ó–ò–ù</button>
    <button class="tab-btn" onclick="showTab('week')">–ù–ï–î–ï–õ–Ø</button>
</div>

<div id="tab-tasks">
    <div id="quest-list"></div>
    <button class="btn-main" onclick="openPlanner()">Ôºã –°–û–ó–î–ê–¢–¨ –ö–í–ï–°–¢</button>
</div>

<div id="tab-piggy" class="hidden">
    <div class="card piggy-ui">
        <h3 style="margin-top:0">üí∞ –ú–æ–∏ –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è</h3>
        <div id="piggy-config" class="hidden">
            <button class="btn-main" onclick="setupPiggy()">–£–°–¢–ê–ù–û–í–ò–¢–¨ –¶–ï–õ–¨</button>
        </div>
        <div id="piggy-display">
            <div style="display:flex; justify-content:space-between; font-size:14px;">
                <b id="piggy-title">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
                <span id="piggy-stats">0 / 0</span>
            </div>
            <div class="bar-bg"><div id="piggy-bar" class="bar-fill" style="background: var(--piggy);"></div></div>
            <button class="btn-action" onclick="depositPiggy()">–í–ù–ï–°–¢–ò –ò–ó –†–ï–ê–õ–ê</button>
            <button onclick="resetPiggy()" style="background:none; border:none; color:rgba(255,255,255,0.3); font-size:10px; margin-left:10px">–°–±—Ä–æ—Å</button>
        </div>
    </div>
</div>

<div id="tab-shop" class="hidden">
    <div style="font-size: 12px; color: var(--accent); margin-bottom: 10px;">–°–ù–ê–†–Ø–ñ–ï–ù–ò–ï</div>
    <div id="gear-list"></div>
    <div style="font-size: 12px; color: var(--accent); margin: 15px 0 10px;">–¢–ê–õ–ê–ù–¢–´</div>
    <div id="perks-list"></div>
</div>

<div id="tab-week" class="hidden">
    <div id="week-view"></div>
</div>

<div id="planner-modal">
    <h2 style="margin-top:0">–ù–æ–≤–∞—è —Ü–µ–ª—å</h2>
    <input type="text" id="p-title" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
    
    <label style="font-size: 11px; color: var(--accent)">–ò–ù–¢–ï–†–í–ê–õ –í–†–ï–ú–ï–ù–ò (24–ß):</label>
    <div style="display:flex; gap:10px">
        <input type="time" id="p-start">
        <input type="time" id="p-end">
    </div>

    <select id="p-day">
        <option value="0">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option><option value="1">–í—Ç–æ—Ä–Ω–∏–∫</option><option value="2">–°—Ä–µ–¥–∞</option>
        <option value="3">–ß–µ—Ç–≤–µ—Ä–≥</option><option value="4">–ü—è—Ç–Ω–∏—Ü–∞</option><option value="5">–°—É–±–±–æ—Ç–∞</option><option value="6">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
    </select>

    <select id="p-cat">
        <option value="money">üí∞ –î–µ–Ω—å–≥–∏ / –ö–∞—Ä—å–µ—Ä–∞</option>
        <option value="education">üéì –û–±—É—á–µ–Ω–∏–µ</option>
        <option value="health">üí™ –ó–¥–æ—Ä–æ–≤—å–µ / –°–ø–æ—Ä—Ç</option>
    </select>

    <button class="btn-main" onclick="saveTask()">–î–û–ë–ê–í–ò–¢–¨ –í –ö–ù–ò–ì–£ –ö–í–ï–°–¢–û–í</button>
    <button onclick="closePlanner()" style="width:100%; background:none; border:none; color:white; margin-top:20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
    const GEAR_DATA = {
        'h1': { name: '–°—Ç–∞–ª—å–Ω–æ–π –®–ª–µ–º', icon: 'ü™ñ', price: 500, slot: 'head' },
        'w1': { name: '–ú–µ—á –ù–æ–≤–∏—á–∫–∞', icon: 'üó°Ô∏è', price: 700, slot: 'weapon' }
    };

    let state = JSON.parse(localStorage.getItem('hero_v15_final')) || {
        gold: 0, hp: 100,
        skills: { money:{xp:0, lvl:1}, education:{xp:0, lvl:1}, health:{xp:0, lvl:1} },
        quests: [],
        inventory: [], equipped: { head:null, weapon:null },
        perks: [],
        piggy: { active: false, title: '', goal: 0, current: 0 }
    };

    function save() { localStorage.setItem('hero_v15_final', JSON.stringify(state)); render(); }

    function spawnVFX(e) {
        for(let i=0; i<6; i++) {
            const p = document.createElement('div');
            p.className = 'particle'; p.innerText = 'üí∞';
            p.style.left = e.clientX + 'px'; p.style.top = e.clientY + 'px';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 800);
        }
    }

    function render() {
        // –†–µ–Ω–¥–µ—Ä —Å—Ç–∞—Ç–æ–≤
        document.getElementById('gold-val').innerText = state.gold;
        document.getElementById('hp-val').innerText = state.hp;
        document.getElementById('hp-bar').style.width = state.hp + '%';

        // –≠–≤–æ–ª—é—Ü–∏—è
        const totalLvl = state.skills.money.lvl + state.skills.education.lvl + state.skills.health.lvl;
        document.getElementById('total-lvl').innerText = totalLvl;
        document.getElementById('hero-body').innerText = totalLvl > 25 ? "ü¶∏" : (totalLvl > 10 ? "‚öîÔ∏è" : "üë∂");
        document.getElementById('hero-rank').innerText = totalLvl > 25 ? "–õ–ï–ì–ï–ù–î–ê" : (totalLvl > 10 ? "–ú–ê–°–¢–ï–†" : "–ù–û–í–ò–ß–û–ö");

        // –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞
        document.getElementById('eq-head').innerText = state.equipped.head ? GEAR_DATA[state.equipped.head].icon : '';
        document.getElementById('eq-weapon').innerText = state.equipped.weapon ? GEAR_DATA[state.equipped.weapon].icon : '';

        // –ö–æ–ø–∏–ª–∫–∞
        if(state.piggy.active) {
            document.getElementById('piggy-config').classList.add('hidden');
            document.getElementById('piggy-display').classList.remove('hidden');
            document.getElementById('piggy-title').innerText = state.piggy.title;
            document.getElementById('piggy-stats').innerText = `${state.piggy.current} / ${state.piggy.goal}`;
            document.getElementById('piggy-bar').style.width = Math.min(100, (state.piggy.current/state.piggy.goal)*100) + '%';
        } else {
            document.getElementById('piggy-config').classList.remove('hidden');
            document.getElementById('piggy-display').classList.add('hidden');
        }

        // –ó–∞–¥–∞—á–∏ –°–µ–≥–æ–¥–Ω—è
        const tIdx = (new Date().getDay() + 6) % 7;
        const today = state.quests.filter(q => parseInt(q.day) === tIdx);
        today.sort((a,b) => (a.start || '99:99').localeCompare(b.start || '99:99'));

        document.getElementById('quest-list').innerHTML = today.map(q => `
            <div class="quest ${q.done ? 'hidden' : ''}">
                <div>
                    <span class="time-label">üïí ${q.start || '--:--'} - ${q.end || '--:--'}</span>
                    <b>${q.title}</b>
                </div>
                <button class="btn-action" onclick="finishQuest(event, ${state.quests.indexOf(q)})">–ì–û–¢–û–í–û</button>
            </div>
        `).join('') || '<p style="text-align:center; opacity:0.5">–í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!</p>';

        // –ú–∞–≥–∞–∑–∏–Ω –°–Ω–∞—Ä—è–∂–µ–Ω–∏—è
        document.getElementById('gear-list').innerHTML = Object.keys(GEAR_DATA).map(id => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <span>${GEAR_DATA[id].icon} ${GEAR_DATA[id].name}</span>
                <button class="btn-action" onclick="handleGear('${id}')" style="background:${state.inventory.includes(id)?'var(--btn)':'var(--gold)'}">
                    ${state.inventory.includes(id) ? (state.equipped[GEAR_DATA[id].slot] === id ? '–°–ù–Ø–¢–¨' : '–ù–ê–î–ï–¢–¨') : GEAR_DATA[id].price+'üí∞'}
                </button>
            </div>
        `).join('');

        // –¢–∞–ª–∞–Ω—Ç—ã
        const perks = [{id:'p1', name:'–ê–Ω–∞–ª–∏—Ç–∏–∫', price:1000, desc:'+20% –∑–æ–ª–æ—Ç–∞'}];
        document.getElementById('perks-list').innerHTML = perks.map(p => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div><b>${p.name}</b><br><small>${p.desc}</small></div>
                <button class="btn-action" onclick="buyPerk('${p.id}', ${p.price})" ${state.perks.includes(p.id)?'disabled':''}>
                    ${state.perks.includes(p.id) ? '–ö–£–ü–õ–ï–ù–û' : p.price+'üí∞'}
                </button>
            </div>
        `).join('');

        // –ù–µ–¥–µ–ª—è
        let weekHtml = '';
        DAYS.forEach((d, i) => {
            const dq = state.quests.filter(q => parseInt(q.day) === i);
            if(dq.length) {
                weekHtml += `<div style="color:var(--accent); font-size:12px; margin-top:10px; font-weight:bold">${d}</div>`;
                weekHtml += dq.map(q => `<div style="font-size:11px; padding:3px 0; opacity:${q.done?0.4:1}">‚Ä¢ ${q.start||'--'} ${q.title}</div>`).join('');
            }
        });
        document.getElementById('week-view').innerHTML = weekHtml || '<p style="text-align:center; opacity:0.5">–ü–ª–∞–Ω—ã –Ω–∞ –Ω–µ–¥–µ–ª—é –ø—É—Å—Ç—ã</p>';
    }

    // –õ–û–ì–ò–ö–ê
    window.openPlanner = () => document.getElementById('planner-modal').style.display = 'block';
    window.closePlanner = () => document.getElementById('planner-modal').style.display = 'none';

    window.saveTask = () => {
        const title = document.getElementById('p-title').value;
        if(!title) return;
        state.quests.push({
            title, start: document.getElementById('p-start').value, end: document.getElementById('p-end').value,
            day: document.getElementById('p-day').value, cat: document.getElementById('p-cat').value, done: false
        });
        closePlanner(); save();
    };

    window.finishQuest = (e, idx) => {
        spawnVFX(e);
        const q = state.quests[idx]; q.done = true;
        let reward = 50; if(state.perks.includes('p1')) reward *= 1.2;
        state.gold += Math.round(reward);
        state.skills[q.cat].xp += 25;
        if(state.skills[q.cat].xp >= 100) { state.skills[q.cat].xp = 0; state.skills[q.cat].lvl++; }
        save();
    };

    window.setupPiggy = () => {
        const t = prompt("–ù–∞ —á—Ç–æ –∫–æ–ø–∏—Ç–µ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏?");
        const g = parseInt(prompt("–ö–∞–∫–∞—è –∏—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞?"));
        if(t && g) { state.piggy = { active: true, title: t, goal: g, current: 0 }; save(); }
    };

    window.depositPiggy = () => {
        const a = parseInt(prompt("–°–∫–æ–ª—å–∫–æ –≤—ã –æ—Ç–ª–æ–∂–∏–ª–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏?"));
        if(a > 0) {
            state.piggy.current += a;
            state.skills.money.xp += 20; // –ë–æ–Ω—É—Å –∫ –Ω–∞–≤—ã–∫—É –∑–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É
            if(state.skills.money.xp >= 100) { state.skills.money.xp = 0; state.skills.money.lvl++; }
            save();
        }
    };

    window.resetPiggy = () => { if(confirm("–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Ü–µ–ª—å?")) { state.piggy.active = false; save(); } };

    window.handleGear = (id) => {
        if(state.inventory.includes(id)) {
            const slot = GEAR_DATA[id].slot;
            state.equipped[slot] = state.equipped[slot] === id ? null : id;
        } else if(state.gold >= GEAR_DATA[id].price) {
            state.gold -= GEAR_DATA[id].price; state.inventory.push(id);
        }
        save();
    };

    window.buyPerk = (id, price) => {
        if(state.gold >= price) { state.gold -= price; state.perks.push(id); save(); }
    };

    window.showTab = (t) => {
        document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    };

    render();
</script>
</body>
</html>
