<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero RPG v33: Final Integration</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #0a0a14;
            --glass: rgba(255, 255, 255, 0.07);
            --accent: #4deeea;
            --hp: #ff4d4d;
            --gold: #ffb347;
            --ai: #bc13fe;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background: var(--bg); color: #fff; font-family: -apple-system, system-ui, sans-serif;
            margin: 0; padding: 15px; padding-bottom: 110px; min-height: 100vh;
        }

        .glass {
            background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; padding: 20px; margin-bottom: 15px;
        }

        /* –ì–µ—Ä–æ–π –í–∏–∑—É–∞–ª */
        .hero-view {
            width: 140px; height: 140px; margin: 0 auto 15px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            position: relative; background: rgba(255,255,255,0.02); transition: 0.5s;
        }
        .avatar-main { font-size: 60px; z-index: 5; }
        .slot { position: absolute; font-size: 38px; z-index: 6; }
        #slot-h { top: -15px; left: 50%; transform: translateX(-50%); }
        #slot-w { bottom: 10px; right: -10px; }

        /* –ü–æ–ª–æ—Å–∫–∏ */
        .bar-wrap { height: 10px; background: rgba(0,0,0,0.3); border-radius: 20px; margin: 10px 0; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 20px; transition: width 0.8s ease; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 20px; scrollbar-width: none; }
        .nav::-webkit-scrollbar { display: none; }
        .nav-btn {
            background: var(--glass); border: 1px solid rgba(255,255,255,0.1);
            color: #fff; padding: 12px 20px; border-radius: 18px; white-space: nowrap; font-size: 13px;
        }
        .nav-btn.active { background: #fff; color: #000; font-weight: bold; }

        /* –ó–∞–¥–∞—á–∏ */
        .task-row {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--glass); padding: 16px; border-radius: 22px; margin-bottom: 12px;
        }
        .task-row.done { opacity: 0.3; filter: grayscale(1); }

        .btn-prime {
            width: 100%; padding: 18px; border-radius: 22px; border: none;
            background: #fff; color: #000; font-weight: 800; font-size: 15px;
        }

        input, select { width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: #fff; }
        .hidden { display: none !important; }
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: center; padding: 25px; }
    </style>
</head>
<body>

    <div id="loading" style="position:fixed; inset:0; background:#0a0a14; z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div style="font-weight:900; color:var(--accent); margin-bottom:20px; letter-spacing:4px;">SYNCING_DATABASE...</div>
        <div style="width:200px; height:2px; background:rgba(255,255,255,0.05);"><div id="load-bar" style="width:0%; height:100%; background:#fff; transition:0.3s;"></div></div>
    </div>

    <div class="glass" style="text-align: center;">
        <div style="display:flex; justify-content:space-between; font-size:11px; opacity:0.6; margin-bottom:15px;">
            <span id="rank">–ê–ù–ê–õ–ò–ó...</span>
            <span>LVL <span id="total-lvl">1</span></span>
        </div>
        <div class="hero-view" id="aura">
            <span id="slot-h" class="slot"></span>
            <div class="avatar-main">üë∂</div>
            <span id="slot-w" class="slot"></span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-top:20px; font-weight:900;">
            <span style="color:var(--hp);">‚ù§ <span id="hp-val">100</span></span>
            <span style="color:var(--gold);">üí∞ <span id="gold-val">0</span></span>
        </div>
        <div class="bar-wrap"><div id="hp-fill" class="bar-fill" style="background:var(--hp); width:100%;"></div></div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="tab(event, 'tasks')">–ö–í–ï–°–¢–´</button>
        <button class="nav-btn" onclick="tab(event, 'ai')">üîÆ –û–†–ê–ö–£–õ</button>
        <button class="nav-btn" onclick="tab(event, 'shop')">–ê–†–°–ï–ù–ê–õ</button>
        <button class="nav-btn" onclick="tab(event, 'stats')">–ì–ï–†–û–ô</button>
        <button class="nav-btn" onclick="tab(event, 'import')">–ò–ú–ü–û–†–¢</button>
    </div>

    <div id="v-tasks"><div id="task-list"></div><button class="btn-prime" onclick="openModal()">+ –ù–û–í–´–ô –ö–í–ï–°–¢</button></div>

    <div id="v-ai" class="hidden">
        <div class="glass" style="border-left: 4px solid var(--ai);">
            <h3>–û—Ä–∞–∫—É–ª –°–∏—Å—Ç–µ–º—ã</h3>
            <p id="ai-text" style="font-size:14px; line-height:1.6;">–ì–æ—Ç–æ–≤ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–≤–æ–π –ø—É—Ç—å...</p>
            <button class="btn-prime" style="background:var(--ai); color:#fff;" onclick="askAI()">–ê–ù–ê–õ–ò–ó –°–£–î–¨–ë–´</button>
        </div>
    </div>

    <div id="v-shop" class="hidden">
        <div class="glass"><h4>–≠–ö–ò–ü–ò–†–û–í–ö–ê</h4><div id="list-gear"></div><h4 style="margin-top:20px;">–ü–ï–†–ö–ò</h4><div id="list-perks"></div></div>
    </div>

    <div id="v-stats" class="hidden">
        <div id="skills-list"></div>
        <div class="glass" id="piggy-ui"></div>
    </div>

    <div id="v-import" class="hidden">
        <div class="glass">
            <h3>–ò–º–ø–æ—Ä—Ç .ics</h3>
            <input type="file" id="file-input" accept=".ics" style="display:none;">
            <button class="btn-prime" onclick="document.getElementById('file-input').click()">–í–´–ë–†–ê–¢–¨ –§–ê–ô–õ</button>
            <button class="btn-prime" id="run-import" style="margin-top:10px; background:var(--accent); display:none;" onclick="processICS()">–ó–ê–ì–†–£–ó–ò–¢–¨</button>
        </div>
    </div>

    <div id="modal">
        <div class="glass" style="width:100%; max-width:400px;">
            <h3 id="m-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</h3>
            <input type="text" id="m-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ...">
            <div style="display:flex; gap:10px;"><input type="time" id="m-start"><input type="time" id="m-end"></div>
            <select id="m-day">
                <option value="0">–ü–Ω</option><option value="1">–í—Ç</option><option value="2">–°—Ä</option><option value="3">–ß—Ç</option><option value="4">–ü—Ç</option><option value="5">–°–±</option><option value="6">–í—Å</option>
            </select>
            <select id="m-cat"><option value="money">üí∞ –§–∏–Ω–∞–Ω—Å—ã</option><option value="education">üìö –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç</option><option value="health">üí™ –ó–¥–æ—Ä–æ–≤—å–µ</option></select>
            <div style="display:flex; gap:10px;">
                <button class="btn-prime" style="flex:2;" onclick="saveQuest()">–°–û–•–†–ê–ù–ò–¢–¨</button>
                <button id="m-del" class="btn-prime" style="flex:1; background:var(--hp); color:#fff;" onclick="deleteQuest()">–£–î–ê–õ–ò–¢–¨</button>
            </div>
            <button onclick="closeModal()" style="width:100%; background:none; border:none; color:#777; margin-top:15px;">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    const API_KEY = "AIzaSyBuhO4FzG96_z2t97pp0ySDXdj5KroVKfY";
    
    let state = {
        gold: 0, hp: 100, lastDate: new Date().toDateString(),
        skills: { money: {lvl:1, xp:0}, education: {lvl:1, xp:0}, health: {lvl:1, xp:0} },
        quests: [], inventory: [], perks: [],
        equipped: { head: null, weapon: null },
        piggy: { active: false, title: '', goal: 0, curr: 0 },
        editIdx: -1
    };

    const DB = {
        gear: {
            'h1': { n: '–®–ª–µ–º', i: 'ü™ñ', p: 500, s: 'head' },
            'h2': { n: '–ö–æ—Ä–æ–Ω–∞', i: 'üëë', p: 3000, s: 'head' },
            'w1': { n: '–ú–µ—á', i: 'üó°Ô∏è', p: 800, s: 'weapon' }
        },
        perks: {
            'boost': { n: '–ú–∞–π–Ω–µ—Ä', d: '+20% –∑–æ–ª–æ—Ç–∞', p: 1200 },
            'def': { n: '–§–∞–π–µ—Ä–≤–æ–ª', d: '-50% —É—Ä–æ–Ω–∞', p: 2000 }
        }
    };

    function init() {
        tg.ready(); tg.expand();
        let p = 0; const l = setInterval(() => { p+=10; document.getElementById('load-bar').style.width=p+'%'; if(p>=100) clearInterval(l); }, 50);

        tg.CloudStorage.getItem('rpg_v33_final', (err, val) => {
            if(!err && val) { try { state = JSON.parse(val); } catch(e){} }
            else { const loc = localStorage.getItem('rpg_v33_final'); if(loc) state = JSON.parse(loc); }
            checkPenalty(); render();
            setTimeout(() => document.getElementById('loading').style.display='none', 600);
        });
    }

    function save() {
        const s = JSON.stringify(state);
        localStorage.setItem('rpg_v33_final', s);
        tg.CloudStorage.setItem('rpg_v33_final', s);
        render();
    }

    function checkPenalty() {
        const today = new Date().toDateString();
        if(state.lastDate !== today) {
            const yesterday = (new Date().getDay() + 5) % 7;
            const missed = state.quests.filter(q => parseInt(q.day) === yesterday && !q.done);
            if(missed.length > 0) {
                let dmg = missed.length * 15;
                if(state.perks.includes('def')) dmg = Math.floor(dmg/2);
                state.hp = Math.max(0, state.hp - dmg);
            }
            state.quests.forEach(q => q.done = false);
            state.lastDate = today; save();
        }
    }

    function render() {
        document.getElementById('gold-val').innerText = state.gold;
        document.getElementById('hp-val').innerText = state.hp;
        document.getElementById('hp-fill').style.width = state.hp + '%';

        let total = 0; for(let s in state.skills) total += state.skills[s].lvl;
        document.getElementById('total-lvl').innerText = total;
        document.getElementById('rank').innerText = total > 15 ? "–ì–ï–†–û–ô" : "–ù–û–í–ò–ß–û–ö";
        
        const aura = document.getElementById('aura');
        aura.style.boxShadow = total > 10 ? "0 0 30px var(--accent)" : "none";

        document.getElementById('slot-h').innerText = state.equipped.head ? DB.gear[state.equipped.head].i : '';
        document.getElementById('slot-w').innerText = state.equipped.weapon ? DB.gear[state.equipped.weapon].i : '';

        const todayIdx = (new Date().getDay() + 6) % 7;
        const qToday = state.quests.filter(q => parseInt(q.day) === todayIdx);
        document.getElementById('task-list').innerHTML = qToday.map(q => {
            const gIdx = state.quests.indexOf(q);
            return `<div class="task-row ${q.done?'done':''}">
                <div onclick="openModal(${gIdx})"><b>${q.title}</b><br><small>${q.start||'--'} - ${q.end||'--'}</small></div>
                ${q.done ? '‚úÖ' : `<button onclick="doneQ(${gIdx})" style="padding:10px; border-radius:10px; border:none; background:#fff; font-weight:bold;">OK</button>`}
            </div>`;
        }).join('') || '<p style="text-align:center; opacity:0.3;">–ó–∞–¥–∞—á –Ω–µ—Ç</p>';

        renderShop(); renderStats(); renderPiggy();
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    window.tab = (e, n) => {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('[id^="v-"]').forEach(v => v.classList.add('hidden'));
        document.getElementById('v-'+n).classList.remove('hidden');
    };

    window.openModal = (idx = -1) => {
        state.editIdx = idx;
        const m = document.getElementById('modal');
        if(idx === -1) {
            document.getElementById('m-title').innerText = "–ù–æ–≤—ã–π –∫–≤–µ—Å—Ç";
            document.getElementById('m-name').value = "";
            document.getElementById('m-del').classList.add('hidden');
        } else {
            const q = state.quests[idx];
            document.getElementById('m-title').innerText = "–ò–∑–º–µ–Ω–∏—Ç—å";
            document.getElementById('m-name').value = q.title;
            document.getElementById('m-start').value = q.start;
            document.getElementById('m-end').value = q.end;
            document.getElementById('m-day').value = q.day;
            document.getElementById('m-cat').value = q.cat;
            document.getElementById('m-del').classList.remove('hidden');
        }
        m.style.display = 'flex';
    };

    window.closeModal = () => document.getElementById('modal').style.display = 'none';

    window.saveQuest = () => {
        const name = document.getElementById('m-name').value; if(!name) return;
        const data = {
            title: name, start: document.getElementById('m-start').value,
            end: document.getElementById('m-end').value, day: document.getElementById('m-day').value,
            cat: document.getElementById('m-cat').value, done: state.editIdx > -1 ? state.quests[state.editIdx].done : false
        };
        if(state.editIdx > -1) state.quests[state.editIdx] = data;
        else state.quests.push(data);
        closeModal(); save();
    };

    window.deleteQuest = () => { state.quests.splice(state.editIdx, 1); closeModal(); save(); };

    window.doneQ = (i) => {
        const q = state.quests[i]; q.done = true;
        state.gold += state.perks.includes('boost') ? 65 : 50;
        state.skills[q.cat].xp += 25;
        if(state.skills[q.cat].xp >= 100) { state.skills[q.cat].xp = 0; state.skills[q.cat].lvl++; }
        tg.HapticFeedback.notificationOccurred('success'); save();
    };

    function renderShop() {
        let h = ""; for(let k in DB.gear) {
            const it = DB.gear[k]; const has = state.inventory.includes(k); const eq = state.equipped[it.s] === k;
            h += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>${it.i} ${it.n}</span>
                <button onclick="toggleGear('${k}')" style="background:${has?(eq?'var(--hp)':'var(--accent)'):'#444'}; border:none; padding:5px 12px; border-radius:10px; font-weight:bold;">${has?(eq?'–°–ù–Ø–¢–¨':'–û–î–ï–¢–¨'):it.p}</button>
            </div>`;
        }
        document.getElementById('list-gear').innerHTML = h;

        let ph = ""; for(let k in DB.perks) {
            const p = DB.perks[k]; const has = state.perks.includes(k);
            ph += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>${p.n} <small style="opacity:0.5">${p.d}</small></span>
                <button onclick="buyPerk('${k}')" ${has?'disabled':''} style="background:${has?'#222':'var(--accent)'}; border:none; padding:5px 12px; border-radius:10px; font-weight:bold;">${has?'V':p.p}</button>
            </div>`;
        }
        document.getElementById('list-perks').innerHTML = ph;
    }

    function renderStats() {
        document.getElementById('skills-list').innerHTML = Object.keys(state.skills).map(k => `
            <div class="glass" style="padding:15px;">
                <div style="display:flex; justify-content:space-between; font-size:12px;"><span>${k.toUpperCase()}</span><span>LVL ${state.skills[k].lvl}</span></div>
                <div class="bar-wrap"><div class="bar-fill" style="background:var(--accent); width:${state.skills[k].xp}%;"></div></div>
            </div>`).join('');
    }

    function renderPiggy() {
        const p = state.piggy; const ui = document.getElementById('piggy-ui');
        if(!p.active) ui.innerHTML = `<h3>–ö–æ–ø–∏–ª–∫–∞</h3><button class="btn-prime" onclick="initPiggy()">–ù–û–í–ê–Ø –¶–ï–õ–¨</button>`;
        else {
            const pct = Math.min(100, (p.curr/p.goal)*100);
            ui.innerHTML = `<h3>${p.title}</h3><small>${p.curr} / ${p.goal}</small>
            <div class="bar-wrap"><div class="bar-fill" style="background:var(--gold); width:${pct}%;"></div></div>
            <button class="btn-prime" onclick="addGoldPiggy()">–ü–û–ü–û–õ–ù–ò–¢–¨</button>`;
        }
    }

    window.toggleGear = (k) => {
        const it = DB.gear[k];
        if(state.inventory.includes(k)) state.equipped[it.s] = state.equipped[it.s] === k ? null : k;
        else if(state.gold >= it.p) { state.gold -= it.p; state.inventory.push(k); state.equipped[it.s] = k; }
        save();
    };

    window.buyPerk = (k) => { if(state.gold >= DB.perks[k].p) { state.gold -= DB.perks[k].p; state.perks.push(k); save(); } };
    window.initPiggy = () => { const t = prompt('–¶–µ–ª—å:'); const g = parseInt(prompt('–°—É–º–º–∞:')); if(t && g) { state.piggy = { active: true, title: t, goal: g, curr: 0 }; save(); } };
    window.addGoldPiggy = () => { const v = parseInt(prompt('–°—É–º–º–∞:')); if(v > 0 && state.gold >= v) { state.gold -= v; state.piggy.curr += v; state.skills.money.xp += 15; save(); } };

    // AI & Import
    async function askAI() {
        const t = document.getElementById('ai-text'); t.innerText = "–û—Ä–∞–∫—É–ª –≤–≥–ª—è–¥—ã–≤–∞–µ—Ç—Å—è –≤ —ç—Ñ–∏—Ä...";
        const tasks = state.quests.filter(q => !q.done).map(q => q.title).join(', ');
        const prompt = `–ó–∞–¥–∞—á–∏: ${tasks}. –ù–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–∏–π RPG-—Å–æ–≤–µ—Ç (2 —Ñ—Ä–∞–∑—ã).`;
        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const d = await r.json(); t.innerText = d.candidates[0].content.parts[0].text;
        } catch(e) { t.innerText = "–ú–∞–≥–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞."; }
    }

    document.getElementById('file-input').addEventListener('change', (e) => { if(e.target.files[0]) document.getElementById('run-import').style.display='block'; });
    window.processICS = () => {
        const f = document.getElementById('file-input').files[0]; const r = new FileReader();
        r.onload = (e) => {
            const lines = e.target.result.split('\n'); let c = 0; let cur = null;
            lines.forEach(l => {
                if(l.includes('BEGIN:VEVENT')) cur = {};
                if(l.includes('SUMMARY:')) cur.title = l.replace('SUMMARY:', '').trim();
                if(l.includes('DTSTART')) {
                    const t = l.match(/T(\d{2})(\d{2})/); if(t) cur.start = `${t[1]}:${t[2]}`;
                    const d = l.match(/(\d{4})(\d{2})(\d{2})/); if(d) cur.day = (new Date(d[1], d[2]-1, d[3]).getDay() + 6) % 7;
                }
                if(l.includes('END:VEVENT')) { cur.done = false; cur.cat = 'education'; state.quests.push(cur); c++; }
            });
            alert("–ò–º–ø–æ—Ä—Ç: " + c); save(); tab(null, 'tasks');
        };
        r.readAsText(f);
    };

    init();
</script>
</body>
</html>
