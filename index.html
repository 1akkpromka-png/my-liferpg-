<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero RPG: Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –ù–ê–°–¢–†–û–ô–ö–ò –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï --- */
        :root {
            /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ */
            --bg-dark: #0f0c29;
            --bg-light: #302b63;
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            
            --card-bg: rgba(255, 255, 255, 0.08);
            --card-border: rgba(255, 255, 255, 0.1);
            
            --text-main: #ffffff;
            --text-muted: #b0b0b0;
            
            --btn-primary: #3390ec;
            --gold: #ffd700;
            --hp: #ff4757;
            --piggy: #2ecc71;
            --accent: #00d2ff;
            
            /* –†–∞–Ω–≥–∏ —Å–≤–µ—á–µ–Ω–∏—è */
            --glow-common: 0 0 15px rgba(255,255,255,0.2);
            --glow-rare: 0 0 20px rgba(51, 144, 236, 0.6);
            --glow-epic: 0 0 25px rgba(255, 215, 0, 0.6);
            --glow-legend: 0 0 35px rgba(180, 50, 255, 0.8);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg-gradient);
            background-attachment: fixed; /* –§–æ–Ω –Ω–µ –¥–≤–∏–≥–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ */
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
            padding-bottom: 110px;
            min-height: 100vh;
        }

        /* --- –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò --- */
        #loader {
            position: fixed; inset: 0; background: var(--bg-dark); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            transition: opacity 0.5s;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--btn-primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- –ê–ù–ò–ú–ê–¶–ò–ò --- */
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        
        .particle {
            position: fixed; pointer-events: none; z-index: 10000;
            animation: fly-away 0.8s ease-out forwards;
            font-size: 24px; font-weight: bold; color: var(--gold);
        }
        @keyframes fly-away {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--mx), var(--my)) scale(1.5); }
        }

        /* --- UI –≠–õ–ï–ú–ï–ù–¢–´ --- */
        .card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--card-border);
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }

        /* –ê—É—Ä–∞ –≥–µ—Ä–æ—è */
        .hero-avatar-container {
            position: relative;
            display: inline-block;
            margin: 15px 0;
            padding: 15px;
            border-radius: 50%;
            transition: box-shadow 0.5s ease;
            animation: float 3s ease-in-out infinite;
        }
        .hero-row {
            display: flex; justify-content: center; align-items: center;
            font-size: 50px; height: 60px;
        }

        .bar-container {
            background: rgba(0,0,0,0.5); height: 10px; border-radius: 6px;
            margin: 10px 0; overflow: hidden; position: relative;
        }
        .bar-fill {
            height: 100%; border-radius: 6px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        /* –ë–ª–∏–∫ –Ω–∞ –ø–æ–ª–æ—Å–∫–µ */
        .bar-fill::after {
            content: ''; position: absolute; top:0; left:0; right:0; bottom:0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: skewX(-20deg);
        }

        /* --- –¢–ê–ë–´ --- */
        .tabs {
            display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto;
            padding: 4px; scrollbar-width: none;
        }
        .tab-btn {
            padding: 12px 18px; border-radius: 14px;
            background: rgba(255,255,255,0.05); color: var(--text-muted);
            border: 1px solid rgba(255,255,255,0.05);
            font-size: 13px; font-weight: 700; white-space: nowrap;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background: var(--btn-primary); color: white;
            box-shadow: 0 0 15px rgba(51, 144, 236, 0.4);
            border-color: var(--btn-primary);
        }

        /* --- –ö–í–ï–°–¢–´ --- */
        .quest-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: rgba(255,255,255,0.03);
            border-radius: 18px; margin-bottom: 12px;
            border-left: 4px solid var(--btn-primary);
        }
        .quest-item.completed { opacity: 0.5; filter: grayscale(1); border-color: #555; }
        .quest-meta { font-size: 11px; color: var(--accent); font-weight: 700; margin-bottom: 4px; display: block; }
        
        /* --- –ö–ù–û–ü–ö–ò --- */
        .btn-main {
            background: var(--btn-primary); color: white; border: none;
            padding: 16px; border-radius: 16px; width: 100%;
            font-weight: 800; font-size: 16px; margin-top: 10px;
            box-shadow: 0 4px 15px rgba(51,144,236,0.3);
            cursor: pointer;
        }
        .btn-action {
            padding: 8px 14px; border-radius: 10px; border: none;
            font-weight: 700; font-size: 12px; cursor: pointer;
        }

        /* --- –ú–ê–ì–ê–ó–ò–ù --- */
        .shop-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        /* --- –ú–û–î–ê–õ–ö–ê --- */
        #modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 2000; display: none; padding: 20px;
            animation: fadeIn 0.2s;
        }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
        
        input, select {
            width: 100%; padding: 14px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1); color: white;
            font-size: 16px; margin-bottom: 15px; outline: none;
        }
        label { display: block; margin-bottom: 8px; font-size: 12px; color: var(--text-muted); font-weight: bold; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div style="font-size:14px; opacity:0.7">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±–ª–∞–∫–æ–º...</div>
</div>

<div class="card" style="text-align: center; position: relative; overflow: hidden;">
    <div style="position: absolute; top: -50px; left: -50px; width: 150px; height: 150px; background: var(--btn-primary); filter: blur(80px); opacity: 0.2;"></div>
    
    <div id="hero-rank" style="font-size: 10px; font-weight: 900; letter-spacing: 3px; color: var(--accent); margin-bottom: 5px;">–ù–û–í–ò–ß–û–ö</div>
    
    <div id="aura-container" class="hero-avatar-container">
        <div class="hero-row">
            <span id="vis-head" style="font-size:40px; transform: translateX(10px) translateY(-5px);"></span>
            <span id="vis-body" style="z-index: 2;">üë∂</span>
            <span id="vis-weap" style="font-size:40px; transform: translateX(-10px) translateY(-5px) scaleX(-1);"></span>
        </div>
    </div>

    <div style="font-size: 22px; font-weight: 800; margin-bottom: 10px;">
        Lvl <span id="total-lvl">1</span>
    </div>

    <div style="display: flex; justify-content: space-between; padding: 0 10px; font-size: 13px; font-weight: 700;">
        <span>‚ù§Ô∏è HP <span id="hp-val">100</span></span>
        <span style="color: var(--gold);">üí∞ <span id="gold-val">0</span></span>
    </div>
    <div class="bar-container">
        <div id="hp-bar" class="bar-fill" style="background: var(--hp); width: 100%;"></div>
    </div>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('tasks')">–ó–ê–î–ê–ß–ò</button>
    <button class="tab-btn" onclick="switchTab('piggy')">–ö–û–ü–ò–õ–ö–ê</button>
    <button class="tab-btn" onclick="switchTab('shop')">–ú–ê–ì–ê–ó–ò–ù</button>
    <button class="tab-btn" onclick="switchTab('hero')">–ü–†–û–§–ò–õ–¨</button>
</div>

<div id="tab-tasks">
    <div id="quest-list"></div>
    <button class="btn-main" onclick="openModal()">Ôºã –ù–û–í–´–ô –ö–í–ï–°–¢</button>
</div>

<div id="tab-piggy" class="hidden">
    <div class="card" style="border: 1px solid var(--piggy); background: linear-gradient(160deg, rgba(46,204,113,0.1), transparent);">
        <h3 style="margin-top:0; color: var(--piggy);">üí∞ –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Ü–µ–ª—å</h3>
        <div id="piggy-ui"></div>
    </div>
</div>

<div id="tab-shop" class="hidden">
    <div class="card">
        <h4 style="margin:0 0 15px; color:var(--accent); text-transform:uppercase;">üõ°Ô∏è –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</h4>
        <div id="shop-gear"></div>
        
        <div style="height:1px; background:rgba(255,255,255,0.1); margin: 20px 0;"></div>
        
        <h4 style="margin:0 0 15px; color:var(--gold); text-transform:uppercase;">‚ö° –¢–∞–ª–∞–Ω—Ç—ã (–ü–µ—Ä–∫–∏)</h4>
        <div id="shop-perks"></div>
    </div>
</div>

<div id="tab-hero" class="hidden">
    <div id="skills-list"></div>
    <div class="card" style="margin-top:20px;">
        <h4 style="margin:0 0 15px; opacity:0.7">üìÖ –ü–õ–ê–ù –ù–ê –ù–ï–î–ï–õ–Æ</h4>
        <div id="week-calendar"></div>
    </div>
</div>

<div id="modal-overlay">
    <h2 style="margin-top:0">–°–æ–∑–¥–∞–Ω–∏–µ –∫–≤–µ—Å—Ç–∞</h2>
    <input type="text" id="inp-title" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
    
    <label>–í—Ä–µ–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
    <div style="display:flex; gap:10px">
        <input type="time" id="inp-start">
        <input type="time" id="inp-end">
    </div>

    <label>–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏</label>
    <select id="inp-day">
        <option value="0">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option><option value="1">–í—Ç–æ—Ä–Ω–∏–∫</option>
        <option value="2">–°—Ä–µ–¥–∞</option><option value="3">–ß–µ—Ç–≤–µ—Ä–≥</option>
        <option value="4">–ü—è—Ç–Ω–∏—Ü–∞</option><option value="5">–°—É–±–±–æ—Ç–∞</option><option value="6">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
    </select>

    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
    <select id="inp-cat" onchange="toggleCustomInput(this.value)">
        <option value="money">üí∞ –î–µ–Ω—å–≥–∏</option>
        <option value="education">üéì –û–±—É—á–µ–Ω–∏–µ</option>
        <option value="health">üí™ –ó–¥–æ—Ä–æ–≤—å–µ</option>
    </select>
    
    <input type="text" id="inp-custom" class="hidden" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...">

    <button class="btn-main" onclick="saveTask()">–°–û–•–†–ê–ù–ò–¢–¨</button>
    <button onclick="closeModal()" style="width:100%; padding:15px; background:none; border:none; color:#aaa; font-weight:bold;">–û–¢–ú–ï–ù–ê</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –ö–û–ù–°–¢–ê–ù–¢–´
    const DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
    const DB = {
        gear: {
            'h1': { name:'–®–ª–µ–º —Ä—ã—Ü–∞—Ä—è', icon:'ü™ñ', price:500, slot:'head' },
            'h2': { name:'–ö–æ—Ä–æ–Ω–∞', icon:'üëë', price:2500, slot:'head' },
            'w1': { name:'–ú–µ—á', icon:'üó°Ô∏è', price:800, slot:'weapon' },
            'w2': { name:'–ü–æ—Å–æ—Ö', icon:'ü™Ñ', price:1200, slot:'weapon' },
            'w3': { name:'–°–µ–∫–∏—Ä–∞', icon:'ü™ì', price:1500, slot:'weapon' }
        },
        perks: {
            'gold_boost': { name:'–ê–ª—á–Ω–æ—Å—Ç—å', desc:'+20% –∑–æ–ª–æ—Ç–∞ –∑–∞ –∑–∞–¥–∞—á–∏', price:1000 },
            'shield': { name:'–≠–≥–∏–¥–∞', desc:'-50% —É—Ä–æ–Ω–∞ –æ—Ç –ø—Ä–æ–ø—É—Å–∫–æ–≤', price:1500 }
        }
    };

    // –°–¢–ï–ô–¢
    let state = {
        gold: 0, hp: 100, lastLogin: new Date().toDateString(),
        skills: { money:{lvl:1, xp:0}, education:{lvl:1, xp:0}, health:{lvl:1, xp:0} },
        quests: [], inventory: [], perks: [],
        equipped: { head:null, weapon:null },
        piggy: { active:false, goal:0, current:0, title:'' }
    };

    // --- –û–ë–õ–ê–ß–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï ---
    function initApp() {
        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞
        tg.CloudStorage.getItem('hero_v20_save', (err, value) => {
            if (!err && value) {
                try {
                    const cloudState = JSON.parse(value);
                    // –ú–µ—Ä–¥–∂–∏–º —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –Ω–∞ —Å–ª—É—á–∞–π –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π
                    state = { ...state, ...cloudState };
                    console.log("Loaded from Cloud");
                } catch(e) { console.error(e); }
            } else {
                // –§–æ–ª–±—ç–∫ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–µ
                const local = localStorage.getItem('hero_v20_save');
                if(local) state = JSON.parse(local);
                console.log("Loaded from Local");
            }

            // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ª–æ–≥–∏–∫—É
            checkDailyPenalty();
            renderAll();
            
            // –£–±–∏—Ä–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => document.getElementById('loader').style.display='none', 500);
        });
    }

    function save() {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª–∫—É (–±—ã—Å—Ç—Ä–æ)
        localStorage.setItem('hero_v20_save', JSON.stringify(state));
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±–ª–∞–∫–æ (–Ω–∞–¥–µ–∂–Ω–æ)
        tg.CloudStorage.setItem('hero_v20_save', JSON.stringify(state), (err, succ) => {
            if(err) console.error("Cloud Error", err);
        });
        
        renderAll();
    }

    // --- –õ–û–ì–ò–ö–ê ---
    function checkDailyPenalty() {
        const today = new Date().toDateString();
        if(state.lastLogin !== today) {
            const yestIdx = (new Date().getDay() + 5) % 7;
            const missed = state.quests.filter(q => parseInt(q.day) === yestIdx && !q.done);
            
            if(missed.length > 0) {
                let dmg = missed.length * 15;
                if(state.perks.includes('shield')) dmg = Math.floor(dmg/2);
                state.hp = Math.max(0, state.hp - dmg);
                tg.showAlert(`‚ö†Ô∏è –ù–æ–≤—ã–π –¥–µ–Ω—å!\n–ü—Ä–æ–ø—É—â–µ–Ω–æ –∑–∞–¥–∞—á: ${missed.length}\n–ü–æ–ª—É—á–µ–Ω–æ —É—Ä–æ–Ω–∞: ${dmg}`);
            } else {
                state.hp = Math.min(100, state.hp + 10);
            }
            state.lastLogin = today;
            save();
        }
    }

    // --- –†–ï–ù–î–ï–† ---
    function renderAll() {
        // 1. –°—Ç–∞—Ç—ã
        document.getElementById('gold-val').innerText = state.gold;
        document.getElementById('hp-val').innerText = state.hp;
        document.getElementById('hp-bar').style.width = state.hp + '%';

        // 2. –ê–≤–∞—Ç–∞—Ä –∏ –ê—É—Ä–∞ (–í–∏–∑—É–∞–ª—å–Ω—ã–π –∞–ø–≥—Ä–µ–π–¥)
        let totalLvl = Object.values(state.skills).reduce((a,b)=>a+b.lvl, 0);
        document.getElementById('total-lvl').innerText = totalLvl;
        
        let rank = "–ù–û–í–ò–ß–û–ö";
        let skin = "üë∂";
        let aura = "var(--glow-common)";
        
        if(totalLvl > 5) { rank="–ò–°–ö–ê–¢–ï–õ–¨"; skin="üèπ"; aura="var(--glow-rare)"; }
        if(totalLvl > 15) { rank="–í–û–ò–ù"; skin="‚öîÔ∏è"; aura="var(--glow-epic)"; }
        if(totalLvl > 30) { rank="–õ–ï–ì–ï–ù–î–ê"; skin="ü¶∏"; aura="var(--glow-legend)"; }
        
        document.getElementById('hero-rank').innerText = rank;
        document.getElementById('vis-body').innerText = skin;
        document.getElementById('vis-head').innerText = state.equipped.head ? DB.gear[state.equipped.head].icon : '';
        document.getElementById('vis-weap').innerText = state.equipped.weapon ? DB.gear[state.equipped.weapon].icon : '';
        document.getElementById('aura-container').style.boxShadow = aura;

        // 3. –ó–∞–¥–∞—á–∏
        const todayIdx = (new Date().getDay() + 6) % 7;
        const tasks = state.quests.filter(q => parseInt(q.day) === todayIdx);
        tasks.sort((a,b) => (a.start||'99').localeCompare(b.start||'99'));
        
        document.getElementById('quest-list').innerHTML = tasks.map((q, i) => {
            const gIdx = state.quests.indexOf(q);
            return `
            <div class="quest-item ${q.done?'completed':''}">
                <div>
                    ${q.start ? `<span class="quest-meta">‚è∞ ${q.start}-${q.end||''}</span>` : ''}
                    <b>${q.title}</b>
                    <span style="font-size:10px; opacity:0.6; text-transform:uppercase;">${q.cat}</span>
                </div>
                ${q.done ? 
                    `<button class="btn-action" style="background:rgba(255,255,255,0.1)" onclick="delQuest(${gIdx})">üóëÔ∏è</button>` : 
                    `<button class="btn-action" style="background:var(--btn-primary); color:white" onclick="doQuest(event, ${gIdx})">‚úì</button>`
                }
            </div>`;
        }).join('') || '<div style="text-align:center; opacity:0.5; padding:20px;">–ù–µ—Ç –∑–∞–¥–∞—á –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</div>';

        // 4. –ö–æ–ø–∏–ª–∫–∞
        const p = state.piggy;
        if(p.active) {
            const pct = Math.min(100, (p.current/p.goal)*100);
            document.getElementById('piggy-ui').innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <b>${p.title}</b><span>${p.current}/${p.goal}</span>
                </div>
                <div class="bar-container"><div class="bar-fill" style="width:${pct}%; background:var(--piggy)"></div></div>
                <button class="btn-main" style="background:var(--piggy); margin-bottom:10px" onclick="addMoney()">‚ûï –í–ù–ï–°–¢–ò</button>
                <button onclick="delPiggy()" style="border:none; background:none; color:#777; width:100%">–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å</button>
            `;
        } else {
            document.getElementById('piggy-ui').innerHTML = `<button class="btn-main" onclick="newPiggy()">üéØ –°–û–ó–î–ê–¢–¨ –¶–ï–õ–¨</button>`;
        }

        // 5. –ú–∞–≥–∞–∑–∏–Ω
        renderShop();

        // 6. –ù–∞–≤—ã–∫–∏
        document.getElementById('skills-list').innerHTML = Object.keys(state.skills).map(k => `
            <div class="card" onclick="tryDelSkill('${k}')">
                <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:5px;">
                    <span style="text-transform:uppercase">${k} (Lvl ${state.skills[k].lvl})</span>
                    <span>${state.skills[k].xp}%</span>
                </div>
                <div class="bar-container"><div class="bar-fill" style="width:${state.skills[k].xp}%; background:var(--btn-primary)"></div></div>
            </div>
        `).join('');
        
        // 7. –ö–∞–ª–µ–Ω–¥–∞—Ä—å
        let weekHTML = '';
        DAYS.forEach((d,i)=>{
            const c = state.quests.filter(q=>parseInt(q.day)===i && !q.done).length;
            if(c>0) weekHTML+=`<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid rgba(255,255,255,0.05); font-size:13px;"><span>${d}</span><span style="color:var(--accent)">${c} –∑–∞–¥–∞—á</span></div>`
        });
        document.getElementById('week-calendar').innerHTML = weekHTML || '<div style="text-align:center; opacity:0.5">–ü—É—Å—Ç–æ</div>';
    }

    function renderShop() {
        const gearHTML = Object.keys(DB.gear).map(k => {
            const i = DB.gear[k];
            const has = state.inventory.includes(k);
            const eq = state.equipped[i.slot] === k;
            return `<div class="shop-row">
                <div style="display:flex; align-items:center; gap:10px;"><span style="font-size:24px">${i.icon}</span><b>${i.name}</b></div>
                <button class="btn-action" style="background:${has?(eq?'var(--hp)':'var(--btn-primary)'):'var(--gold)'; color:${has?'white':'black'}}" onclick="buyGear('${k}')">
                    ${has?(eq?'–°–ù–Ø–¢–¨':'–ù–ê–î–ï–¢–¨'):i.price}
                </button>
            </div>`;
        }).join('');
        document.getElementById('shop-gear').innerHTML = gearHTML;

        const perkHTML = Object.keys(DB.perks).map(k => {
            const i = DB.perks[k];
            const has = state.perks.includes(k);
            return `<div class="shop-row">
                <div><b>${i.name}</b><br><span style="font-size:10px; opacity:0.7">${i.desc}</span></div>
                <button class="btn-action" ${has?'disabled':''} style="background:${has?'#555':'var(--gold)'}; color:${has?'#999':'black'}" onclick="buyPerk('${k}')">
                    ${has?'–ï–°–¢–¨':i.price}
                </button>
            </div>`;
        }).join('');
        document.getElementById('shop-perks').innerHTML = perkHTML;
    }

    // --- –î–ï–ô–°–¢–í–ò–Ø ---
    window.doQuest = (e, idx) => {
        spawnParticles(e.clientX, e.clientY);
        tg.HapticFeedback.notificationOccurred('success'); // –í–ò–ë–†–ê–¶–ò–Ø
        
        const q = state.quests[idx];
        q.done = true;
        
        let reward = 50;
        if(state.perks.includes('gold_boost')) reward = 60;
        state.gold += reward;

        const cat = q.cat;
        if(state.skills[cat]) {
            state.skills[cat].xp += 25;
            if(state.skills[cat].xp >= 100) {
                state.skills[cat].xp = 0;
                state.skills[cat].lvl++;
                tg.showAlert(`üéâ –£—Ä–æ–≤–µ–Ω—å –≤ "${cat}" –ø–æ–≤—ã—à–µ–Ω!`);
            }
        }
        save();
    };

    window.spawnParticles = (x, y) => {
        for(let i=0; i<8; i++) {
            const p = document.createElement('div'); p.className='particle'; p.innerText='üí∞';
            p.style.left=x+'px'; p.style.top=y+'px';
            p.style.setProperty('--mx', (Math.random()-0.5)*200+'px');
            p.style.setProperty('--my', (Math.random()-1)*150+'px');
            document.body.appendChild(p); setTimeout(()=>p.remove(), 800);
        }
    };

    // --- –ú–û–î–ê–õ–ö–ê –ò –°–§–ï–†–´ ---
    window.openModal = () => {
        tg.HapticFeedback.impactOccurred('light');
        const sel = document.getElementById('inp-cat');
        while(sel.options.length > 3) sel.remove(3); // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö
        
        Object.keys(state.skills).forEach(k => {
            if(!['money','education','health'].includes(k)) {
                let o = document.createElement('option'); o.value=k; o.innerText='‚ú® '+k; sel.add(o);
            }
        });
        let o = document.createElement('option'); o.value='_new'; o.innerText='‚ûï –°–≤–æ—è —Å—Ñ–µ—Ä–∞...'; sel.add(o);
        
        document.getElementById('modal-overlay').style.display='block';
    };

    window.toggleCustomInput = (v) => {
        document.getElementById('inp-custom').classList.toggle('hidden', v !== '_new');
    };
    
    window.closeModal = () => document.getElementById('modal-overlay').style.display='none';

    window.saveTask = () => {
        let t = document.getElementById('inp-title').value;
        if(!t) return;
        let c = document.getElementById('inp-cat').value;
        if(c === '_new') {
            c = document.getElementById('inp-custom').value || '–†–∞–∑–Ω–æ–µ';
            if(!state.skills[c]) state.skills[c] = {lvl:1, xp:0};
        }
        state.quests.push({
            title: t,
            start: document.getElementById('inp-start').value,
            end: document.getElementById('inp-end').value,
            day: document.getElementById('inp-day').value,
            cat: c, done: false
        });
        closeModal();
        save();
    };

    window.delQuest = (i) => { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { state.quests.splice(i,1); save(); }};

    // --- –ö–û–ü–ò–õ–ö–ê / –ú–ê–ì–ê–ó–ò–ù / –í–ö–õ–ê–î–ö–ò ---
    window.newPiggy = () => {
        const t = prompt('–¶–µ–ª—å?'); const g = parseInt(prompt('–°—É–º–º–∞?'));
        if(t && g) { state.piggy={active:true, title:t, goal:g, current:0}; save(); }
    };
    window.addMoney = () => {
        const v = parseInt(prompt('–í–Ω–µ—Å–ª–∏ (–º–∏–Ω. 100 –¥–ª—è –æ–ø—ã—Ç–∞)?'));
        if(v) {
            state.piggy.current += v;
            if(v >= 100) {
                state.skills.money.xp += 20;
                if(state.skills.money.xp>=100) {state.skills.money.xp=0; state.skills.money.lvl++};
            }
            save();
        }
    };
    window.delPiggy = () => { if(confirm('–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å?')) { state.piggy.active=false; save(); }};

    window.buyGear = (k) => {
        const i = DB.gear[k];
        if(state.inventory.includes(k)) {
            state.equipped[i.slot] = (state.equipped[i.slot] === k) ? null : k;
        } else if(state.gold >= i.price) {
            state.gold -= i.price; state.inventory.push(k); state.equipped[i.slot] = k;
            tg.HapticFeedback.notificationOccurred('success');
        }
        save();
    };
    window.buyPerk = (k) => {
        if(state.gold >= DB.perks[k].price) {
            state.gold -= DB.perks[k].price; state.perks.push(k); save();
        }
    };

    window.tryDelSkill = (k) => {
        if(['money','education','health'].includes(k)) return;
        if(confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ñ–µ—Ä—É "${k}"?`)) { delete state.skills[k]; save(); }
    };

    window.switchTab = (t) => {
        tg.HapticFeedback.impactOccurred('light');
        document.querySelectorAll('[id^="tab-"]').forEach(e=>e.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    };

    // START
    initApp();

</script>
</body>
</html>
