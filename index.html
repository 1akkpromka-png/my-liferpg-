<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero Life RPG v28</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: linear-gradient(160deg, #1a1a2e 0%, #16213e 100%);
            --glass: rgba(255, 255, 255, 0.07);
            --glass-active: rgba(255, 255, 255, 0.15);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #4deeea;
            --hp: #ff4d4d;
            --gold: #ffb347;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: #1a1a2e;
            background-image: var(--bg);
            background-attachment: fixed;
            color: #fff;
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0; padding: 15px; padding-bottom: 110px;
            min-height: 100vh;
        }

        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--border);
            border-radius: 26px;
            padding: 22px;
            margin-bottom: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        /* –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ì–µ—Ä–æ—è */
        .hero-view {
            width: 140px; height: 140px; margin: 0 auto 15px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            position: relative; background: rgba(255,255,255,0.02);
            transition: all 0.5s ease;
        }
        .avatar-main { font-size: 60px; z-index: 5; }
        .slot { position: absolute; font-size: 38px; z-index: 6; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5)); }
        #slot-h { top: -15px; left: 50%; transform: translateX(-50%); }
        #slot-w { bottom: 10px; right: -10px; }

        /* –ü–æ–ª–æ—Å–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
        .bar-wrap { height: 10px; background: rgba(0,0,0,0.3); border-radius: 20px; margin: 10px 0; overflow: hidden; border: 1px solid var(--border); }
        .bar-fill { height: 100%; border-radius: 20px; transition: width 0.8s cubic-bezier(0.17, 0.67, 0.83, 0.67); }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 20px; scrollbar-width: none; }
        .nav::-webkit-scrollbar { display: none; }
        .nav-btn {
            background: var(--glass); border: 1px solid var(--border);
            color: rgba(255,255,255,0.6); padding: 12px 20px; border-radius: 18px; 
            white-space: nowrap; font-size: 13px; font-weight: 600; transition: 0.3s;
        }
        .nav-btn.active { background: #fff; color: #1a1a2e; border-color: #fff; transform: translateY(-2px); }

        /* –ó–∞–¥–∞—á–∏ */
        .task-row {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--glass); border: 1px solid var(--border);
            padding: 16px; border-radius: 22px; margin-bottom: 12px;
        }
        .task-row.done { opacity: 0.3; filter: grayscale(1); }
        .task-info b { display: block; font-size: 15px; margin-bottom: 3px; }
        .task-info i { font-style: normal; font-size: 11px; color: var(--accent); font-weight: bold; }
        .time-tag { font-size: 10px; opacity: 0.6; display: block; margin-top: 4px; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-main {
            width: 100%; padding: 18px; border-radius: 22px; border: none;
            background: #fff; color: #1a1a2e; font-weight: 800; font-size: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1); transition: 0.2s;
        }
        .btn-main:active { transform: scale(0.96); }

        /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
        input, select {
            width: 100%; padding: 14px; margin-bottom: 12px; border-radius: 14px;
            border: 1px solid var(--border); background: rgba(0,0,0,0.2); color: #fff;
            font-size: 14px; outline: none;
        }
        label { font-size: 11px; opacity: 0.5; margin: 0 0 5px 5px; display: block; }

        #modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(15px); z-index: 999; display: none;
            align-items: center; justify-content: center; padding: 25px;
        }

        .hidden { display: none !important; }
        .ver { text-align: center; font-size: 10px; opacity: 0.2; margin-top: 30px; letter-spacing: 1px; }

        /* –°–µ—Ç –ú–∞–≥–∞–∑–∏–Ω–∞ */
        .shop-grid { display: grid; gap: 10px; }
    </style>
</head>
<body>

    <div id="loading" style="position:fixed; inset:0; background:#1a1a2e; z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div style="font-weight:900; color:var(--accent); margin-bottom:20px; letter-spacing:4px;">SYNCING_SYSTEM...</div>
        <div style="width:200px; height:2px; background:rgba(255,255,255,0.05); border-radius:10px;">
            <div id="load-bar" style="width:0%; height:100%; background:#fff; transition:0.3s; box-shadow: 0 0 15px #fff;"></div>
        </div>
    </div>

    <div class="glass-card" style="text-align: center;">
        <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:800; opacity:0.6; margin-bottom:20px;">
            <span id="rank">–ê–ù–ê–õ–ò–ó...</span>
            <span>–£–†–û–í–ï–ù–¨ <span id="total-lvl">1</span></span>
        </div>

        <div class="hero-view" id="aura">
            <span id="slot-h" class="slot"></span>
            <div class="avatar-main">üë∂</div>
            <span id="slot-w" class="slot"></span>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:25px; font-size:15px; font-weight:900;">
            <span style="color:var(--hp);">‚ù§ <span id="hp-val">100</span></span>
            <span style="color:var(--gold);">üí∞ <span id="gold-val">0</span></span>
        </div>
        <div class="bar-wrap">
            <div id="hp-fill" class="bar-fill" style="background:var(--hp); width:100%;"></div>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="tab(event, 'tasks')">–ó–ê–î–ê–ß–ò</button>
        <button class="nav-btn" onclick="tab(event, 'shop')">–ê–†–°–ï–ù–ê–õ</button>
        <button class="nav-btn" onclick="tab(event, 'piggy')">–ö–û–ü–ò–õ–ö–ê</button>
        <button class="nav-btn" onclick="tab(event, 'stats')">–ì–ï–†–û–ô</button>
    </div>

    <div id="v-tasks">
        <div id="task-list"></div>
        <button class="btn-main" onclick="openAdd()">+ –ù–û–í–´–ô –ö–í–ï–°–¢</button>
    </div>

    <div id="v-shop" class="hidden">
        <div class="glass-card">
            <h4 style="margin:0 0 15px 0; color:var(--accent);">–≠–ö–ò–ü–ò–†–û–í–ö–ê</h4>
            <div id="list-gear" class="shop-grid"></div>
            <h4 style="margin:25px 0 15px 0; color:var(--accent);">–ú–û–î–ò–§–ò–ö–ê–¢–û–†–´</h4>
            <div id="list-perks" class="shop-grid"></div>
        </div>
    </div>

    <div id="v-piggy" class="hidden">
        <div class="glass-card" id="piggy-ui"></div>
    </div>

    <div id="v-stats" class="hidden">
        <div id="stats-list"></div>
    </div>

    <div class="ver">BUILD: V28_ULTIMATE_STABLE</div>

    <div id="modal">
        <div class="glass-card" style="width:100%; max-width:400px; background: rgba(25, 25, 45, 0.98);">
            <h3 style="margin-top:0;">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h3>
            
            <label>–ù–ê–ó–í–ê–ù–ò–ï</label>
            <input type="text" id="m-title" placeholder="–ù–∞–ø—Ä: –ü—Ä–æ–±–µ–∂–∫–∞ 5–∫–º">

            <div style="display:flex; gap:12px;">
                <div style="flex:1;">
                    <label>–ù–ê–ß–ê–õ–û</label>
                    <input type="time" id="m-start">
                </div>
                <div style="flex:1;">
                    <label>–ö–û–ù–ï–¶</label>
                    <input type="time" id="m-end">
                </div>
            </div>

            <label>–î–ï–ù–¨ –ü–û–í–¢–û–†–ï–ù–ò–Ø</label>
            <select id="m-day">
                <option value="0">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option><option value="1">–í—Ç–æ—Ä–Ω–∏–∫</option>
                <option value="2">–°—Ä–µ–¥–∞</option><option value="3">–ß–µ—Ç–≤–µ—Ä–≥</option>
                <option value="4">–ü—è—Ç–Ω–∏—Ü–∞</option><option value="5">–°—É–±–±–æ—Ç–∞</option><option value="6">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
            </select>

            <label>–°–§–ï–†–ê (–ù–ê–í–´–ö)</label>
            <select id="m-cat" onchange="document.getElementById('m-new-cat').classList.toggle('hidden', this.value!=='new')">
                <option value="money">üí∞ –§–∏–Ω–∞–Ω—Å—ã</option>
                <option value="education">üìö –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç</option>
                <option value="health">üí™ –ó–¥–æ—Ä–æ–≤—å–µ</option>
                <option value="new">+ –°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é...</option>
            </select>
            <input type="text" id="m-new-cat" class="hidden" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ñ–µ—Ä—ã">

            <button class="btn-main" onclick="saveNewQuest()">–ê–ö–¢–ò–í–ò–†–û–í–ê–¢–¨</button>
            <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; background:none; border:none; color:#777; margin-top:15px; font-weight:bold;">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const DB_ITEMS = {
        gear: {
            'h1': { n: '–¢–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —à–ª–µ–º', i: 'ü™ñ', p: 500, s: 'head' },
            'h2': { n: '–ó–æ–ª–æ—Ç–æ–π –≤–µ–Ω–µ—Ü', i: 'üëë', p: 3000, s: 'head' },
            'w1': { n: '–ú–µ—á –ü—Ä–æ–≥—Ä–µ—Å—Å–∞', i: 'üó°Ô∏è', p: 1000, s: 'weapon' },
            'w2': { n: '–ü–æ—Å–æ—Ö –ú—É–¥—Ä–æ—Å—Ç–∏', i: 'ü™Ñ', p: 1800, s: 'weapon' }
        },
        perks: {
            'boost': { n: '–ú–∞–π–Ω–µ—Ä', d: '+20% –∑–æ–ª–æ—Ç–∞ –∑–∞ –∫–≤–µ—Å—Ç', p: 1200 },
            'def': { n: '–§–∞–π–µ—Ä–≤–æ–ª', d: '-50% —É—Ä–æ–Ω–∞ –ø—Ä–∏ –ø—Ä–æ–ø—É—Å–∫–µ', p: 2000 }
        }
    };

    let state = {
        gold: 0, hp: 100, lastDate: new Date().toDateString(),
        skills: { money: {lvl:1, xp:0}, education: {lvl:1, xp:0}, health: {lvl:1, xp:0} },
        quests: [], inventory: [], perks: [],
        equipped: { head: null, weapon: null },
        piggy: { active: false, title: '', goal: 0, curr: 0 }
    };

    function init() {
        let p = 0;
        const interval = setInterval(() => { p+=4; if(p<=96) document.getElementById('load-bar').style.width=p+'%'; }, 100);

        // –§–∏–∫—Å —Ç–∞–π–º-–∞—É—Ç–∞ 10 —Å–µ–∫—É–Ω–¥
        const forceLoad = setTimeout(() => { if(document.getElementById('loading').style.display !== 'none') finalize(); }, 10000);

        tg.CloudStorage.getItem('life_rpg_v28_final', (err, val) => {
            clearTimeout(forceLoad);
            clearInterval(interval);
            if(!err && val) {
                try { state = JSON.parse(val); } catch(e){}
            } else {
                const local = localStorage.getItem('life_rpg_v28_final');
                if(local) try { state = JSON.parse(local); } catch(e){}
            }
            finalize();
        });
    }

    function finalize() {
        document.getElementById('load-bar').style.width='100%';
        checkNewDay();
        render();
        setTimeout(() => document.getElementById('loading').style.display='none', 600);
    }

    function save() {
        const s = JSON.stringify(state);
        localStorage.setItem('life_rpg_v28_final', s);
        tg.CloudStorage.setItem('life_rpg_v28_final', s);
        render();
    }

    function checkNewDay() {
        const today = new Date().toDateString();
        if(state.lastDate !== today) {
            const yesterday = (new Date().getDay() + 5) % 7;
            const missed = state.quests.filter(q => parseInt(q.day) === yesterday && !q.done);
            if(missed.length > 0) {
                let dmg = missed.length * 15;
                if(state.perks.includes('def')) dmg = Math.floor(dmg/2);
                state.hp = Math.max(0, state.hp - dmg);
            }
            state.quests.forEach(q => q.done = false);
            state.lastDate = today;
            save();
        }
    }

    function render() {
        document.getElementById('gold-val').innerText = state.gold;
        document.getElementById('hp-val').innerText = state.hp;
        document.getElementById('hp-fill').style.width = state.hp + '%';

        let totalLvl = 0; for(let s in state.skills) totalLvl += state.skills[s].lvl;
        document.getElementById('total-lvl').innerText = totalLvl;
        
        const rank = document.getElementById('rank');
        const aura = document.getElementById('aura');
        if(totalLvl < 10) { rank.innerText = "–ù–û–í–ò–ß–û–ö"; aura.style.boxShadow = "0 0 20px rgba(255,255,255,0.1)"; }
        else if(totalLvl < 30) { rank.innerText = "–ì–ï–†–û–ô"; aura.style.boxShadow = "0 0 35px var(--accent)"; }
        else { rank.innerText = "–õ–ï–ì–ï–ù–î–ê"; aura.style.boxShadow = "0 0 50px var(--hp)"; }

        document.getElementById('slot-h').innerText = state.equipped.head ? DB_ITEMS.gear[state.equipped.head].i : '';
        document.getElementById('slot-w').innerText = state.equipped.weapon ? DB_ITEMS.gear[state.equipped.weapon].i : '';

        const todayIdx = (new Date().getDay() + 6) % 7;
        const todayQuests = state.quests.filter(q => parseInt(q.day) === todayIdx);
        document.getElementById('task-list').innerHTML = todayQuests.map(q => {
            const globalIdx = state.quests.indexOf(q);
            const timeInfo = (q.start && q.end) ? `<span class="time-tag">‚è∞ ${q.start} ‚Äî ${q.end}</span>` : '';
            return `
            <div class="task-row ${q.done ? 'done' : ''}">
                <div class="task-info">
                    <i>${q.cat.toUpperCase()}</i>
                    <b>${q.title}</b>
                    ${timeInfo}
                </div>
                ${q.done ? `<button onclick="removeQuest(${globalIdx})" style="background:none; border:none; color:var(--hp); font-size:11px; font-weight:800;">–£–î–ê–õ–ò–¢–¨</button>` : 
                `<button onclick="completeQuest(${globalIdx})" style="background:#fff; color:#000; border:none; padding:10px 18px; border-radius:14px; font-weight:900; font-size:12px;">–ì–û–¢–û–í–û</button>`}
            </div>`;
        }).join('') || '<div style="text-align:center; padding:40px; opacity:0.3; font-size:14px;">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–¥–∞—á –Ω–µ—Ç...</div>';

        renderShop();
        renderPiggy();
        renderStats();
    }

    function renderShop() {
        let gh = "";
        for(let k in DB_ITEMS.gear) {
            const it = DB_ITEMS.gear[k]; const has = state.inventory.includes(k); const eq = state.equipped[it.s] === k;
            gh += `<div style="display:flex; justify-content:space-between; align-items:center;">
                <span>${it.i} ${it.n}</span>
                <button onclick="toggleGear('${k}')" style="background:${has?(eq?'var(--hp)':'#fff'):'rgba(255,255,255,0.1)'}; color:${has?(eq?'#fff':'#000'):'#fff'}; border:none; padding:8px 15px; border-radius:12px; font-size:11px; font-weight:800;">
                ${has?(eq?'–°–ù–Ø–¢–¨':'–û–î–ï–¢–¨'):it.p + 'üí∞'}</button></div>`;
        }
        document.getElementById('list-gear').innerHTML = gh;

        let ph = "";
        for(let k in DB_ITEMS.perks) {
            const p = DB_ITEMS.perks[k]; const has = state.perks.includes(k);
            ph += `<div style="display:flex; justify-content:space-between; align-items:center;">
                <div><b>${p.n}</b><br><small style="opacity:0.5; font-size:10px;">${p.d}</small></div>
                <button onclick="buyPerk('${k}')" ${has?'disabled':''} style="background:${has?'#333':'var(--accent)'}; color:#000; border:none; padding:8px 15px; border-radius:12px; font-size:11px; font-weight:800;">
                ${has?'–ê–ö–¢–ò–í–ï–ù':p.p}</button></div>`;
        }
        document.getElementById('list-perks').innerHTML = ph;
    }

    function renderPiggy() {
        const p = state.piggy; const box = document.getElementById('piggy-ui');
        if(!p.active) {
            box.innerHTML = `<h3>–ö–æ–ø–∏–ª–∫–∞</h3><p style="opacity:0.6; font-size:13px; line-height:1.5;">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ü–µ–ª—å, —á—Ç–æ–±—ã –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –∑–æ–ª–æ—Ç–æ –∏ –ø–æ–ª—É—á–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –æ–ø—ã—Ç –≤ —Ñ–∏–Ω–∞–Ω—Å—ã.</p>
            <button class="btn-main" onclick="initPiggy()">–ù–û–í–ê–Ø –¶–ï–õ–¨</button>`;
        } else {
            const pct = Math.min(100, (p.curr/p.goal)*100);
            box.innerHTML = `<h3 style="margin-bottom:5px;">${p.title}</h3><div style="font-size:11px; margin-bottom:10px; opacity:0.7;">–°–æ–±—Ä–∞–Ω–æ: ${p.curr} / ${p.goal}</div>
            <div class="bar-wrap"><div class="bar-fill" style="background:var(--gold); width:${pct}%;"></div></div>
            <button class="btn-main" style="background:var(--gold); color:#000;" onclick="addGoldToPiggy()">–ü–û–ü–û–õ–ù–ò–¢–¨</button>
            <button onclick="state.piggy.active=false; save();" style="background:none; border:none; color:#777; width:100%; margin-top:15px; font-size:12px;">–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å</button>`;
        }
    }

    function renderStats() {
        document.getElementById('stats-list').innerHTML = Object.keys(state.skills).map(k => `
            <div class="glass-card" style="padding:18px; margin-bottom:12px;">
                <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:bold; margin-bottom:8px;">
                    <span style="text-transform:uppercase; letter-spacing:1px;">${k === 'money' ? '–§–∏–Ω–∞–Ω—Å—ã' : k === 'education' ? '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç' : k === 'health' ? '–¢–µ–ª–æ' : k}</span>
                    <span>–£–†–û–í–ï–ù–¨ ${state.skills[k].lvl}</span>
                </div>
                <div class="bar-wrap"><div class="bar-fill" style="background:#fff; width:${state.skills[k].xp}%;"></div></div>
            </div>`).join('');
    }

    window.tab = (e, n) => {
        tg.HapticFeedback.impactOccurred('light');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('[id^="v-"]').forEach(v => v.classList.add('hidden'));
        document.getElementById('v-'+n).classList.remove('hidden');
    };

    window.openAdd = () => {
        document.getElementById('m-day').value = (new Date().getDay() + 6) % 7;
        document.getElementById('modal').style.display = 'flex';
    };

    window.saveNewQuest = () => {
        const t = document.getElementById('m-title').value; if(!t) return;
        let c = document.getElementById('m-cat').value;
        if(c === 'new') {
            c = document.getElementById('m-new-cat').value || '—Ä–∞–∑–Ω–æ–µ';
            if(!state.skills[c]) state.skills[c] = {lvl:1, xp:0};
        }
        state.quests.push({ 
            title: t, cat: c, 
            day: document.getElementById('m-day').value, 
            start: document.getElementById('m-start').value,
            end: document.getElementById('m-end').value,
            done: false 
        });
        document.getElementById('modal').style.display = 'none'; save();
    };

    window.completeQuest = (idx) => {
        tg.HapticFeedback.notificationOccurred('success');
        const q = state.quests[idx]; q.done = true;
        state.gold += state.perks.includes('boost') ? 65 : 50;
        state.skills[q.cat].xp += 25;
        if(state.skills[q.cat].xp >= 100) { state.skills[q.cat].xp=0; state.skills[q.cat].lvl++; }
        save();
    };

    window.removeQuest = (idx) => { if(confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É?')) { state.quests.splice(idx,1); save(); } };

    window.toggleGear = (k) => {
        const it = DB_ITEMS.gear[k];
        if(state.inventory.includes(k)) state.equipped[it.s] = state.equipped[it.s] === k ? null : k;
        else if(state.gold >= it.p) { state.gold -= it.p; state.inventory.push(k); state.equipped[it.s] = k; }
        save();
    };

    window.buyPerk = (k) => { if(state.gold >= DB_ITEMS.perks[k].p) { state.gold -= DB_ITEMS.perks[k].p; state.perks.push(k); save(); } };

    window.initPiggy = () => {
        const t = prompt('–ù–∞ —á—Ç–æ –∫–æ–ø–∏–º?'); const g = parseInt(prompt('–ö–∞–∫–∞—è —Å—É–º–º–∞ –Ω—É–∂–Ω–∞?'));
        if(t && g) { state.piggy = { active: true, title: t, goal: g, curr: 0 }; save(); }
    };

    window.addGoldToPiggy = () => {
        const v = parseInt(prompt('–°–∫–æ–ª—å–∫–æ –∑–æ–ª–æ—Ç–∞ –≤–Ω–µ—Å—Ç–∏?'));
        if(v > 0 && state.gold >= v) { 
            state.gold -= v; state.piggy.curr += v; 
            state.skills.money.xp += 15; save(); 
        }
    };

    init();
</script>
</body>
</html>
