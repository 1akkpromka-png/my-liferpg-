<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero RPG: Ultimate</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #1a1a1a);
            --text: var(--tg-theme-text-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #aaaaaa);
            --btn: var(--tg-theme-button-color, #3390ec);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --gold: #f1c40f; --boss: #eb4d4b; --hp: #ff4757; --streak: #e67e22;
        }

        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 12px; padding-bottom: 100px; overflow-x: hidden; }
        .card { background: rgba(255,255,255,0.06); border-radius: 16px; padding: 12px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); position: relative; }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-4px, 2px); } 50% { transform: translate(4px, -2px); } }
        .shake { animation: shake 0.4s ease-in-out; }
        .particle { position: fixed; pointer-events: none; z-index: 9999; animation: fly 0.8s ease-out forwards; font-size: 20px; }
        @keyframes fly { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-80px); } }

        /* –¢–∞–±—ã */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.08); color: var(--text); font-size: 10px; border: none; font-weight: bold; }
        .tab-btn.active { background: var(--btn); color: var(--btn-text); }

        /* –ó–∞–¥–∞—á–∏ */
        .quest { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.04); border-radius: 12px; margin-bottom: 8px; border-left: 4px solid var(--btn); }
        .quest.long-term { border-left-color: var(--gold); background: rgba(241, 196, 15, 0.05); }
        .quest.done { opacity: 0.4; filter: grayscale(1); }
        .quest-time { font-size: 11px; color: var(--btn); font-weight: bold; }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã */
        .bar-bg { background: rgba(0,0,0,0.3); height: 8px; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .bar-fill { height: 100%; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* –ö–Ω–æ–ø–∫–∏ */
        .main-btn { background: var(--btn); color: var(--btn-text); border: none; padding: 15px; border-radius: 14px; width: 100%; font-weight: bold; font-size: 16px; margin: 10px 0; }
        .icon-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px; border-radius: 8px; margin-left: 5px; }

        #planner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; display: none; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        input, select { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: #fff; }
        .hidden { display: none; }
    </style>
</head>
<body id="main-body">

<div class="card" style="text-align: center;">
    <div style="position: absolute; top: 10px; right: 10px; font-size: 12px; color: var(--streak);" id="streak-txt">üî• 0 –¥–Ω.</div>
    <div style="font-size: 45px; margin: 10px 0;">
        <span id="eq-head"></span><span id="hero-base">üë∂</span><span id="eq-weapon"></span>
    </div>
    <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px;">
        <span>‚ù§Ô∏è HP: <span id="hp-val">100</span></span>
        <span style="color: var(--gold);">üí∞ <span id="gold-val">0</span></span>
    </div>
    <div class="bar-bg"><div id="hp-bar" class="bar-fill" style="background: var(--hp); width: 100%;"></div></div>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="showTab('today')">–°–ï–ì–û–î–ù–Ø</button>
    <button class="tab-btn" onclick="showTab('week')">–ù–ï–î–ï–õ–Ø</button>
    <button class="tab-btn" onclick="showTab('shop')">–ú–ê–ì–ê–ó–ò–ù</button>
    <button class="tab-btn" onclick="showTab('profile')">–ì–ï–†–û–ô</button>
</div>

<div id="tab-today">
    <div id="pinned-quests"></div>
    <div id="quest-list"></div>
    <button class="main-btn" onclick="togglePlanner(true)">Ôºã –ù–û–í–´–ô –ö–í–ï–°–¢</button>
    <button id="clear-btn" class="hidden" onclick="clearDone()" style="width:100%; background:none; border:none; color:var(--hint); font-size:12px;">üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ</button>
</div>

<div id="tab-week" class="hidden">
    <div id="calendar-view"></div>
</div>

<div id="tab-shop" class="hidden">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div class="card" onclick="buyItem('hp')" style="text-align:center;">üß™ HP<br><small>150üí∞</small></div>
        <div class="card" onclick="buyItem('xp')" style="text-align:center;">‚ö° XP<br><small>500üí∞</small></div>
    </div>
    <div id="gear-list"></div>
</div>

<div id="tab-profile" class="hidden">
    <div id="skills-list"></div>
</div>

<div id="planner-modal">
    <h3>–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ</h3>
    <input type="text" id="q-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–µ–ª–∏...">
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <span>–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–∞—è —Ü–µ–ª—å?</span>
        <input type="checkbox" id="q-is-long" onchange="document.getElementById('date-selectors').classList.toggle('hidden', this.checked)">
    </div>

    <div id="date-selectors">
        <select id="q-day">
            <option value="0">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option><option value="1">–í—Ç–æ—Ä–Ω–∏–∫</option><option value="2">–°—Ä–µ–¥–∞</option>
            <option value="3">–ß–µ—Ç–≤–µ—Ä–≥</option><option value="4">–ü—è—Ç–Ω–∏—Ü–∞</option><option value="5">–°—É–±–±–æ—Ç–∞</option><option value="6">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
        </select>
        <input type="time" id="q-time">
    </div>

    <select id="q-cat" onchange="document.getElementById('custom-cat-box').classList.toggle('hidden', this.value !== 'custom')">
        <option value="money">üí∞ –î–µ–Ω—å–≥–∏</option><option value="education">üéì –ó–Ω–∞–Ω–∏—è</option>
        <option value="health">üí™ –°–∏–ª–∞</option><option value="english">üá¨üáß English</option>
        <option value="custom">‚ú® –°–≤–æ—è —Å—Ñ–µ—Ä–∞...</option>
    </select>
    <input type="text" id="q-custom-cat" class="hidden" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Ñ–µ—Ä—ã">

    <button class="main-btn" onclick="addQuest()">–°–û–•–†–ê–ù–ò–¢–¨</button>
    <button onclick="togglePlanner(false)" style="width:100%; background:none; border:none; color:var(--hint);">–û—Ç–º–µ–Ω–∞</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
    const GEAR = {
        'sword': { name: '–ú–µ—á', icon: 'üó°Ô∏è', price: 300, slot: 'weapon' },
        'helmet': { name: '–®–ª–µ–º', icon: 'ü™ñ', price: 400, slot: 'head' }
    };

    let state = JSON.parse(localStorage.getItem('heroRPG_final')) || {
        gold: 0, hp: 100, streak: 0,
        skills: { money:{xp:0, lvl:1}, education:{xp:0, lvl:1}, health:{xp:0, lvl:1}, english:{xp:0, lvl:1} },
        quests: [], inventory: [], equipped: { head:null, weapon:null }
    };

    function save() { 
        localStorage.setItem('heroRPG_final', JSON.stringify(state)); 
        render(); 
    }

    function spawnGold(e) {
        for(let i=0; i<6; i++) {
            const p = document.createElement('div');
            p.className = 'particle'; p.innerText = 'üí∞';
            p.style.left = e.clientX + 'px'; p.style.top = e.clientY + 'px';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 800);
        }
    }

    function render() {
        document.getElementById('gold-val').innerText = state.gold;
        document.getElementById('hp-val').innerText = state.hp;
        document.getElementById('hp-bar').style.width = state.hp + '%';
        document.getElementById('streak-txt').innerText = `üî• ${state.streak} –¥–Ω.`;
        
        // –í–∏–∑—É–∞–ª –≥–µ—Ä–æ—è
        let totalLvl = 0; Object.values(state.skills).forEach(s => totalLvl += s.lvl);
        document.getElementById('hero-base').innerText = totalLvl > 15 ? "‚öîÔ∏è" : (totalLvl > 5 ? "üèπ" : "üë∂");
        document.getElementById('eq-head').innerText = state.equipped.head ? GEAR[state.equipped.head].icon : '';
        document.getElementById('eq-weapon').innerText = state.equipped.weapon ? GEAR[state.equipped.weapon].icon : '';

        const tIdx = (new Date().getDay() + 6) % 7;
        
        // –ö–≤–µ—Å—Ç—ã –°–µ–≥–æ–¥–Ω—è
        const pinned = state.quests.filter(q => q.isLongTerm);
        document.getElementById('pinned-quests').innerHTML = pinned.map(q => renderQuestItem(q)).join('');
        
        const daily = state.quests.filter(q => !q.isLongTerm && parseInt(q.day) === tIdx);
        daily.sort((a,b) => (a.time || '99:99').localeCompare(b.time || '99:99'));
        document.getElementById('quest-list').innerHTML = daily.map(q => renderQuestItem(q)).join('');
        document.getElementById('clear-btn').classList.toggle('hidden', !state.quests.some(q => q.done));

        // –ö–∞–ª–µ–Ω–¥–∞—Ä—å
        let calHtml = '';
        DAYS.forEach((d, i) => {
            const dayQ = state.quests.filter(q => !q.isLongTerm && parseInt(q.day) === i);
            if(dayQ.length) {
                calHtml += `<div style="font-size:12px; color:var(--btn); margin-top:10px; font-weight:bold;">${d}</div>`;
                calHtml += dayQ.map(q => `<div style="font-size:11px; opacity:${q.done?0.4:1}">‚Ä¢ ${q.time||'--'} ${q.title}</div>`).join('');
            }
        });
        document.getElementById('calendar-view').innerHTML = calHtml || '<p style="text-align:center; color:var(--hint);">–ù–µ—Ç –ø–ª–∞–Ω–æ–≤ –Ω–∞ –Ω–µ–¥–µ–ª—é</p>';

        // –ù–∞–≤—ã–∫–∏
        document.getElementById('skills-list').innerHTML = Object.keys(state.skills).map(k => `
            <div class="card" onclick="deleteSkill('${k}')">
                <div style="display:flex; justify-content:space-between; font-size:12px"><span>${k.toUpperCase()} (Lvl ${state.skills[k].lvl})</span><span>${state.skills[k].xp}%</span></div>
                <div class="bar-bg"><div class="bar-fill" style="width:${state.skills[k].xp}%; background:var(--btn);"></div></div>
            </div>`).join('');

        // –°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ –≤ –º–∞–≥–∞–∑–∏–Ω–µ
        document.getElementById('gear-list').innerHTML = Object.keys(GEAR).map(id => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <span>${GEAR[id].icon} ${GEAR[id].name}</span>
                <button class="icon-btn" onclick="buyGear('${id}')">${state.inventory.includes(id) ? (state.equipped[GEAR[id].slot] === id ? '–°–Ω—è—Ç—å' : '–ù–∞–¥–µ—Ç—å') : GEAR[id].price + 'üí∞'}</button>
            </div>`).join('');
    }

    function renderQuestItem(q) {
        const idx = state.quests.indexOf(q);
        return `
            <div class="quest ${q.isLongTerm?'long-term':''} ${q.done?'done':''}">
                <div>
                    <div style="font-weight:bold;">${q.title}</div>
                    ${q.time ? `<div class="quest-time">üïí ${q.time}</div>` : ''}
                </div>
                <div style="display:flex;">
                    ${(!q.done && q.time) ? `<button class="icon-btn" onclick="sendNotify('${q.title}','${q.time}')">üîî</button>` : ''}
                    ${q.done ? `<button class="icon-btn" onclick="deleteQuest(${idx})">üóëÔ∏è</button>` : `<button class="icon-btn" style="background:var(--btn)" onclick="completeQuest(event, ${idx})">‚ûï</button>`}
                </div>
            </div>`;
    }

    window.addQuest = function() {
        const title = document.getElementById('q-title').value;
        if(!title) return;
        let cat = document.getElementById('q-cat').value;
        if(cat === 'custom') cat = document.getElementById('q-custom-cat').value || '–†–∞–∑–Ω–æ–µ';
        if(!state.skills[cat]) state.skills[cat] = {xp:0, lvl:1};
        state.quests.push({ title, isLongTerm: document.getElementById('q-is-long').checked, day: document.getElementById('q-day').value, time: document.getElementById('q-time').value, cat, done: false });
        togglePlanner(false); save();
    };

    window.completeQuest = function(e, idx) {
        spawnGold(e);
        const q = state.quests[idx]; q.done = true;
        state.gold += 50 + (state.streak * 5);
        const s = state.skills[q.cat]; s.xp += 25;
        if(s.xp >= 100) { s.xp=0; s.lvl++; tg.HapticFeedback.notificationOccurred('success'); }
        save();
    };

    window.buyItem = function(t) {
        if(t === 'hp' && state.gold >= 150) { state.gold -= 150; state.hp = Math.min(100, state.hp + 30); }
        else if(t === 'xp' && state.gold >= 500) {
            let cat = prompt("–í–≤–µ–¥–∏—Ç–µ —Å—Ñ–µ—Ä—É (money, health –∏ —Ç.–¥.):", "money");
            if(state.skills[cat]) { state.gold -= 500; state.skills[cat].xp += 50; if(state.skills[cat].xp>=100){state.skills[cat].xp=0;state.skills[cat].lvl++;} }
        } else { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞!"); }
        save();
    };

    window.buyGear = function(id) {
        if(state.inventory.includes(id)) {
            const slot = GEAR[id].slot;
            state.equipped[slot] = state.equipped[slot] === id ? null : id;
        } else if(state.gold >= GEAR[id].price) {
            state.gold -= GEAR[id].price; state.inventory.push(id);
        }
        save();
    };

    window.deleteQuest = (idx) => { state.quests.splice(idx, 1); save(); };
    window.clearDone = () => { state.quests = state.quests.filter(q => !q.done); save(); };
    window.deleteSkill = (k) => { if(!['money','health','education','english'].includes(k) && confirm('–£–¥–∞–ª–∏—Ç—å —Å—Ñ–µ—Ä—É?')) { delete state.skills[k]; save(); } };
    window.showTab = (t) => { document.querySelectorAll('[id^="tab-"]').forEach(c => c.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById('tab-'+t).classList.remove('hidden'); event.currentTarget.classList.add('active'); };
    window.togglePlanner = (s) => document.getElementById('planner-modal').style.display = s?'block':'none';
    window.sendNotify = (t, time) => { tg.sendData(JSON.stringify({action:'remind', task:t, time:time})); alert('–ó–∞–ø—Ä–æ—Å –±–æ—Ç—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!'); };

    render();
</script>
</body>
</html>
