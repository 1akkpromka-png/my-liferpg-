<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero RPG: VFX & Streaks</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #1a1a1a);
            --text: var(--tg-theme-text-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #aaaaaa);
            --btn: var(--tg-theme-button-color, #3390ec);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --gold: #f1c40f;
            --boss: #eb4d4b;
            --hp: #ff4757;
            --streak: #e67e22;
        }

        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 16px; padding-bottom: 100px; overflow-x: hidden; }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
        .shake-screen { animation: shake 0.5s; }
        
        @keyframes levelup-flash { 0% { opacity: 0.6; } 100% { opacity: 0; } }
        #flash-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; pointer-events: none; z-index: 9999; }
        .flash-active { animation: levelup-flash 0.5s ease-out; }

        .particle { position: fixed; pointer-events: none; font-size: 20px; z-index: 9998; animation: fly-up 1s ease-out forwards; }
        @keyframes fly-up { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-100px) scale(1.5); } }

        /* UI —ç–ª–µ–º–µ–Ω—Ç—ã */
        .hero-section { text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .streak-badge { position: absolute; top: 10px; right: 10px; background: var(--streak); color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 12px; box-shadow: 0 0 10px var(--streak); }
        .hero-display { font-size: 40px; display: flex; justify-content: center; align-items: center; gap: 8px; }

        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.1); color: var(--text); font-size: 11px; border: none; transition: 0.3s; }
        .tab-btn.active { background: var(--btn); color: var(--btn-text); transform: scale(1.05); }

        .card { background: rgba(255,255,255,0.08); border-radius: 16px; padding: 15px; margin-bottom: 15px; }
        .quest { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 8px; border-left: 4px solid var(--btn); transition: 0.3s; }
        .quest.boss { border-left-color: var(--boss); background: rgba(235, 77, 75, 0.1); }
        .quest.done { opacity: 0.3; transform: scale(0.98); }

        .bar-bg { background: rgba(0,0,0,0.3); height: 8px; border-radius: 4px; margin-top: 4px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); background: var(--btn); }
        .hp-bar-fill { background: var(--hp); }

        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .item-card { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; text-align: center; }
        
        #planner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; display: none; padding: 20px; box-sizing: border-box; animation: slide-up 0.3s ease-out; }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        input, select { width: 100%; padding: 12px; margin-bottom: 8px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: #fff; }
        .hidden { display: none; }
        .btn-complete { position: relative; overflow: hidden; }
    </style>
</head>
<body id="main-body">
<div id="flash-overlay"></div>

<div class="hero-section">
    <div class="streak-badge streak-hidden" id="streak-badge">üî• 0 –¥–Ω–µ–π</div>
    <div class="hero-display">
        <span id="eq-head"></span><span id="hero-base">üë∂</span><span id="eq-weapon"></span>
    </div>
    <div id="hero-rank" style="font-weight: bold; color: var(--gold); font-size: 14px; margin-top:5px;">–ù–æ–≤–∏—á–æ–∫</div>
    <div style="margin-top:10px">
        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:2px">
            <span>‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ</span><span id="hp-val">100/100</span>
        </div>
        <div class="bar-bg"><div id="hp-bar" class="bar-fill hp-bar-fill" style="width: 100%"></div></div>
    </div>
    <div style="margin-top:10px; font-weight: bold; color: var(--gold); font-size: 20px;">üí∞ <span id="gold-val">0</span></div>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="showTab('today')">–ö–í–ï–°–¢–´</button>
    <button class="tab-btn" onclick="showTab('shop')">–ú–ê–ì–ê–ó–ò–ù</button>
    <button class="tab-btn" onclick="showTab('profile')">–ü–†–û–§–ò–õ–¨</button>
</div>

<div id="tab-today">
    <div id="quest-list"></div>
    <button onclick="togglePlanner(true)" style="background:var(--btn); color:white; border:none; padding:15px; border-radius:12px; width:100%; margin-top:10px; font-weight:bold; font-size: 16px;">Ôºã –ù–û–í–´–ô –ö–í–ï–°–¢</button>
</div>

<div id="tab-shop" class="hidden">
    <h3>üß™ –ê–ª—Ö–∏–º–∏–∫</h3>
    <div class="shop-grid">
        <div class="item-card" onclick="usePotion('hp')">
            <span style="font-size:30px">üß™</span><br><b>–õ–µ—á–µ–Ω–∏–µ (+30 HP)</b><br>
            <span style="color:var(--gold)">150üí∞</span>
        </div>
        <div class="item-card" onclick="usePotion('xp')">
            <span style="font-size:30px">‚ö°</span><br><b>–û–ø—ã—Ç (+50 XP)</b><br>
            <span style="color:var(--gold)">500üí∞</span>
        </div>
    </div>
    <h3 style="margin-top:20px">‚öîÔ∏è –ö—É–∑–Ω–∏—Ü–∞</h3>
    <div id="shop-items-list"></div>
</div>

<div id="tab-profile" class="hidden">
    <div class="card" id="skills-box"></div>
    <div class="card" style="font-size:12px; color:var(--hint)">
        –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∫–≤–µ—Å—Ç–æ–≤: <span id="stat-q">0</span><br>
        –£–±–∏—Ç–æ –±–æ—Å—Å–æ–≤: <span id="stat-b">0</span><br>
        –ú–∞–∫—Å. —Å–µ—Ä–∏—è: <span id="stat-s">0</span> –¥–Ω–µ–π
    </div>
</div>

<div id="planner-modal">
    <h2>–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
    <input type="text" id="q-title" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?">
    <select id="q-day"><option value="0">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option><option value="1">–í—Ç–æ—Ä–Ω–∏–∫</option><option value="2">–°—Ä–µ–¥–∞</option><option value="3">–ß–µ—Ç–≤–µ—Ä–≥</option><option value="4">–ü—è—Ç–Ω–∏—Ü–∞</option><option value="5">–°—É–±–±–æ—Ç–∞</option><option value="6">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option></select>
    <select id="q-cat"><option value="money">üí∞ –î–µ–Ω—å–≥–∏</option><option value="education">üéì –ó–Ω–∞–Ω–∏—è</option><option value="health">üí™ –°–∏–ª–∞</option><option value="english">üá¨üáß English</option></select>
    <div style="margin: 15px 0; display: flex; align-items: center;"><input type="checkbox" id="q-isboss" style="width:auto; margin-right: 10px;"> <label for="q-isboss" style="color:var(--boss); font-weight:bold;">üëπ –ë–û–°–°-–ö–í–ï–°–¢</label></div>
    <button onclick="addQ()" style="background:var(--btn); color:white; border:none; padding:12px; border-radius:10px; width:100%; font-size: 16px; font-weight: bold;">–î–æ–±–∞–≤–∏—Ç—å</button>
    <button onclick="togglePlanner(false)" style="background:none; color:var(--hint); border:none; width:100%; margin-top:10px">–û—Ç–º–µ–Ω–∞</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const ITEMS = {
        'sword': { id: 'sword', name: '–ú–µ—á', icon: 'üó°Ô∏è', price: 300, slot: 'weapon' },
        'helmet': { id: 'helmet', name: '–®–ª–µ–º', icon: 'ü™ñ', price: 400, slot: 'head' },
        'shield': { id: 'shield', name: '–©–∏—Ç', icon: 'üõ°Ô∏è', price: 350, slot: 'weapon' }
    };

    let state = JSON.parse(localStorage.getItem('heroRPG_v7')) || {
        gold: 0, hp: 100,
        skills: { money: {xp:0, lvl:1}, education: {xp:0, lvl:1}, health: {xp:0, lvl:1}, english: {xp:0, lvl:1} },
        quests: [], inventory: [], equipped: { head: null, weapon: null },
        history: { totalCompleted: 0, bossesDefeated: 0, maxStreak: 0 },
        streak: { count: 0, lastDateChecked: null },
        lastDate: new Date().toDateString()
    };

    // --- VFX –§—É–Ω–∫—Ü–∏–∏ ---
    function triggerFlash() {
        const flash = document.getElementById('flash-overlay');
        flash.classList.remove('flash-active');
        void flash.offsetWidth; // –¢—Ä–∏–≥–≥–µ—Ä —Ä–µ—Ñ–ª–æ—É –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
        flash.classList.add('flash-active');
    }

    function triggerShake() {
        document.getElementById('main-body').classList.add('shake-screen');
        setTimeout(() => document.getElementById('main-body').classList.remove('shake-screen'), 500);
    }

    function spawnParticles(x, y, emoji) {
        for(let i=0; i<5; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.innerText = emoji;
            p.style.left = (x + (Math.random()-0.5)*40) + 'px';
            p.style.top = y + 'px';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 1000);
        }
    }

    // --- –õ–æ–≥–∏–∫–∞ ---
    function dailyRoutineCheck() {
        const todayStr = new Date().toDateString();
        
        // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–∏–∏ –∏ —É—Ä–æ–Ω–∞ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—É–ø–∏–ª –Ω–æ–≤—ã–π –¥–µ–Ω—å)
        if (state.lastDate !== todayStr) {
            const yesterdayDate = new Date();
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yesterdayIdx = (yesterdayDate.getDay() + 6) % 7;

            const yesterdayQuests = state.quests.filter(q => parseInt(q.day) === yesterdayIdx);
            const failed = yesterdayQuests.filter(q => !q.done);

            if (yesterdayQuests.length > 0) {
                if (failed.length === 0) {
                    state.streak.count++;
                    if(state.streak.count > state.history.maxStreak) state.history.maxStreak = state.streak.count;
                    alert(`üî• –°–µ—Ä–∏—è –ø—Ä–æ–¥–ª–µ–Ω–∞! –¢–µ–ø–µ—Ä—å ${state.streak.count} –¥–Ω. –ë–æ–Ω—É—Å –∫ –∑–æ–ª–æ—Ç—É —É–≤–µ–ª–∏—á–µ–Ω!`);
                } else {
                    state.streak.count = 0;
                    const damage = failed.length * 10;
                    state.hp -= damage;
                    triggerShake();
                    alert(`–°–µ—Ä–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞! üò¢ –¢—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª –∑–∞–¥–∞—á–∏ –∏ –ø–æ–ª—É—á–∏–ª ${damage} —É—Ä–æ–Ω–∞.`);
                }
            }

            state.lastDate = todayStr;
            save();
        }
    }

    function save() {
        if (state.hp <= 0) {
            state.hp = 50;
            state.gold = Math.floor(state.gold * 0.8);
            state.streak.count = 0;
            alert("‚ò†Ô∏è –ì–µ—Ä–æ–π –ø–∞–ª! –ó–æ–ª–æ—Ç–æ –ø–æ—Ç–µ—Ä—è–Ω–æ, —Å–µ—Ä–∏—è —Å–±—Ä–æ—à–µ–Ω–∞. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ 50 HP.");
        }
        localStorage.setItem('heroRPG_v7', JSON.stringify(state));
        render();
    }

    function render() {
        document.getElementById('gold-val').innerText = state.gold;
        document.getElementById('hp-val').innerText = `${state.hp}/100`;
        document.getElementById('hp-bar').style.width = `${Math.max(0, state.hp)}%`;
        
        const streak Badge = document.getElementById('streak-badge');
        if(state.streak.count > 0) {
            streakBadge.innerText = `üî• ${state.streak.count} –¥–Ω. (+${state.streak.count*5}üí∞)`;
            streakBadge.style.display = 'block';
        } else {
            streakBadge.style.display = 'none';
        }

        let totalLvl = 0; for(let s in state.skills) totalLvl += state.skills[s].lvl;
        const base = document.getElementById('hero-base');
        if(totalLvl <= 5) base.innerText = "üë∂"; else if(totalLvl <= 15) base.innerText = "üèπ"; else base.innerText = "‚öîÔ∏è";

        const todayIdx = (new Date().getDay() + 6) % 7;
        const todayQuests = state.quests.filter(q => parseInt(q.day) === todayIdx);
        document.getElementById('quest-list').innerHTML = todayQuests.map((q, i) => {
            const gIdx = state.quests.indexOf(q);
            const streakBonus = state.streak.count * 5;
            const reward = (q.isBoss ? 150 : 50) + streakBonus;
            return `<div class="quest ${q.isBoss?'boss':''} ${q.done?'done':''}">
                <span>${q.isBoss?'üëπ ':''}${q.title}</span>
                ${q.done ? '‚úÖ' : `<button class="btn-complete" onclick="complete(event, ${gIdx})" style="padding:8px 12px; font-weight:bold;">+${reward}üí∞</button>`}
            </div>`;
        }).join('') || '<div style="text-align:center; padding:30px; color:var(--hint); font-size: 18px;">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å—ë —á–∏—Å—Ç–æ! üéâ</div>';

        const sNames = {money:'–î–µ–Ω—å–≥–∏', education:'–ó–Ω–∞–Ω–∏—è', health:'–°–∏–ª–∞', english:'English'};
        document.getElementById('skills-box').innerHTML = Object.keys(state.skills).map(k => `
            <div style="margin-bottom:10px">
                <div style="display:flex;justify-content:space-between;font-size:13px; margin-bottom: 3px;"><span>${sNames[k]} (Lvl ${state.skills[k].lvl})</span><span>${state.skills[k].xp}/100</span></div>
                <div class="bar-bg"><div class="bar-fill" style="width:${state.skills[k].xp}%"></div></div>
            </div>`).join('');

        document.getElementById('stat-q').innerText = state.history.totalCompleted;
        document.getElementById('stat-b').innerText = state.history.bossesDefeated;
        document.getElementById('stat-s').innerText = state.history.maxStreak;
    }

    window.complete = function(event, idx) {
        const q = state.quests[idx];
        if(q.done) return;
        
        // VFX: –ß–∞—Å—Ç–∏—Ü—ã
        const rect = event.target.getBoundingClientRect();
        spawnParticles(rect.left + rect.width/2, rect.top, 'üí∞');

        q.done = true;
        const streakBonus = state.streak.count * 5;
        state.gold += (q.isBoss ? 150 : 50) + streakBonus;
        
        state.history.totalCompleted++;
        if(q.isBoss) state.history.bossesDefeated++;
        
        const s = state.skills[q.cat];
        s.xp += (q.isBoss ? 50 : 25);
        if(s.xp >= 100) { 
            s.xp = 0; 
            s.lvl++; 
            triggerFlash(); // VFX: –í—Å–ø—ã—à–∫–∞ —É—Ä–æ–≤–Ω—è
            tg.HapticFeedback.notificationOccurred('success');
        }
        tg.HapticFeedback.impactOccurred('medium');
        save();
    };

    window.usePotion = function(type) {
        if(type === 'hp' && state.gold >= 150) {
            state.gold -= 150;
            state.hp = Math.min(100, state.hp + 30);
            spawnParticles(window.innerWidth/2, window.innerHeight/2, '‚ù§Ô∏è');
            tg.HapticFeedback.notificationOccurred('success');
        } else if(type === 'xp' && state.gold >= 500) {
            const cat = prompt("–ö–∞—Ç–µ–≥–æ—Ä–∏—è (money, education, health, english):", "money");
            if(state.skills[cat] && cat) {
                state.gold -= 500;
                state.skills[cat].xp += 50;
                spawnParticles(window.innerWidth/2, window.innerHeight/2, '‚ö°');
                if(state.skills[cat].xp >= 100) { state.skills[cat].xp = 0; state.skills[cat].lvl++; triggerFlash(); }
            }
        } else { alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞ –∏–ª–∏ –æ—Ç–º–µ–Ω–∞!"); }
        save();
    };

    window.showTab = function(t) {
        ['today', 'shop', 'profile'].forEach(id => document.getElementById('tab-'+id).classList.add('hidden'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    };

    function togglePlanner(s) { document.getElementById('planner-modal').style.display = s?'block':'none'; }
    window.addQ = function() {
        const t = document.getElementById('q-title').value;
        if(!t) return;
        state.quests.push({ title: t, day: document.getElementById('q-day').value, cat: document.getElementById('q-cat').value, isBoss: document.getElementById('q-isboss').checked, done: false });
        togglePlanner(false);
        save();
    }

    dailyRoutineCheck();
    render();
</script>
</body>
</html>
