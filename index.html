<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero RPG: Calendar & VFX</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #1a1a1a);
            --text: var(--tg-theme-text-color, #ffffff);
            --hint: var(--tg-theme-hint-color, #aaaaaa);
            --btn: var(--tg-theme-button-color, #3390ec);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --gold: #f1c40f;
            --boss: #eb4d4b;
            --hp: #ff4757;
            --streak: #e67e22;
        }

        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; padding: 16px; padding-bottom: 100px; overflow-x: hidden; }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 25% { transform: translate(-4px, 2px); } 50% { transform: translate(4px, -2px); } 75% { transform: translate(-2px, -2px); } }
        .shake-screen { animation: shake 0.4s ease-in-out; }
        
        .particle { position: fixed; pointer-events: none; font-size: 20px; z-index: 9999; animation: fly-up 0.8s ease-out forwards; }
        @keyframes fly-up { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-80px) scale(1.5); } }

        /* –®–∞–ø–∫–∞ –≥–µ—Ä–æ—è */
        .hero-section { text-align: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 20px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .streak-tag { position: absolute; top: 10px; right: 10px; background: var(--streak); color: white; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 11px; }
        .hero-display { font-size: 40px; display: flex; justify-content: center; align-items: center; gap: 8px; min-height: 50px; }

        /* –¢–∞–±—ã */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px 5px; border-radius: 10px; background: rgba(255,255,255,0.08); color: var(--text); font-size: 10px; border: none; font-weight: bold; text-transform: uppercase; }
        .tab-btn.active { background: var(--btn); color: var(--btn-text); }

        /* –°–ø–∏—Å–∫–∏ –∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .card { background: rgba(255,255,255,0.06); border-radius: 16px; padding: 15px; margin-bottom: 10px; }
        .quest { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.04); border-radius: 12px; margin-bottom: 8px; border-left: 4px solid var(--btn); }
        .quest.boss { border-left-color: var(--boss); background: rgba(235, 77, 75, 0.1); }
        .quest.done { opacity: 0.3; }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
        .day-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 14px; margin-bottom: 8px; border: 1px solid transparent; }
        .day-item.active-day { border-color: var(--btn); background: rgba(51, 144, 236, 0.1); }
        .day-item .badge { background: var(--btn); padding: 2px 8px; border-radius: 10px; font-size: 10px; }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã */
        .bar-bg { background: rgba(0,0,0,0.3); height: 6px; border-radius: 3px; margin-top: 5px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.5s ease; background: var(--btn); }
        .hp-fill { background: var(--hp); }

        /* –ö–Ω–æ–ø–∫–∏ */
        .main-btn { background: var(--btn); color: var(--btn-text); border: none; padding: 14px; border-radius: 12px; width: 100%; font-weight: bold; font-size: 14px; }
        .action-btn { background: rgba(255,255,255,0.1); border: none; padding: 6px 12px; border-radius: 8px; color: #fff; font-size: 12px; }

        /* –ú–æ–¥–∞–ª–∫–∞ */
        #planner-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; display: none; padding: 20px; box-sizing: border-box; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); color: #fff; }

        .hidden { display: none; }
    </style>
</head>
<body id="main-body">

<div class="hero-section">
    <div class="streak-tag" id="streak-info">üî• 0 –¥–Ω.</div>
    <div class="hero-display">
        <span id="eq-head"></span><span id="hero-base">üë∂</span><span id="eq-weapon"></span>
    </div>
    <div id="hero-rank" style="font-size: 12px; color: var(--gold); margin: 5px 0;">–ù–æ–≤–∏—á–æ–∫</div>
    <div style="margin-top:10px">
        <div style="display:flex; justify-content:space-between; font-size:11px"><span>‚ù§Ô∏è HP</span><span id="hp-txt">100/100</span></div>
        <div class="bar-bg"><div id="hp-bar" class="bar-fill hp-fill" style="width:100%"></div></div>
    </div>
    <div style="margin-top:10px; font-weight: bold; color: var(--gold)">üí∞ <span id="gold-val">0</span></div>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="showTab('today')">–°–µ–≥–æ–¥–Ω—è</button>
    <button class="tab-btn" onclick="showTab('week')">–ù–µ–¥–µ–ª—è</button>
    <button class="tab-btn" onclick="showTab('shop')">–ú–∞–≥–∞–∑–∏–Ω</button>
    <button class="tab-btn" onclick="showTab('profile')">–ì–µ—Ä–æ–π</button>
</div>

<div id="tab-today" class="tab-content">
    <div id="quest-list"></div>
    <button class="main-btn" style="margin-top:10px" onclick="togglePlanner(true)">Ôºã –î–û–ë–ê–í–ò–¢–¨ –ó–ê–î–ê–ß–£</button>
</div>

<div id="tab-week" class="tab-content hidden">
    <h3 style="font-size: 16px;">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–µ–¥–µ–ª–∏</h3>
    <div id="calendar-view"></div>
    <div id="day-detail" class="hidden" style="margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
        <h4 id="selected-day-name">–ó–∞–¥–∞—á–∏</h4>
        <div id="selected-day-quests"></div>
    </div>
</div>

<div id="tab-shop" class="tab-content hidden">
    <h3>–õ–∞–≤–∫–∞ –∞–ª—Ö–∏–º–∏–∫–∞</h3>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px">
        <div class="card" onclick="buyItem('hp')" style="text-align:center">üß™<br><small>–ó–µ–ª—å–µ –û–ó (+30)</small><br><b style="color:var(--gold)">150</b></div>
        <div class="card" onclick="buyItem('xp')" style="text-align:center">‚ö°<br><small>–ó–µ–ª—å–µ –û–ü (+50)</small><br><b style="color:var(--gold)">500</b></div>
    </div>
    <h3>–ö—É–∑–Ω–∏—Ü–∞</h3>
    <div id="gear-list"></div>
</div>

<div id="tab-profile" class="tab-content hidden">
    <div class="card" id="skills-list"></div>
    <div class="card">
        <h4>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
        <div style="font-size:12px; color:var(--hint)">
            –ö–≤–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ: <span id="stat-q">0</span><br>
            –ë–æ—Å—Å–æ–≤ –ø–æ–≤–µ—Ä–∂–µ–Ω–æ: <span id="stat-b">0</span><br>
            –õ—É—á—à–∞—è —Å–µ—Ä–∏—è: <span id="stat-s">0</span> –¥–Ω.
        </div>
    </div>
</div>

<div id="planner-modal">
    <h3>–ù–æ–≤—ã–π –∫–≤–µ—Å—Ç</h3>
    <input type="text" id="q-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –ó–∞–ª, –ö–Ω–∏–≥–∞...)">
    <select id="q-day">
        <option value="0">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</option><option value="1">–í—Ç–æ—Ä–Ω–∏–∫</option>
        <option value="2">–°—Ä–µ–¥–∞</option><option value="3">–ß–µ—Ç–≤–µ—Ä–≥</option>
        <option value="4">–ü—è—Ç–Ω–∏—Ü–∞</option><option value="5">–°—É–±–±–æ—Ç–∞</option>
        <option value="6">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</option>
    </select>
    <select id="q-cat">
        <option value="money">üí∞ –î–µ–Ω—å–≥–∏</option><option value="education">üéì –ó–Ω–∞–Ω–∏—è</option>
        <option value="health">üí™ –°–∏–ª–∞</option><option value="english">üá¨üáß English</option>
    </select>
    <div style="margin: 15px 0"><input type="checkbox" id="q-boss"> <label for="q-boss" style="color:var(--boss)">üëπ –≠–¢–û –ë–û–°–°</label></div>
    <button class="main-btn" onclick="addQuest()">–î–û–ë–ê–í–ò–¢–¨ –í –ü–õ–ê–ù</button>
    <button onclick="togglePlanner(false)" style="background:none; border:none; color:var(--hint); width:100%; margin-top:15px">–û—Ç–º–µ–Ω–∞</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
    const ITEMS = {
        'sword': { name: '–ú–µ—á', icon: 'üó°Ô∏è', price: 300, slot: 'weapon' },
        'helmet': { name: '–®–ª–µ–º', icon: 'ü™ñ', price: 400, slot: 'head' }
    };

    let state = JSON.parse(localStorage.getItem('heroRPG_v8')) || {
        gold: 0, hp: 100,
        skills: { money: {xp:0, lvl:1}, education: {xp:0, lvl:1}, health: {xp:0, lvl:1}, english: {xp:0, lvl:1} },
        quests: [], inventory: [], equipped: { head: null, weapon: null },
        streak: 0, lastCheck: null,
        stats: { q: 0, b: 0, s: 0 }
    };

    function save() {
        localStorage.setItem('heroRPG_v8', JSON.stringify(state));
        render();
    }

    // VFX
    function spawnParticles(x, y) {
        for(let i=0; i<6; i++) {
            const p = document.createElement('div');
            p.className = 'particle'; p.innerText = 'üí∞';
            p.style.left = (x + (Math.random()-0.5)*40) + 'px';
            p.style.top = y + 'px';
            document.body.appendChild(p);
            setTimeout(() => p.remove(), 800);
        }
    }

    function shake() {
        document.getElementById('main-body').classList.add('shake-screen');
        setTimeout(() => document.getElementById('main-body').classList.remove('shake-screen'), 400);
    }

    // –õ–æ–≥–∏–∫–∞ –¥–Ω–µ–π –∏ —Å–µ—Ä–∏–π
    function dailyCheck() {
        const todayStr = new Date().toDateString();
        if (state.lastCheck !== todayStr) {
            const yesterdayDate = new Date();
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yIdx = (yesterdayDate.getDay() + 6) % 7;

            const yQuests = state.quests.filter(q => parseInt(q.day) === yIdx);
            if (yQuests.length > 0) {
                const failed = yQuests.filter(q => !q.done).length;
                if (failed === 0) {
                    state.streak++;
                    if (state.streak > state.stats.s) state.stats.s = state.streak;
                } else {
                    state.streak = 0;
                    state.hp -= (failed * 10);
                    shake();
                }
            }
            state.lastCheck = todayStr;
            save();
        }
    }

    function render() {
        // –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        document.getElementById('gold-val').innerText = state.gold;
        document.getElementById('hp-txt').innerText = `${Math.max(0, state.hp)}/100`;
        document.getElementById('hp-bar').style.width = `${Math.max(0, state.hp)}%`;
        document.getElementById('streak-info').innerText = `üî• ${state.streak} –¥–Ω.`;

        // –ì–µ—Ä–æ–π
        let totalLvl = 0; for(let s in state.skills) totalLvl += state.skills[s].lvl;
        document.getElementById('hero-base').innerText = totalLvl > 15 ? "‚öîÔ∏è" : (totalLvl > 5 ? "üèπ" : "üë∂");
        document.getElementById('eq-head').innerText = state.equipped.head ? ITEMS[state.equipped.head].icon : '';
        document.getElementById('eq-weapon').innerText = state.equipped.weapon ? ITEMS[state.equipped.weapon].icon : '';

        // –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –∑–∞–¥–∞—á–∏
        const tIdx = (new Date().getDay() + 6) % 7;
        const tQuests = state.quests.filter(q => parseInt(q.day) === tIdx);
        document.getElementById('quest-list').innerHTML = tQuests.length ? tQuests.map(q => {
            const gIdx = state.quests.indexOf(q);
            return `
            <div class="quest ${q.isBoss?'boss':''} ${q.done?'done':''}">
                <span>${q.isBoss?'üëπ ':''}${q.title}</span>
                ${q.done ? '‚úÖ' : `<button class="action-btn" onclick="completeQuest(event, ${gIdx})">+${q.isBoss?150:50}</button>`}
            </div>`;
        }).join('') : '<p style="text-align:center; color:var(--hint)">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–¥–∞—á –Ω–µ—Ç</p>';

        // –ö–∞–ª–µ–Ω–¥–∞—Ä—å
        document.getElementById('calendar-view').innerHTML = DAYS.map((d, i) => {
            const count = state.quests.filter(q => parseInt(q.day) === i && !q.done).length;
            return `<div class="day-item ${i===tIdx?'active-day':''}" onclick="viewDay(${i})">
                <span>${d}</span>
                ${count > 0 ? `<span class="badge">${count}</span>` : '‚úÖ'}
            </div>`;
        }).join('');

        // –ü—Ä–æ—Ñ–∏–ª—å –∏ –Ω–∞–≤—ã–∫–∏
        const sNames = {money:'–î–µ–Ω—å–≥–∏', education:'–ó–Ω–∞–Ω–∏—è', health:'–°–∏–ª–∞', english:'English'};
        document.getElementById('skills-list').innerHTML = Object.keys(state.skills).map(k => `
            <div style="margin-bottom:10px">
                <div style="display:flex; justify-content:space-between; font-size:12px"><span>${sNames[k]} Lvl ${state.skills[k].lvl}</span><span>${state.skills[k].xp}%</span></div>
                <div class="bar-bg"><div class="bar-fill" style="width:${state.skills[k].xp}%"></div></div>
            </div>`).join('');
        
        document.getElementById('stat-q').innerText = state.stats.q;
        document.getElementById('stat-b').innerText = state.stats.b;
        document.getElementById('stat-s').innerText = state.stats.s;

        // –ú–∞–≥–∞–∑–∏–Ω (—Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ)
        document.getElementById('gear-list').innerHTML = Object.keys(ITEMS).map(k => `
            <div class="day-item">
                <span>${ITEMS[k].icon} ${ITEMS[k].name}</span>
                <button class="action-btn" onclick="buyGear('${k}')">${state.inventory.includes(k)?'–ù–∞–¥–µ—Ç—å':ITEMS[k].price+'üí∞'}</button>
            </div>`).join('');
    }

    window.completeQuest = function(e, idx) {
        const q = state.quests[idx];
        if(q.done) return;
        spawnParticles(e.clientX, e.clientY);
        q.done = true;
        const bonus = state.streak * 5;
        state.gold += (q.isBoss ? 150 : 50) + bonus;
        state.stats.q++;
        if(q.isBoss) state.stats.b++;
        
        const s = state.skills[q.cat];
        s.xp += (q.isBoss ? 50 : 25);
        if(s.xp >= 100) { s.xp = 0; s.lvl++; tg.HapticFeedback.notificationOccurred('success'); }
        tg.HapticFeedback.impactOccurred('medium');
        save();
    };

    window.viewDay = function(idx) {
        const dQuests = state.quests.filter(q => parseInt(q.day) === idx);
        document.getElementById('day-detail').classList.remove('hidden');
        document.getElementById('selected-day-name').innerText = `–ó–∞–¥–∞—á–∏ –Ω–∞ ${DAYS[idx]}`;
        document.getElementById('selected-day-quests').innerHTML = dQuests.length ? dQuests.map(q => `
            <div class="quest ${q.done?'done':''}"><span>${q.title}</span><span>${q.done?'‚úÖ':'‚è≥'}</span></div>
        `).join('') : '<p style="font-size:12px; color:var(--hint)">–ó–∞–¥–∞—á –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</p>';
    };

    window.showTab = function(t) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    };

    window.togglePlanner = (s) => document.getElementById('planner-modal').style.display = s?'block':'none';

    window.addQuest = function() {
        const title = document.getElementById('q-title').value;
        if(!title) return;
        state.quests.push({
            title, 
            day: document.getElementById('q-day').value,
            cat: document.getElementById('q-cat').value,
            isBoss: document.getElementById('q-boss').checked,
            done: false
        });
        document.getElementById('q-title').value = '';
        togglePlanner(false);
        save();
    };

    window.buyItem = function(type) {
        if(type === 'hp' && state.gold >= 150) {
            state.gold -= 150; state.hp = Math.min(100, state.hp + 30);
        } else if(type === 'xp' && state.gold >= 500) {
            const c = prompt("–ö—É–¥–∞ –¥–∞—Ç—å –æ–ø—ã—Ç? (money, education, health, english)", "money");
            if(state.skills[c]) { state.gold -= 500; state.skills[c].xp += 50; if(state.skills[c].xp>=100){state.skills[c].xp=0; state.skills[c].lvl++;} }
        } else alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∑–æ–ª–æ—Ç–∞!");
        save();
    };

    window.buyGear = function(id) {
        if(state.inventory.includes(id)) {
            const slot = ITEMS[id].slot;
            state.equipped[slot] = state.equipped[slot] === id ? null : id;
        } else if(state.gold >= ITEMS[id].price) {
            state.gold -= ITEMS[id].price; state.inventory.push(id);
        } else alert("–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ –∑–æ–ª–æ—Ç–∞!");
        save();
    };

    dailyCheck();
    render();
</script>
</body>
</html>
