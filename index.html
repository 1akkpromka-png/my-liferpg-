<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero RPG: Cyberpunk Protocol</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #050505;
            --neon-blue: #00ffff;
            --neon-pink: #ff00ff;
            --neon-yellow: #fdf001;
            --hp-red: #ff2a6d;
            --card-bg: rgba(15, 15, 15, 0.9);
            --border-glow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg);
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            color: #e0e0e0;
            font-family: 'Courier New', Courier, monospace;
            margin: 0; padding: 16px; padding-bottom: 120px;
            min-height: 100vh;
        }

        /* --- –ö–ò–ë–ï–†-–ö–ê–†–¢–û–ß–ö–ò --- */
        .cyber-card {
            background: var(--card-bg);
            border: 1px solid var(--neon-blue);
            box-shadow: var(--border-glow);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
        }

        .cyber-card::after {
            content: "SYSTEM.LOG"; position: absolute; top: 2px; right: 10px;
            font-size: 8px; color: var(--neon-blue); opacity: 0.5;
        }

        /* --- –ü–ï–†–°–û–ù–ê–ñ –ò –ê–£–†–ê --- */
        .aura-wrapper {
            width: 130px; height: 130px; margin: 0 auto;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            position: relative; transition: all 0.5s; border: 1px solid transparent;
        }
        
        .aura-scan {
            position: absolute; inset: -5px; border: 2px solid var(--neon-blue);
            border-radius: 50%; opacity: 0.3;
            animation: scan 3s linear infinite;
        }
        @keyframes scan { 
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 0.2; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        .hero-avatar { font-size: 50px; display: flex; align-items: center; z-index: 5; position: relative; }
        #vis-head { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 35px; z-index: 6; }
        #vis-weap { position: absolute; right: -25px; font-size: 35px; transform: scaleX(-1); z-index: 6; }

        .cyber-bar-container {
            height: 12px; background: #111; border: 1px solid #333;
            margin: 10px 0; position: relative; overflow: hidden;
        }
        .cyber-bar-fill { height: 100%; transition: width 0.6s ease; position: relative; }

        /* --- –¢–ê–ë–´ --- */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn {
            background: transparent; border: 1px solid var(--neon-blue);
            color: var(--neon-blue); padding: 10px 15px; font-weight: bold;
            font-family: inherit; font-size: 11px; text-transform: uppercase;
        }
        .tab-btn.active { background: var(--neon-blue); color: #000; box-shadow: 0 0 15px var(--neon-blue); }

        .quest-box {
            background: rgba(0, 255, 255, 0.03); border: 1px solid rgba(0, 255, 255, 0.1);
            padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .quest-box.done { opacity: 0.3; border-color: #333; }

        .btn-cyber {
            width: 100%; padding: 15px; background: transparent; 
            border: 2px solid var(--neon-pink); color: var(--neon-pink);
            font-weight: bold; font-family: inherit; text-transform: uppercase;
            margin-top: 10px;
        }

        #modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 9999; display: none; padding: 25px; border: 2px solid var(--neon-blue);
        }
        input, select {
            width: 100%; background: #111; border: 1px solid var(--neon-blue);
            padding: 12px; color: var(--neon-blue); margin-bottom: 15px; font-family: inherit;
        }
        .hidden { display: none !important; }

        /* Loader */
        #loader {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

<div id="loader">
    <div style="color: var(--neon-blue); font-size: 18px; margin-bottom: 10px;">> CONNECTING_TO_GRID...</div>
    <div style="width: 200px; height: 2px; background: #222;">
        <div id="load-bar" style="width: 0%; height: 100%; background: var(--neon-blue); transition: width 0.3s;"></div>
    </div>
</div>

<div class="cyber-card">
    <div style="display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 10px;">
        <span id="rank-txt">USER_ID: UNKNOWN</span>
        <span id="total-lvl">LVL: 01</span>
    </div>

    <div class="aura-wrapper" id="aura">
        <div class="aura-scan"></div>
        <div class="hero-avatar">
            <span id="vis-head"></span>
            <span id="vis-body">üë∂</span>
            <span id="vis-weap"></span>
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; margin-top: 20px; font-size: 12px; font-weight: bold;">
        <span style="color: var(--hp-red);">HP: <span id="hp-val">100</span></span>
        <span style="color: var(--neon-yellow);">CREDITS: <span id="gold-val">0</span></span>
    </div>
    <div class="cyber-bar-container">
        <div id="hp-bar" class="cyber-bar-fill" style="background: var(--hp-red); width: 100%;"></div>
    </div>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab(event, 'tasks')">TASKS</button>
    <button class="tab-btn" onclick="switchTab(event, 'shop')">ARMORY</button>
    <button class="tab-btn" onclick="switchTab(event, 'piggy')">VAULT</button>
    <button class="tab-btn" onclick="switchTab(event, 'hero')">STATUS</button>
</div>

<div id="tab-tasks">
    <div id="quest-list"></div>
    <button class="btn-cyber" onclick="openModal()">+ INITIALIZE_QUEST</button>
</div>

<div id="tab-shop" class="hidden">
    <div class="cyber-card">
        <div style="color: var(--neon-blue); margin-bottom: 10px;">> BLACK_MARKET</div>
        <div id="shop-gear-list"></div>
        <div style="margin: 20px 0; border-top: 1px dashed #444;"></div>
        <div id="shop-perks-list"></div>
    </div>
</div>

<div id="tab-piggy" class="hidden">
    <div class="cyber-card" style="border-color: var(--neon-yellow);">
        <div id="piggy-content"></div>
    </div>
</div>

<div id="tab-hero" class="hidden">
    <div id="skills-list"></div>
</div>

<div id="modal-overlay">
    <h3 style="color: var(--neon-blue);">NEW_DATA_ENTRY</h3>
    <input type="text" id="inp-title" placeholder="QUEST_NAME">
    <div style="display: flex; gap: 10px;">
        <input type="time" id="inp-start">
        <input type="time" id="inp-end">
    </div>
    <select id="inp-day">
        <option value="0">MONDAY</option><option value="1">TUESDAY</option>
        <option value="2">WEDNESDAY</option><option value="3">THURSDAY</option>
        <option value="4">FRIDAY</option><option value="5">SATURDAY</option><option value="6">SUNDAY</option>
    </select>
    <select id="inp-cat" onchange="document.getElementById('inp-custom').classList.toggle('hidden', this.value !== 'new_cat')">
        <option value="money">MONEY_NODE</option>
        <option value="education">INTEL_NODE</option>
        <option value="health">BIO_NODE</option>
        <option value="new_cat">++ ADD_NEW_NODE</option>
    </select>
    <input type="text" id="inp-custom" class="hidden" placeholder="NODE_ID_NAME">
    <button class="btn-cyber" style="border-color: var(--neon-blue); color: var(--neon-blue);" onclick="saveQuest()">UPLOAD</button>
    <button onclick="closeModal()" style="width: 100%; background: none; border: none; color: #555; margin-top: 15px;">ABORT</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const DB = {
        gear: {
            'h1': { name: 'CYBER_HELM', icon: 'ü™ñ', price: 500, slot: 'head' },
            'h2': { name: 'NEON_CROWN', icon: 'üëë', price: 2500, slot: 'head' },
            'w1': { name: 'DATA_BLADE', icon: 'üó°Ô∏è', price: 800, slot: 'weapon' },
            'w2': { name: 'LINK_STAFF', icon: 'ü™Ñ', price: 1500, slot: 'weapon' }
        },
        perks: {
            'gold_boost': { name: 'OVERCLOCK', desc: '+20% CREDITS', price: 1000 },
            'def': { name: 'FIREWALL', desc: '-50% DMG TAKEN', price: 1500 }
        }
    };

    let state = {
        gold: 0, hp: 100, lastLogin: new Date().toDateString(),
        skills: { money: {lvl:1, xp:0}, education: {lvl:1, xp:0}, health: {lvl:1, xp:0} },
        quests: [], inventory: [], perks: [],
        equipped: { head: null, weapon: null },
        piggy: { active: false, title: '', goal: 0, current: 0 }
    };

    let isLoaded = false;

    // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    function init() {
        // –¢–∞–π–º–µ—Ä –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        let p = 0;
        const bar = document.getElementById('load-bar');
        const interval = setInterval(() => {
            p += 5; bar.style.width = p + '%';
            if(p >= 90) clearInterval(interval);
        }, 50);

        // –ü—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å: –µ—Å–ª–∏ –æ–±–ª–∞–∫–æ –Ω–µ –æ—Ç–≤–µ—Ç–∏—Ç –∑–∞ 2 —Å–µ–∫, –∏–¥–µ–º –¥–∞–ª—å—à–µ
        const cloudTimeout = setTimeout(() => {
            if(!isLoaded) finalizeInit("TIMEOUT_FALLBACK");
        }, 2000);

        tg.CloudStorage.getItem('cyber_save_v23', (err, value) => {
            clearTimeout(cloudTimeout);
            if(!isLoaded) {
                if(!err && value) {
                    try { state = JSON.parse(value); } catch(e) {}
                } else {
                    const local = localStorage.getItem('cyber_save_v23');
                    if(local) try { state = JSON.parse(local); } catch(e) {}
                }
                finalizeInit("CLOUD_SUCCESS");
            }
        });
    }

    function finalizeInit(reason) {
        isLoaded = true;
        console.log("Init finished via:", reason);
        document.getElementById('load-bar').style.width = '100%';
        checkDailyPenalty();
        render();
        setTimeout(() => {
            document.getElementById('loader').style.display = 'none';
        }, 500);
    }

    function save() {
        const data = JSON.stringify(state);
        localStorage.setItem('cyber_save_v23', data);
        tg.CloudStorage.setItem('cyber_save_v23', data);
        render();
    }

    function checkDailyPenalty() {
        const today = new Date().toDateString();
        if(state.lastLogin !== today) {
            const yesterday = (new Date().getDay() + 5) % 7;
            const missed = state.quests.filter(q => parseInt(q.day) === yesterday && !q.done);
            if(missed.length > 0) {
                let dmg = missed.length * 15;
                if(state.perks.includes('def')) dmg = Math.floor(dmg/2);
                state.hp = Math.max(0, state.hp - dmg);
            }
            state.lastLogin = today;
            save();
        }
    }

    function render() {
        document.getElementById('gold-val').innerText = state.gold;
        document.getElementById('hp-val').innerText = state.hp;
        document.getElementById('hp-bar').style.width = state.hp + '%';

        let totalLvl = 0;
        for(let s in state.skills) totalLvl += state.skills[s].lvl;
        document.getElementById('total-lvl').innerText = 'LVL: ' + (totalLvl < 10 ? '0'+totalLvl : totalLvl);
        
        // –†–∞–Ω–≥
        let r = "NOVICE_USER";
        if(totalLvl > 10) r = "SYSTEM_ADMIN";
        if(totalLvl > 30) r = "NET_RUNNER";
        document.getElementById('rank-txt').innerText = "ID: " + r;

        document.getElementById('vis-head').innerText = state.equipped.head ? DB.gear[state.equipped.head].icon : '';
        document.getElementById('vis-weap').innerText = state.equipped.weapon ? DB.gear[state.equipped.weapon].icon : '';

        const today = (new Date().getDay() + 6) % 7;
        const dailyQuests = state.quests.filter(q => parseInt(q.day) === today);
        document.getElementById('quest-list').innerHTML = dailyQuests.map((q, i) => {
            const gIdx = state.quests.indexOf(q);
            return `
                <div class="quest-box ${q.done ? 'done' : ''}">
                    <div><div style="font-size:9px; color:var(--neon-blue)">[${q.cat.toUpperCase()}]</div><b>${q.title}</b></div>
                    ${q.done ? `<button onclick="deleteQuest(${gIdx})" style="background:none; border:none; color:var(--hp-red)">[DEL]</button>` : 
                    `<button onclick="completeQuest(${gIdx})" style="background:var(--neon-blue); border:none; padding:5px 10px; font-weight:bold">OK</button>`}
                </div>`;
        }).join('') || '<div style="opacity:0.3; padding:20px;">NO_DATA_NODES</div>';

        renderShop();
        renderPiggy();

        document.getElementById('skills-list').innerHTML = Object.keys(state.skills).map(k => `
            <div class="cyber-card">
                <div style="display:flex; justify-content:space-between; font-size:10px; margin-bottom:5px;"><span>${k.toUpperCase()}</span><span>LVL ${state.skills[k].lvl}</span></div>
                <div class="cyber-bar-container"><div class="cyber-bar-fill" style="width:${state.skills[k].xp}%; background:var(--neon-blue)"></div></div>
            </div>`).join('');
    }

    function renderShop() {
        let gearHTML = "";
        for(let k in DB.gear) {
            const it = DB.gear[k]; const has = state.inventory.includes(k); const eq = state.equipped[it.slot] === k;
            gearHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>${it.icon} ${it.name}</span>
                <button onclick="handleGear('${k}')" style="background:${has?(eq?'var(--hp-red)':'var(--neon-blue)'):'var(--neon-yellow)'}; border:none; padding:5px; font-size:10px; font-weight:bold;">
                ${has?(eq?'OFF':'ON'):it.price}</button></div>`;
        }
        document.getElementById('shop-gear-list').innerHTML = gearHTML;

        let perkHTML = "";
        for(let k in DB.perks) {
            const p = DB.perks[k]; const has = state.perks.includes(k);
            perkHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span>${p.name}</span>
                <button onclick="buyPerk('${k}')" ${has?'disabled':''} style="background:${has?'#333':'var(--neon-pink)'}; border:none; font-size:10px; font-weight:bold;">
                ${has?'OWNED':p.price}</button></div>`;
        }
        document.getElementById('shop-perks-list').innerHTML = perkHTML;
    }

    function renderPiggy() {
        const p = state.piggy; const box = document.getElementById('piggy-content');
        if(!p.active) {
            box.innerHTML = `<button class="btn-cyber" onclick="startPiggy()">INIT_VAULT</button>`;
        } else {
            box.innerHTML = `<b>${p.title}</b><br><small>${p.current}/${p.goal}</small>
            <button class="btn-cyber" onclick="depositPiggy()">+ DEPOSIT</button>
            <button onclick="state.piggy.active=false; save();" style="background:none; border:none; color:#555; font-size:9px;">RESET</button>`;
        }
    }

    window.switchTab = (e, name) => {
        tg.HapticFeedback.impactOccurred('light');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('[id^="tab-"]').forEach(t => t.classList.add('hidden'));
        document.getElementById('tab-'+name).classList.remove('hidden');
    };

    window.openModal = () => document.getElementById('modal-overlay').style.display = 'block';
    window.closeModal = () => document.getElementById('modal-overlay').style.display = 'none';

    window.saveQuest = () => {
        const title = document.getElementById('inp-title').value; if(!title) return;
        let cat = document.getElementById('inp-cat').value;
        if(cat === 'new_cat') {
            cat = document.getElementById('inp-custom').value || 'misc';
            if(!state.skills[cat]) state.skills[cat] = {lvl:1, xp:0};
        }
        state.quests.push({ title, cat, day: document.getElementById('inp-day').value, start: document.getElementById('inp-start').value, done: false });
        closeModal(); save();
    };

    window.completeQuest = (idx) => {
        tg.HapticFeedback.notificationOccurred('success');
        const q = state.quests[idx]; q.done = true;
        state.gold += state.perks.includes('gold_boost') ? 60 : 50;
        if(state.skills[q.cat]) {
            state.skills[q.cat].xp += 25;
            if(state.skills[q.cat].xp >= 100) { state.skills[q.cat].xp = 0; state.skills[q.cat].lvl++; }
        }
        save();
    };

    window.deleteQuest = (idx) => { state.quests.splice(idx, 1); save(); };

    window.handleGear = (k) => {
        const it = DB.gear[k];
        if(state.inventory.includes(k)) { state.equipped[it.slot] = state.equipped[it.slot] === k ? null : k; }
        else if(state.gold >= it.price) { state.gold -= it.price; state.inventory.push(k); state.equipped[it.slot] = k; }
        save();
    };

    window.buyPerk = (k) => {
        if(state.gold >= DB.perks[k].price) { state.gold -= DB.perks[k].price; state.perks.push(k); save(); }
    };

    window.startPiggy = () => {
        const t = prompt('GOAL:'); const g = parseInt(prompt('AMOUNT:'));
        if(t && g) { state.piggy = { active: true, title: t, goal: g, current: 0 }; save(); }
    };

    window.depositPiggy = () => {
        const v = parseInt(prompt('AMOUNT:'));
        if(v > 0) { 
            state.piggy.current += v; 
            if(v >= 100) { state.skills.money.xp += 20; if(state.skills.money.xp >= 100) { state.skills.money.xp = 0; state.skills.money.lvl++; } }
            save(); 
        }
    };

    init();
</script>
</body>
</html>
