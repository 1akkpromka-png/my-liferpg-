<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero RPG: Cyberpunk Protocol</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: #050505;
            --neon-blue: #00ffff;
            --neon-pink: #ff00ff;
            --neon-yellow: #fdf001;
            --hp-red: #ff2a6d;
            --card-bg: rgba(15, 15, 15, 0.9);
            --border-glow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: var(--bg);
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 30px 30px; /* –°–µ—Ç–∫–∞ –Ω–∞ —Ñ–æ–Ω–µ */
            color: #e0e0e0;
            font-family: 'Courier New', Courier, monospace;
            margin: 0; padding: 16px; padding-bottom: 120px;
            min-height: 100vh;
        }

        /* --- –ö–ò–ë–ï–†-–ö–ê–†–¢–û–ß–ö–ò --- */
        .cyber-card {
            background: var(--card-bg);
            border: 1px solid var(--neon-blue);
            box-shadow: var(--border-glow);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%);
        }

        .cyber-card::after {
            content: "SYSTEM.LOG"; position: absolute; top: 2px; right: 10px;
            font-size: 8px; color: var(--neon-blue); opacity: 0.5;
        }

        /* --- –ü–ï–†–°–û–ù–ê–ñ –ò –ê–£–†–ê --- */
        .aura-wrapper {
            width: 130px; height: 130px; margin: 0 auto;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            position: relative; transition: all 0.5s;
        }
        
        .aura-scan {
            position: absolute; inset: -5px; border: 2px solid var(--neon-blue);
            border-radius: 50%; opacity: 0.3;
            animation: scan 3s linear infinite;
        }
        @keyframes scan { 
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 0.2; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        .hero-avatar { font-size: 50px; display: flex; align-items: center; z-index: 5; }
        #vis-head { position: absolute; top: 15px; font-size: 35px; }
        #vis-weap { position: absolute; right: 5px; font-size: 35px; transform: scaleX(-1); }

        /* --- –ë–ê–†–´ –ü–†–û–ì–†–ï–°–°–ê --- */
        .cyber-bar-container {
            height: 12px; background: #111; border: 1px solid #333;
            margin: 10px 0; position: relative;
        }
        .cyber-bar-fill {
            height: 100%; transition: width 0.6s cubic-bezier(0.1, 0.7, 1.0, 0.1);
            position: relative;
        }
        .glitch-effect {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: bar-glitch 2s infinite;
        }
        @keyframes bar-glitch { 0% { left: -100%; } 100% { left: 100%; } }

        /* --- –¢–ê–ë–´ --- */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn {
            background: transparent; border: 1px solid var(--neon-blue);
            color: var(--neon-blue); padding: 10px 15px; font-weight: bold;
            font-family: inherit; cursor: pointer; text-transform: uppercase;
            font-size: 11px; clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
        }
        .tab-btn.active { background: var(--neon-blue); color: #000; box-shadow: 0 0 15px var(--neon-blue); }

        /* --- –°–ü–ò–°–û–ö –ó–ê–î–ê–ß --- */
        .quest-box {
            background: rgba(0, 255, 255, 0.03); border: 1px solid rgba(0, 255, 255, 0.1);
            padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        }
        .quest-box.done { opacity: 0.3; border-color: #333; text-decoration: line-through; }

        /* --- –ö–ù–û–ü–ö–ò --- */
        .btn-cyber {
            width: 100%; padding: 15px; background: transparent; 
            border: 2px solid var(--neon-pink); color: var(--neon-pink);
            font-weight: bold; font-family: inherit; text-transform: uppercase;
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.2); margin-top: 10px;
        }
        .btn-cyber:active { background: var(--neon-pink); color: #000; }

        /* --- –ú–û–î–ê–õ–ö–ê --- */
        #modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 9999; display: none; padding: 25px;
            border: 2px solid var(--neon-blue); margin: 10px;
        }
        input, select {
            width: 100%; background: #111; border: 1px solid var(--neon-blue);
            padding: 12px; color: var(--neon-blue); margin-bottom: 15px; font-family: inherit;
        }

        .hidden { display: none !important; }

        /* Loader */
        #loader {
            position: fixed; inset: 0; background: #000; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

<div id="loader">
    <div style="color: var(--neon-blue); font-size: 20px; margin-bottom: 10px;">> LOADING_CORE...</div>
    <div id="load-bar-wrap" style="width: 200px; height: 4px; background: #222;">
        <div id="load-bar" style="width: 0%; height: 100%; background: var(--neon-blue);"></div>
    </div>
</div>

<div class="cyber-card">
    <div style="display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 10px;">
        <span id="rank-txt">ID: NOVICE_PLAYER</span>
        <span id="total-lvl">LVL: 01</span>
    </div>

    <div class="aura-wrapper" id="aura">
        <div class="aura-scan"></div>
        <div class="hero-avatar">
            <span id="vis-head"></span>
            <span id="vis-body">üë∂</span>
            <span id="vis-weap"></span>
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; margin-top: 20px; font-size: 12px; font-weight: bold;">
        <span style="color: var(--hp-red);">HP: <span id="hp-val">100</span></span>
        <span style="color: var(--neon-yellow);">CREDITS: <span id="gold-val">0</span></span>
    </div>
    
    <div class="cyber-bar-container">
        <div id="hp-bar" class="cyber-bar-fill" style="background: var(--hp-red); width: 100%;">
            <div class="glitch-effect"></div>
        </div>
    </div>
</div>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab(event, 'tasks')">TASKS</button>
    <button class="tab-btn" onclick="switchTab(event, 'shop')">ARMORY</button>
    <button class="tab-btn" onclick="switchTab(event, 'piggy')">VAULT</button>
    <button class="tab-btn" onclick="switchTab(event, 'hero')">STATUS</button>
</div>

<div id="tab-tasks">
    <div id="quest-list"></div>
    <button class="btn-cyber" onclick="openModal()">+ INITIALIZE_QUEST</button>
</div>

<div id="tab-shop" class="hidden">
    <div class="cyber-card">
        <div style="color: var(--neon-blue); margin-bottom: 10px;">> BLACK_MARKET</div>
        <div id="shop-gear-list"></div>
        <div style="margin: 20px 0; border-top: 1px dashed #444;"></div>
        <div id="shop-perks-list"></div>
    </div>
</div>

<div id="tab-piggy" class="hidden">
    <div class="cyber-card" style="border-color: var(--neon-yellow);">
        <div style="color: var(--neon-yellow); margin-bottom: 15px;">> FINANCIAL_NODE</div>
        <div id="piggy-content"></div>
    </div>
</div>

<div id="tab-hero" class="hidden">
    <div id="skills-list"></div>
    <div class="cyber-card" style="margin-top: 10px;">
        <div style="color: var(--neon-blue); font-size: 11px; margin-bottom: 10px;">> WEEK_SCHEDULE</div>
        <div id="calendar-content"></div>
    </div>
</div>

<div id="modal-overlay">
    <h3 style="color: var(--neon-blue); margin-top: 0;">NEW_DATA_ENTRY</h3>
    <input type="text" id="inp-title" placeholder="QUEST_NAME">
    <div style="display: flex; gap: 10px;">
        <input type="time" id="inp-start">
        <input type="time" id="inp-end">
    </div>
    <select id="inp-day">
        <option value="0">MONDAY</option><option value="1">TUESDAY</option>
        <option value="2">WEDNESDAY</option><option value="3">THURSDAY</option>
        <option value="4">FRIDAY</option><option value="5">SATURDAY</option><option value="6">SUNDAY</option>
    </select>
    <select id="inp-cat" onchange="checkCustomCat(this.value)">
        <option value="money">MONEY_NODE</option>
        <option value="education">INTEL_NODE</option>
        <option value="health">BIO_NODE</option>
        <option value="new_cat">++ ADD_NEW_NODE</option>
    </select>
    <input type="text" id="inp-custom" class="hidden" placeholder="NODE_ID_NAME">
    
    <button class="btn-cyber" style="border-color: var(--neon-blue); color: var(--neon-blue);" onclick="saveQuest()">UPLOAD</button>
    <button onclick="closeModal()" style="width: 100%; background: none; border: none; color: #555; margin-top: 15px;">ABORT</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –ö–û–ù–°–¢–ê–ù–¢–´ –ë–î
    const DB = {
        gear: {
            'h1': { name: 'CYBER_HELM', icon: 'ü™ñ', price: 500, slot: 'head' },
            'h2': { name: 'NEON_CROWN', icon: 'üëë', price: 2500, slot: 'head' },
            'w1': { name: 'DATA_BLADE', icon: 'üó°Ô∏è', price: 800, slot: 'weapon' },
            'w2': { name: 'LINK_STAFF', icon: 'ü™Ñ', price: 1500, slot: 'weapon' }
        },
        perks: {
            'gold_boost': { name: 'OVERCLOCK', desc: '+20% CREDITS', price: 1000 },
            'def': { name: 'FIREWALL', desc: '-50% DMG TAKEN', price: 1500 }
        }
    };

    // –°–û–°–¢–û–Ø–ù–ò–ï
    let state = {
        gold: 0, hp: 100, lastLogin: new Date().toDateString(),
        skills: { money: {lvl:1, xp:0}, education: {lvl:1, xp:0}, health: {lvl:1, xp:0} },
        quests: [], inventory: [], perks: [],
        equipped: { head: null, weapon: null },
        piggy: { active: false, title: '', goal: 0, current: 0 }
    };

    // --- –°–ò–°–¢–ï–ú–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø (CLOUD + LOCAL) ---
    function init() {
        // –°–∏–º—É–ª—è—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        let progress = 0;
        const interval = setInterval(() => {
            progress += 10;
            document.getElementById('load-bar').style.width = progress + '%';
            if(progress >= 100) clearInterval(interval);
        }, 50);

        tg.CloudStorage.getItem('cyber_rpg_save', (err, value) => {
            if(!err && value) {
                state = JSON.parse(value);
            } else {
                const local = localStorage.getItem('cyber_rpg_save');
                if(local) state = JSON.parse(local);
            }
            
            checkDailyPenalty();
            render();
            
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
            }, 800);
        });
    }

    function save() {
        const data = JSON.stringify(state);
        localStorage.setItem('cyber_rpg_save', data);
        tg.CloudStorage.setItem('cyber_rpg_save', data);
        render();
    }

    // --- –õ–û–ì–ò–ö–ê ---
    function checkDailyPenalty() {
        const today = new Date().toDateString();
        if(state.lastLogin !== today) {
            const yesterday = (new Date().getDay() + 5) % 7;
            const missed = state.quests.filter(q => parseInt(q.day) === yesterday && !q.done);
            
            if(missed.length > 0) {
                let dmg = missed.length * 15;
                if(state.perks.includes('def')) dmg = Math.floor(dmg/2);
                state.hp = Math.max(0, state.hp - dmg);
                tg.showAlert(`SYSTEM_NOTICE: Yesterday you missed ${missed.length} tasks. HP reduced by ${dmg}.`);
            }
            state.lastLogin = today;
            save();
        }
    }

    // --- –†–ï–ù–î–ï–†–ò–ù–ì ---
    function render() {
        // –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∞—Ç—ã
        document.getElementById('gold-val').innerText = state.gold;
        document.getElementById('hp-val').innerText = state.hp;
        document.getElementById('hp-bar').style.width = state.hp + '%';

        // –£—Ä–æ–≤–µ–Ω—å –∏ –†–∞–Ω–≥
        let totalLvl = 0;
        for(let s in state.skills) totalLvl += state.skills[s].lvl;
        document.getElementById('total-lvl').innerText = 'LVL: ' + (totalLvl < 10 ? '0'+totalLvl : totalLvl);

        const aura = document.getElementById('aura');
        if(totalLvl > 15) aura.style.borderColor = 'var(--neon-pink)';
        if(totalLvl > 30) aura.style.borderColor = 'var(--neon-yellow)';

        // –í–∏–∑—É–∞–ª –≥–µ—Ä–æ—è
        document.getElementById('vis-head').innerText = state.equipped.head ? DB.gear[state.equipped.head].icon : '';
        document.getElementById('vis-weap').innerText = state.equipped.weapon ? DB.gear[state.equipped.weapon].icon : '';

        // –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á (—Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ)
        const today = (new Date().getDay() + 6) % 7;
        const dailyQuests = state.quests.filter(q => parseInt(q.day) === today);
        
        document.getElementById('quest-list').innerHTML = dailyQuests.map((q, i) => {
            const globalIdx = state.quests.indexOf(q);
            return `
                <div class="quest-box ${q.done ? 'done' : ''}">
                    <div>
                        <div style="font-size:9px; color:var(--neon-blue)">[${q.cat.toUpperCase()}] ${q.start || ''}</div>
                        <div style="font-weight:bold">${q.title}</div>
                    </div>
                    ${q.done ? 
                        `<button onclick="deleteQuest(${globalIdx})" style="background:none; border:none; color:var(--hp-red)">[DEL]</button>` : 
                        `<button onclick="completeQuest(event, ${globalIdx})" style="background:var(--neon-blue); border:none; color:#000; padding:5px 10px; font-weight:bold">OK</button>`
                    }
                </div>
            `;
        }).join('') || '<div style="text-align:center; opacity:0.3; padding:20px;">NO_ACTIVE_QUESTS</div>';

        // –ú–∞–≥–∞–∑–∏–Ω
        renderShop();
        
        // –ö–æ–ø–∏–ª–∫–∞
        renderPiggy();

        // –ü—Ä–æ—Ñ–∏–ª—å (–ù–∞–≤—ã–∫–∏)
        document.getElementById('skills-list').innerHTML = Object.keys(state.skills).map(k => `
            <div class="cyber-card">
                <div style="display:flex; justify-content:space-between; font-size:11px; margin-bottom:5px;">
                    <span>${k.toUpperCase()} [LVL ${state.skills[k].lvl}]</span>
                    <span>${state.skills[k].xp}%</span>
                </div>
                <div class="cyber-bar-container">
                    <div class="cyber-bar-fill" style="width:${state.skills[k].xp}%; background:var(--neon-blue)"></div>
                </div>
            </div>
        `).join('');
    }

    function renderShop() {
        const gearHTML = Object.keys(DB.gear).map(k => {
            const item = DB.gear[k];
            const owned = state.inventory.includes(k);
            const equipped = state.equipped[item.slot] === k;
            return `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <span>${item.icon} ${item.name}</span>
                    <button onclick="handleGear('${k}')" style="background:${owned ? (equipped ? 'var(--hp-red)' : 'var(--neon-blue)') : 'var(--neon-yellow)'}; border:none; padding:5px 10px; font-weight:bold; font-size:10px;">
                        ${owned ? (equipped ? 'REMOVE' : 'EQUIP') : item.price}
                    </button>
                </div>
            `;
        }).join('');
        document.getElementById('shop-gear-list').innerHTML = gearHTML;

        const perkHTML = Object.keys(DB.perks).map(k => {
            const p = DB.perks[k];
            const has = state.perks.includes(k);
            return `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div><div style="font-weight:bold; font-size:12px;">${p.name}</div><div style="font-size:9px; opacity:0.6">${p.desc}</div></div>
                    <button onclick="buyPerk('${k}')" ${has ? 'disabled' : ''} style="background:${has ? '#333' : 'var(--neon-pink)'}; border:none; color:#000; padding:5px 10px; font-weight:bold;">
                        ${has ? 'OWNED' : p.price}
                    </button>
                </div>
            `;
        }).join('');
        document.getElementById('shop-perks-list').innerHTML = perkHTML;
    }

    function renderPiggy() {
        const p = state.piggy;
        const box = document.getElementById('piggy-content');
        if(!p.active) {
            box.innerHTML = `<button class="btn-cyber" style="border-color:var(--neon-yellow); color:var(--neon-yellow)" onclick="startPiggy()">INIT_VAULT_GOAL</button>`;
        } else {
            const pct = Math.min(100, (p.current / p.goal) * 100);
            box.innerHTML = `
                <div style="font-weight:bold; margin-bottom:5px;">${p.title.toUpperCase()}</div>
                <div style="font-size:11px; margin-bottom:10px;">PROGRESS: ${p.current} / ${p.goal}</div>
                <div class="cyber-bar-container"><div class="cyber-bar-fill" style="width:${pct}%; background:var(--neon-yellow)"></div></div>
                <button class="btn-cyber" style="border-color:var(--neon-yellow); color:var(--neon-yellow)" onclick="depositPiggy()">+ DEPOSIT</button>
                <button onclick="resetPiggy()" style="background:none; border:none; color:#444; width:100%; margin-top:10px; font-size:10px;">TERMINATE_GOAL</button>
            `;
        }
    }

    // --- –î–ï–ô–°–¢–í–ò–Ø ---
    window.switchTab = (e, name) => {
        tg.HapticFeedback.impactOccurred('light');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('[id^="tab-"]').forEach(t => t.classList.add('hidden'));
        document.getElementById('tab-'+name).classList.remove('hidden');
    };

    window.openModal = () => {
        document.getElementById('modal-overlay').style.display = 'block';
    };

    window.closeModal = () => {
        document.getElementById('modal-overlay').style.display = 'none';
    };

    window.checkCustomCat = (val) => {
        document.getElementById('inp-custom').classList.toggle('hidden', val !== 'new_cat');
    };

    window.saveQuest = () => {
        const title = document.getElementById('inp-title').value;
        if(!title) return;
        let cat = document.getElementById('inp-cat').value;
        if(cat === 'new_cat') {
            cat = document.getElementById('inp-custom').value || 'misc';
            if(!state.skills[cat]) state.skills[cat] = {lvl:1, xp:0};
        }
        
        state.quests.push({
            title, cat,
            day: document.getElementById('inp-day').value,
            start: document.getElementById('inp-start').value,
            end: document.getElementById('inp-end').value,
            done: false
        });
        closeModal();
        save();
    };

    window.completeQuest = (e, idx) => {
        tg.HapticFeedback.notificationOccurred('success');
        const q = state.quests[idx];
        q.done = true;
        
        let reward = 50;
        if(state.perks.includes('gold_boost')) reward = 60;
        state.gold += reward;

        if(state.skills[q.cat]) {
            state.skills[q.cat].xp += 25;
            if(state.skills[q.cat].xp >= 100) {
                state.skills[q.cat].xp = 0;
                state.skills[q.cat].lvl++;
            }
        }
        save();
    };

    window.deleteQuest = (idx) => {
        if(confirm('DELETE_DATA_ENTRY?')) {
            state.quests.splice(idx, 1);
            save();
        }
    };

    window.handleGear = (key) => {
        const item = DB.gear[key];
        if(state.inventory.includes(key)) {
            state.equipped[item.slot] = state.equipped[item.slot] === key ? null : key;
        } else if(state.gold >= item.price) {
            state.gold -= item.price;
            state.inventory.push(key);
            state.equipped[item.slot] = key;
        }
        save();
    };

    window.buyPerk = (key) => {
        if(state.gold >= DB.perks[key].price) {
            state.gold -= DB.perks[key].price;
            state.perks.push(key);
            save();
        }
    };

    window.startPiggy = () => {
        const t = prompt('GOAL_ID:');
        const g = parseInt(prompt('CREDIT_LIMIT:'));
        if(t && g) {
            state.piggy = { active: true, title: t, goal: g, current: 0 };
            save();
        }
    };

    window.depositPiggy = () => {
        const v = parseInt(prompt('AMOUNT_TO_DEPOSIT:'));
        if(v > 0) {
            state.piggy.current += v;
            if(v >= 100) {
                state.skills.money.xp += 20;
                if(state.skills.money.xp >= 100) {
                    state.skills.money.xp = 0; state.skills.money.lvl++;
                }
            }
            save();
        }
    };

    window.resetPiggy = () => {
        if(confirm('ERASE_VAULT_DATA?')) {
            state.piggy.active = false;
            save();
        }
    };

    // STARTING POINT
    init();

</script>
</body>
</html>
